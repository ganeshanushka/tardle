<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="mobile.css">
<title>Verify Email Change - Tardle</title>
<style>
  /* Field Gothic Narrow Font Face */
  @font-face {
    font-family: 'Field Gothic Narrow';
    src: url('fonts/FieldGothicNarrow-Regular.woff2') format('woff2'),
         url('fonts/FieldGothicNarrow-Regular.woff') format('woff');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }
  
  @font-face {
    font-family: 'Field Gothic Narrow';
    src: url('fonts/FieldGothicNarrow-Bold.woff2') format('woff2'),
         url('fonts/FieldGothicNarrow-Bold.woff') format('woff');
    font-weight: bold;
    font-style: normal;
    font-display: swap;
  }

  /* Ensure headings use bold */
  h1, h2, h3, h4, h5, h6 {
    font-weight: bold;
  }
  
  /* Ensure body/content uses regular */
  body {
    font-weight: normal;
  }


  body {
    font-family: 'Field Gothic Narrow', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    background-color: #7BAFD4;
    padding: 20px;
  }

  .verify-container {
    background-color: white;
    margin: auto;
    padding: 40px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 500px;
    max-width: 90%;
    text-align: center;
    border-radius: 8px;
  }

  .tardle-logo {
    margin-bottom: 20px;
  }

  .logo-grid {
    display: inline-block;
    border: 4px solid black;
    border-radius: 5px;
    margin-bottom: 10px;
  }

  .logo-row {
    display: flex;
  }

  .logo-cell {
    width: 20px;
    height: 20px;
    border: 1px solid white;
    border-radius: 3px;
  }

  .carolina-blue { background-color: #7BAFD4; }
  .duke-blue { background-color: #001A57; }
  .yellow { background-color: #c9b458; }

  .tardle-title {
    font-size: 36px;
    font-weight: bold;
    margin-bottom: 10px;
    color: #1a1a1a;
  }

  h1 {
    font-size: 28px;
    margin-bottom: 10px;
    color: #1a1a1a;
  }

  .subtitle {
    font-size: 16px;
    color: #666;
    margin-bottom: 30px;
  }

  .email-display {
    font-weight: bold;
    color: #001A57;
    margin-bottom: 30px;
    font-size: 18px;
  }

  .instructions {
    margin-bottom: 30px;
    color: #333;
    line-height: 1.6;
    font-size: 16px;
  }

  .error-message {
    color: red;
    font-size: 0.9rem;
    margin-top: 0.25em;
    margin-bottom: 1em;
    display: none;
    font-family: 'Field Gothic Narrow', sans-serif;
  }

  .error-message.show {
    display: block;
  }

  .success-message {
    color: #2e7d32;
    font-size: 16px;
    margin-top: 20px;
    min-height: 20px;
    display: none;
    line-height: 1.6;
  }

  .success-message.show {
    display: block;
  }

  .loading {
    color: #666;
    font-size: 14px;
    margin-top: 10px;
  }

  .login-button {
    display: inline-block;
    margin-top: 20px;
    padding: 12px 24px;
    background-color: #001A57;
    color: white;
    text-decoration: none;
    border-radius: 5px;
    font-weight: bold;
    font-size: 16px;
  }

  .login-button:hover {
    background-color: #002a7a;
  }
</style>
</head>
<body>
<div class="verify-container">
  <div class="tardle-logo">
    <div class="logo-grid">
      <div class="logo-row">
        <div class="logo-cell carolina-blue"></div>
        <div class="logo-cell carolina-blue"></div>
        <div class="logo-cell carolina-blue"></div>
      </div>
      <div class="logo-row">
        <div class="logo-cell carolina-blue"></div>
        <div class="logo-cell yellow"></div>
        <div class="logo-cell duke-blue"></div>
      </div>
      <div class="logo-row">
        <div class="logo-cell duke-blue"></div>
        <div class="logo-cell duke-blue"></div>
        <div class="logo-cell duke-blue"></div>
      </div>
    </div>
    <div class="tardle-title">Tardle</div>
  </div>

  <h1>Verify Email Change</h1>
  <p class="subtitle">Verifying your new email address...</p>
  
  <div id="emailDisplay" class="email-display">Loading...</div>
  
  <div id="loadingMessage" class="loading">Please wait while we verify your email change...</div>
  
  <div id="errorMessage" class="error-message"></div>
  <div id="successMessage" class="success-message"></div>
</div>

<!-- Firebase Config -->
<script type="module" src="firebase-config.js"></script>

<script>
  // Wait for Firebase to load
  const checkFirebase = setInterval(() => {
    if (window.firebaseFirestoreFunctions && window.firebaseDb && window.firebaseFunctions && window.firebaseFunctionsFunctions) {
      clearInterval(checkFirebase);
      verifyEmailChange();
    }
  }, 100);

  async function verifyEmailChange() {
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const emailDisplay = document.getElementById('emailDisplay');
    
    try {
      // Get uid, code, and email from URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const uid = urlParams.get('uid');
      const code = urlParams.get('code');
      const email = urlParams.get('email');
      
      if (!code || !email) {
        throw new Error('Missing verification information in URL. Please use the link from your email.');
      }
      
      // If uid is missing, we need to find the user by verification code
      // This handles old verification links that don't have uid
      let userId = uid;
      if (!userId) {
        console.log('UID not in URL, searching for user by verification code via Cloud Function...');
        // Call Cloud Function to find user (server-side has permissions)
        try {
          const findUserByVerificationCode = window.firebaseFunctionsFunctions.httpsCallable(
            window.firebaseFunctions,
            'findUserByVerificationCode'
          );
          
          const findResult = await findUserByVerificationCode({
            code: code,
            email: email
          });
          
          if (findResult.data && findResult.data.uid) {
            userId = findResult.data.uid;
            console.log('Found user by verification code:', userId);
          } else {
            throw new Error('Could not find user with this verification code. Please request a new email change.');
          }
        } catch (searchError) {
          console.error('Error searching for user:', searchError);
          throw new Error('Invalid or expired verification link. Please request a new email change.');
        }
      }
      
      emailDisplay.textContent = email;
      
      console.log('Verifying email change:');
      console.log('  User ID:', userId);
      console.log('  Code:', code);
      console.log('  New email:', email);
      
      // Call Cloud Function to complete email change (no login required)
      const completeEmailChange = window.firebaseFunctionsFunctions.httpsCallable(
        window.firebaseFunctions,
        'completeEmailChange'
      );
      
      console.log('Calling completeEmailChange Cloud Function...');
      const result = await completeEmailChange({
        uid: userId,
        code: code,
        newEmail: email
      });
      
      console.log('âœ“ Email change completed successfully');
      console.log('Result:', result.data);
      
      // Show success message
      loadingMessage.style.display = 'none';
      successMessage.innerHTML = `
        <strong>Verification complete!</strong><br><br>
        Your email address change has been completed.<br><br>
        Please log in again with your new email address and existing password.
      `;
      successMessage.classList.add('show');
      
      // Add login button
      const loginButton = document.createElement('a');
      loginButton.href = 'login.html';
      loginButton.className = 'login-button';
      loginButton.textContent = 'Go to Login';
      successMessage.appendChild(document.createElement('br'));
      successMessage.appendChild(loginButton);
      
    } catch (error) {
      console.error('Error verifying email change:', error);
      loadingMessage.style.display = 'none';
      
      let errorMsg = 'An error occurred while verifying your email change.';
      if (error.code === 'functions/not-found') {
        errorMsg = 'Verification code not found or has expired. Please request a new email change.';
      } else if (error.code === 'functions/invalid-argument') {
        errorMsg = 'Invalid verification code. Please use the link from your email.';
      } else if (error.code === 'functions/deadline-exceeded') {
        errorMsg = 'Verification code has expired. Please request a new email change.';
      } else if (error.message) {
        errorMsg = error.message;
      }
      
      errorMessage.textContent = errorMsg;
      errorMessage.classList.add('show');
    }
  }
</script>

</body>
</html>
