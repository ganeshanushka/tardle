<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Details</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'PT Serif', 'Clear Sans', 'Helvetica Neue', Arial, sans-serif;
      background: #f7f7f7;
      color: #1a1a1b;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .page-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* Left Sidebar */
    .sidebar {
      width: 240px;
      background: white;
      border-right: 1px solid #e5e5e5;
      padding: 32px 24px;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
    }
    
    .sidebar-nav {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-nav-item {
      margin-bottom: 8px;
    }
    
    .sidebar-nav-link {
      display: block;
      padding: 12px 16px;
      color: #1a1a1b;
      text-decoration: none;
      font-size: 15px;
      position: relative;
      border-radius: 4px;
    }
    
    .sidebar-nav-link.active {
      font-weight: bold;
      background: #f7f7f7;
    }
    
    .sidebar-nav-link.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
      background: #7BAFD4;
    }
    
    .sidebar-divider {
      height: 1px;
      background: #e5e5e5;
      margin: 24px 0;
    }
    
    .sidebar-help {
      padding: 12px 16px;
      color: #1a1a1b;
      text-decoration: none;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sidebar-help:hover {
      text-decoration: underline;
    }
    
    /* Main Content */
    .main-content {
      margin-left: 240px;
      flex: 1;
      padding: 32px 48px;
      max-width: 800px;
    }
    
    .greeting {
      margin-bottom: 8px;
    }
    
    .greeting h1 {
      font-size: 32px;
      font-weight: bold;
      margin: 0 0 8px 0;
      color: #1a1a1b;
    }
    
    .tagline {
      font-size: 15px;
      color: #666;
      margin-bottom: 40px;
    }
    
    .section {
      margin-bottom: 48px;
    }
    
    .section-title {
      font-size: 13px;
      font-weight: bold;
      color: #1a1a1b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #e5e5e5;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 16px 0;
      border-bottom: 1px solid #e5e5e5;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-size: 15px;
      color: #1a1a1b;
      font-weight: 500;
      min-width: 180px;
    }
    
    .info-value-container {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .info-value {
      font-size: 15px;
      color: #1a1a1b;
      font-family: monospace;
    }
    
    .info-value.loading {
      color: #999;
      font-style: italic;
    }
    
    .info-value.account-number {
      font-family: monospace;
      font-weight: 600;
    }
    
    .info-action {
      font-size: 15px;
      color: #7BAFD4;
      text-decoration: underline;
      cursor: pointer;
      margin-left: 16px;
    }
    
    .info-action:hover {
      color: #5a9bc4;
    }
    
    .error-message {
      color: #d32f2f;
      margin-top: 16px;
      font-size: 14px;
    }
    
    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
      }
      
      .main-content {
        margin-left: 200px;
        padding: 24px;
      }
      
      .info-item {
        flex-direction: column;
      }
      
      .info-label {
        margin-bottom: 8px;
        min-width: auto;
      }
      
      .info-value-container {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item">
            <a href="#" class="sidebar-nav-link active">Account</a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-divider"></div>
      <a href="#" class="sidebar-help">
        <span>?</span>
        <span>Help</span>
      </a>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="greeting">
        <h1 id="greetingText">Good evening, <span id="userName">Loading...</span>.</h1>
        <p class="tagline" id="taglineText">You've been playing Tardle since <span id="memberSince">January 1, 2025</span>.</p>
      </div>

      <!-- Account Information Section -->
      <div class="section">
        <h2 class="section-title">Account information</h2>
        <div id="accountInfo">
          <div class="info-item">
            <div class="info-label">Account number</div>
            <div class="info-value-container">
              <div class="info-value account-number loading" id="accountNumber">Loading...</div>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Email address</div>
            <div class="info-value-container">
              <div class="info-value loading" id="userEmail">Loading...</div>
              <a href="#" class="info-action" id="updateEmailLink">Update</a>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Username</div>
            <div class="info-value-container">
              <div class="info-value loading" id="usernameDisplay">Loading...</div>
              <a href="#" class="info-action" id="updateUsernameLink">Update</a>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Password</div>
            <div class="info-value-container">
              <div class="info-value loading" id="passwordStatus">Loading...</div>
              <a href="#" class="info-action" id="updatePasswordLink">Update</a>
            </div>
          </div>
        </div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
      </div>

      <!-- Your Profile Section -->
      <div class="section">
        <h2 class="section-title">Your profile</h2>
        <div id="profileInfo">
          <div class="info-item">
            <div class="info-label">Name</div>
            <div class="info-value-container">
              <div class="info-value loading" id="displayName">Loading...</div>
              <a href="#" class="info-action" id="updateNameLink">Update</a>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Firebase Config -->
  <script type="module" src="firebase-config.js"></script>

  <script>
    // Get time-based greeting
    function getGreeting() {
      const hour = new Date().getHours();
      if (hour < 12) return 'Good morning';
      if (hour < 17) return 'Good afternoon';
      return 'Good evening';
    }

    // Update greeting text
    function updateGreeting(username) {
      const greetingEl = document.getElementById('greetingText');
      if (!greetingEl) {
        console.error('Greeting element not found!');
        return;
      }
      const greeting = getGreeting();
      console.log('Updating greeting with username:', username);
      greetingEl.innerHTML = `${greeting}, <span id="userName">${username}</span>.`;
    }

    async function loadAccountDetails() {
      try {
        // Wait for Firebase to be loaded
        await new Promise((resolve) => {
          if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions) {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
          }
        });

        // Check if user is logged in - wait for auth state to be restored
        let currentUser = window.firebaseAuth.currentUser;
        
        // If currentUser is not immediately available, wait for auth state to be restored
        if (!currentUser) {
          console.log('Waiting for Firebase Auth session to restore...');
          await new Promise((resolve) => {
            let resolved = false;
            const timeout = setTimeout(() => {
              if (!resolved) {
                console.warn('Auth state check timeout after 3s');
                resolved = true;
                resolve();
              }
            }, 3000); // 3 second max wait
            
            // Set up auth state listener
            const unsubscribe = window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, (authUser) => {
              console.log('onAuthStateChanged fired, user:', authUser ? authUser.uid : 'null');
              if (authUser && !resolved) {
                currentUser = authUser;
                resolved = true;
                clearTimeout(timeout);
                unsubscribe();
                resolve();
              } else if (!authUser && !resolved) {
                // Check if we've waited long enough (at least 1 second)
                setTimeout(() => {
                  if (!resolved && !window.firebaseAuth.currentUser) {
                    resolved = true;
                    clearTimeout(timeout);
                    unsubscribe();
                    resolve();
                  }
                }, 1000);
              }
            });
            
            // Also check currentUser immediately in case it's already set
            const immediateUser = window.firebaseAuth.currentUser;
            if (immediateUser && !resolved) {
              currentUser = immediateUser;
              resolved = true;
              clearTimeout(timeout);
              unsubscribe();
              resolve();
            }
          });
        }
        
        // Final check - if still no user, redirect to login
        if (!currentUser) {
          console.log('No user found after waiting, redirecting to login...');
          window.location.href = 'login.html';
          return;
        }

        console.log('Current user found:', currentUser.uid, currentUser.email);
        
        // Update greeting immediately with email-based username as fallback
        const fallbackUsername = currentUser.email?.split('@')[0] || 'User';
        updateGreeting(fallbackUsername);

        // Load user data from Firestore
        console.log('Loading user data for UID:', currentUser.uid);
        let userDoc;
        try {
          const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', currentUser.uid);
          userDoc = await window.firebaseFirestoreFunctions.getDoc(userDocRef);
          console.log('User document exists:', userDoc.exists());
        } catch (firestoreError) {
          console.error('Firestore error:', firestoreError);
          // Check if it's an offline error
          if (firestoreError.message && firestoreError.message.includes('offline')) {
            // Show user-friendly offline message
            const errorMessageEl = document.getElementById('errorMessage');
            if (errorMessageEl) {
              errorMessageEl.textContent = 'Unable to load account details. Please check your internet connection and try again.';
              errorMessageEl.style.display = 'block';
            }
            // Still try to show what we can from Firebase Auth
            const username = currentUser.email?.split('@')[0] || 'User';
            updateGreeting(username);
            
            const emailEl = document.getElementById('userEmail');
            if (emailEl) {
              emailEl.textContent = currentUser.email || 'Not available';
              emailEl.classList.remove('loading');
            }
            
            // Show basic info from Auth
            const accountNumberEl = document.getElementById('accountNumber');
            if (accountNumberEl) {
              accountNumberEl.textContent = 'Unable to load';
              accountNumberEl.classList.remove('loading');
              accountNumberEl.style.color = '#999';
            }
            
            const usernameDisplayEl = document.getElementById('usernameDisplay');
            if (usernameDisplayEl) {
              usernameDisplayEl.textContent = username;
              usernameDisplayEl.classList.remove('loading');
            }
            
            const passwordEl = document.getElementById('passwordStatus');
            if (passwordEl) {
              if (currentUser.providerData && currentUser.providerData.length > 0) {
                const hasPasswordProvider = currentUser.providerData.some(provider => provider.providerId === 'password');
                passwordEl.textContent = hasPasswordProvider ? '••••••••' : 'None';
                if (!hasPasswordProvider) passwordEl.style.color = '#999';
              } else {
                passwordEl.textContent = 'None';
                passwordEl.style.color = '#999';
              }
              passwordEl.classList.remove('loading');
            }
            
            return; // Exit early since we can't load Firestore data
          } else {
            // Re-throw other errors to be handled by outer catch
            throw firestoreError;
          }
        }

        if (userDoc.exists()) {
          const userData = userDoc.data();
          console.log('User data loaded:', userData);
          
          // Get username for greeting
          const username = userData.username || currentUser.email?.split('@')[0] || 'User';
          updateGreeting(username);
          
          // Get member since date from createdAt or Firebase Auth metadata
          let memberSince = null;
          let createdAtDate = null;
          
          console.log('Checking for createdAt in userData:', userData.createdAt);
          console.log('Checking currentUser.metadata:', currentUser.metadata);
          
          // Try to get date from Firestore createdAt field
          if (userData.createdAt) {
            try {
              // Handle Firestore Timestamp
              if (userData.createdAt.toDate) {
                createdAtDate = userData.createdAt.toDate();
                console.log('Found Firestore Timestamp, converted to:', createdAtDate);
              } else if (userData.createdAt.seconds) {
                // Handle timestamp with seconds
                createdAtDate = new Date(userData.createdAt.seconds * 1000);
                console.log('Found timestamp with seconds, converted to:', createdAtDate);
              } else if (userData.createdAt._seconds) {
                // Handle timestamp with _seconds (older format)
                createdAtDate = new Date(userData.createdAt._seconds * 1000);
                console.log('Found timestamp with _seconds, converted to:', createdAtDate);
              } else {
                // Try to parse as regular date
                createdAtDate = new Date(userData.createdAt);
                console.log('Parsed as regular date:', createdAtDate);
              }
            } catch (dateError) {
              console.error('Error parsing Firestore createdAt:', dateError, userData.createdAt);
            }
          } else {
            console.log('No createdAt field in Firestore userData');
          }
          
          // Fallback to Firebase Auth metadata if Firestore date is not available
          if (!createdAtDate && currentUser.metadata && currentUser.metadata.creationTime) {
            try {
              createdAtDate = new Date(currentUser.metadata.creationTime);
              console.log('Using Firebase Auth creationTime:', createdAtDate);
            } catch (dateError) {
              console.error('Error parsing Auth metadata creationTime:', dateError);
            }
          } else if (!createdAtDate) {
            console.log('No creationTime in Firebase Auth metadata');
          }
          
          // Format the date
          if (createdAtDate && !isNaN(createdAtDate.getTime())) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            memberSince = createdAtDate.toLocaleDateString('en-US', options);
            console.log('Formatted member since date:', memberSince);
          } else {
            console.warn('Could not determine account creation date - createdAt missing or invalid');
            // Check if createdAt field is missing in Firestore
            if (!userData.createdAt) {
              memberSince = 'createdAt field is missing';
            } else {
              memberSince = 'Unknown';
            }
          }
          
          const memberSinceEl = document.getElementById('memberSince');
          if (memberSinceEl && memberSince) {
            memberSinceEl.textContent = memberSince;
          }
          
          // Display account number
          const accountNumberEl = document.getElementById('accountNumber');
          if (accountNumberEl) {
            if (userData.accountNumber) {
              accountNumberEl.textContent = userData.accountNumber;
              accountNumberEl.classList.remove('loading');
            } else {
              accountNumberEl.textContent = 'Not assigned';
              accountNumberEl.classList.remove('loading');
              accountNumberEl.style.color = '#999';
            }
          }

          // Display email
          const emailEl = document.getElementById('userEmail');
          if (emailEl) {
            emailEl.textContent = userData.email || currentUser.email || 'Not available';
            emailEl.classList.remove('loading');
          }

          // Display username
          const usernameDisplayEl = document.getElementById('usernameDisplay');
          if (usernameDisplayEl) {
            usernameDisplayEl.textContent = userData.username || currentUser.email?.split('@')[0] || 'Not set';
            usernameDisplayEl.classList.remove('loading');
          }

          // Display password status - check if user has email/password provider
          const passwordEl = document.getElementById('passwordStatus');
          if (passwordEl) {
            if (currentUser.providerData && currentUser.providerData.length > 0) {
              const hasPasswordProvider = currentUser.providerData.some(provider => provider.providerId === 'password');
              if (hasPasswordProvider) {
                passwordEl.textContent = '••••••••';
              } else {
                passwordEl.textContent = 'None';
                passwordEl.style.color = '#999';
              }
            } else {
              passwordEl.textContent = 'None';
              passwordEl.style.color = '#999';
            }
            passwordEl.classList.remove('loading');
          }

          // Display name (username)
          const nameEl = document.getElementById('displayName');
          if (nameEl) {
            nameEl.textContent = userData.username || currentUser.email?.split('@')[0] || 'Not set';
            nameEl.classList.remove('loading');
          }
        } else {
          // User document doesn't exist
          document.getElementById('errorMessage').textContent = 'Account information not found.';
          document.getElementById('errorMessage').style.display = 'block';
          
          // Show what we can from auth
          const username = currentUser.email?.split('@')[0] || 'User';
          updateGreeting(username);
          
          const emailEl = document.getElementById('userEmail');
          emailEl.textContent = currentUser.email || 'Not available';
          emailEl.classList.remove('loading');
          
          const accountNumberEl = document.getElementById('accountNumber');
          accountNumberEl.textContent = 'Not assigned';
          accountNumberEl.classList.remove('loading');
          accountNumberEl.style.color = '#999';
          
          // Display username
          const usernameDisplayEl = document.getElementById('usernameDisplay');
          if (usernameDisplayEl) {
            usernameDisplayEl.textContent = username;
            usernameDisplayEl.classList.remove('loading');
          }

          // Display password status - check if user has email/password provider
          const passwordEl = document.getElementById('passwordStatus');
          if (passwordEl) {
            if (currentUser.providerData && currentUser.providerData.length > 0) {
              const hasPasswordProvider = currentUser.providerData.some(provider => provider.providerId === 'password');
              if (hasPasswordProvider) {
                passwordEl.textContent = '••••••••';
              } else {
                passwordEl.textContent = 'None';
                passwordEl.style.color = '#999';
              }
            } else {
              passwordEl.textContent = 'None';
              passwordEl.style.color = '#999';
            }
            passwordEl.classList.remove('loading');
          }
          
          const nameEl = document.getElementById('displayName');
          nameEl.textContent = username;
          nameEl.classList.remove('loading');
        }
      } catch (error) {
        console.error('Error loading account details:', error);
        console.error('Error stack:', error.stack);
        const errorMessageEl = document.getElementById('errorMessage');
        if (errorMessageEl) {
          // Provide more user-friendly error messages
          let errorMsg = 'Error loading account details. Please try again.';
          if (error.message && error.message.includes('offline')) {
            errorMsg = 'Unable to load account details. Please check your internet connection and try again.';
          } else if (error.message) {
            errorMsg = 'Error loading account details: ' + error.message;
          }
          errorMessageEl.textContent = errorMsg;
          errorMessageEl.style.display = 'block';
        }
      }
    }

    // Placeholder handlers for update links
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('updateEmailLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        alert('Email update functionality coming soon!');
      });
      
      document.getElementById('updateUsernameLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        alert('Username update functionality coming soon!');
      });
      
      document.getElementById('updatePasswordLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        alert('Password update functionality coming soon!');
      });
      
      document.getElementById('updateNameLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        alert('Name update functionality coming soon!');
      });
    });

    // Load account details when page loads
    // Use both DOMContentLoaded and window.onload to ensure page is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAccountDetails);
    } else {
      // DOM already loaded, call immediately
      loadAccountDetails();
    }
  </script>
</body>
</html>
