<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Details</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      font-family: 'PT Serif', 'Clear Sans', 'Helvetica Neue', Arial, sans-serif;
      background: #f7f7f7;
      color: #1a1a1b;
      line-height: 1.6;
      min-height: 100vh;
    }
    
    .page-container {
      display: flex;
      min-height: 100vh;
    }
    
    /* Left Sidebar */
    .sidebar {
      width: 240px;
      background: white;
      border-right: 2px solid #7BAFD4;
      padding: 32px 24px;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      box-shadow: 2px 0 8px rgba(123, 175, 212, 0.1);
    }
    
    .sidebar-nav {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .sidebar-nav-item {
      margin-bottom: 8px;
    }
    
    .sidebar-nav-link {
      display: block;
      padding: 12px 16px;
      color: #1a1a1b;
      text-decoration: none;
      font-size: 15px;
      position: relative;
      border-radius: 4px;
    }
    
    .sidebar-nav-link {
      transition: all 0.2s ease;
    }
    
    .sidebar-nav-link:hover {
      background: #f0f8ff;
      color: #7BAFD4;
    }
    
    .sidebar-nav-link.active {
      font-weight: bold;
      background: rgba(123, 175, 212, 0.1);
      color: #7BAFD4;
    }
    
    .sidebar-nav-link.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #7BAFD4;
      border-radius: 0 2px 2px 0;
    }
    
    .sidebar-divider {
      height: 1px;
      background: #e5e5e5;
      margin: 24px 0;
    }
    
    .sidebar-help {
      padding: 12px 16px;
      color: #1a1a1b;
      text-decoration: none;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sidebar-help:hover {
      text-decoration: underline;
    }
    
    /* Main Content */
    .main-content {
      margin-left: 240px;
      flex: 1;
      padding: 32px 48px;
      max-width: 800px;
    }
    
    .greeting {
      margin-bottom: 8px;
    }
    
    .greeting h1 {
      font-size: 36px;
      font-weight: bold;
      margin: 0 0 8px 0;
      color: #7BAFD4;
    }
    
    .tagline {
      font-size: 15px;
      color: #666;
      margin-bottom: 40px;
      font-style: italic;
    }
    
    .section {
      margin-bottom: 48px;
      background: white;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e5e5;
      transition: box-shadow 0.3s ease, transform 0.2s ease;
    }
    
    .section:hover {
      box-shadow: 0 4px 16px rgba(123, 175, 212, 0.15);
      transform: translateY(-2px);
    }
    
    .section-title {
      font-size: 24px;
      font-weight: bold;
      color: #1a1a1b;
      margin-bottom: 20px;
      padding-bottom: 12px;
      border-bottom: 3px solid #7BAFD4;
      position: relative;
    }
    
    .section-title::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      width: 60px;
      height: 3px;
      background: #7BAFD4;
    }
    
    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 20px 0;
      border-bottom: 1px solid #e5e5e5;
      transition: background-color 0.2s ease;
      border-radius: 6px;
      margin: 0 -12px;
      padding-left: 12px;
      padding-right: 12px;
    }
    
    .info-item:hover {
      background-color: #f8fbff;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      font-size: 15px;
      color: #1a1a1b;
      font-weight: 500;
      min-width: 180px;
    }
    
    .info-value-container {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .info-value {
      font-size: 15px;
      color: #1a1a1b;
      font-family: monospace;
    }
    
    .info-value.loading {
      color: #999;
      font-style: italic;
    }
    
    .info-value.account-number {
      font-family: monospace;
      font-weight: 600;
    }
    
    .info-action {
      font-size: 14px;
      color: white;
      text-decoration: none;
      cursor: pointer;
      margin-left: 16px;
      font-weight: 600;
      padding: 6px 12px;
      border-radius: 6px;
      background: #7BAFD4;
      border: 1px solid #7BAFD4;
      transition: all 0.2s ease;
    }
    
    .info-action:hover {
      color: white;
      background: #5a9bc4;
      border-color: #5a9bc4;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(123, 175, 212, 0.3);
    }
    
    .error-message {
      color: red;
      font-size: 0.9rem;
      margin-top: 0.25em;
      margin-bottom: 1em;
      font-family: 'PT Serif', serif;
    }
    
    /* Account Actions Styling */
    .account-actions-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-top: 8px;
    }
    
    .account-action-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      text-decoration: none;
      color: #1a1a1b;
      border-bottom: 1px solid #e5e5e5;
      transition: background-color 0.2s ease;
      cursor: pointer;
    }
    
    .account-action-item:last-child {
      border-bottom: none;
    }
    
    .account-action-item:hover {
      background-color: #f8fbff;
    }
    
    .account-action-content {
      flex: 1;
    }
    
    .account-action-title {
      font-size: 16px;
      font-weight: bold;
      color: #1a1a1b;
      margin-bottom: 4px;
    }
    
    .account-action-description {
      font-size: 14px;
      color: #666;
      line-height: 1.4;
    }
    
    .account-action-chevron {
      font-size: 18px;
      color: #666;
      margin-left: 16px;
      font-weight: bold;
    }
    
    /* Subscription Section */
    .subscription-section {
      margin: 48px 0;
      padding: 0;
    }
    
    .subscription-divider {
      height: 1px;
      background: #000;
      border: none;
      margin: 0;
    }
    
    .subscription-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 0;
      gap: 24px;
    }
    
    .subscription-text {
      flex: 1;
    }
    
    .subscription-title {
      font-size: 24px;
      font-weight: bold;
      color: #000;
      margin: 0 0 8px 0;
    }
    
    .subscription-description {
      font-size: 15px;
      color: #000;
      margin: 0 0 4px 0;
    }
    
    .subscription-subdescription {
      font-size: 14px;
      color: #666;
      margin: 0;
    }
    
    .subscription-button {
      background: white;
      border: 1px solid #000;
      color: #000;
      padding: 10px 20px;
      font-size: 15px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      white-space: nowrap;
      transition: background-color 0.2s, color 0.2s;
    }
    
    .subscription-button:hover {
      background: #000;
      color: white;
    }

    @media (max-width: 768px) {
      .sidebar {
        width: 200px;
      }
      
      .main-content {
        margin-left: 200px;
        padding: 24px;
      }
      
      .info-item {
        flex-direction: column;
      }
      
      .info-label {
        margin-bottom: 8px;
        min-width: auto;
      }
      
      .info-value-container {
        width: 100%;
      }
      
      .subscription-content {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .subscription-button {
        margin-top: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="page-container">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <nav>
        <ul class="sidebar-nav">
          <li class="sidebar-nav-item">
            <a href="#" class="sidebar-nav-link active">Account</a>
          </li>
        </ul>
      </nav>
      <div class="sidebar-divider"></div>
      <a href="#" class="sidebar-help">
        <span>?</span>
        <span>Help</span>
      </a>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="greeting">
        <h1 id="greetingText">Good evening, <span id="userName">Loading...</span>.</h1>
        <p class="tagline" id="taglineText">You've been playing Tardle since <span id="memberSince">January 1, 2025</span>.</p>
      </div>

      <!-- Account Information Section -->
      <div class="section">
        <h2 class="section-title">Account information</h2>
        <div id="accountInfo">
          <div class="info-item">
            <div class="info-label">Account number</div>
            <div class="info-value-container">
              <div class="info-value account-number loading" id="accountNumber">Loading...</div>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Username</div>
            <div class="info-value-container">
              <div class="info-value loading" id="usernameDisplay">Loading...</div>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Email address</div>
            <div class="info-value-container">
              <div class="info-value loading" id="userEmail">Loading...</div>
              <a href="#" class="info-action" id="updateEmailLink">Update</a>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Password</div>
            <div class="info-value-container">
              <div class="info-value loading" id="passwordStatus">Loading...</div>
              <a href="#" class="info-action" id="updatePasswordLink">Update</a>
            </div>
          </div>
          <div class="info-item">
            <div class="info-label">Email verification</div>
            <div class="info-value-container">
              <div class="info-value loading" id="emailVerificationStatus">Loading...</div>
              <a href="#" class="info-action" id="verifyEmailLink" style="display: none;">Verify</a>
            </div>
          </div>
        </div>
        <div id="errorMessage" class="error-message" style="display: none;"></div>
      </div>

      <!-- Account Actions Section -->
      <div class="section" id="accountActionsSection">
        <h2 class="section-title">Account Actions</h2>
        <div class="account-actions-list">
          <a href="reminder.html" class="account-action-item">
            <div class="account-action-content">
              <div class="account-action-title">Reminder Email</div>
              <div class="account-action-description">Sign up to receive daily reminder emails for new puzzles.</div>
            </div>
            <div class="account-action-chevron">></div>
          </a>
          <a href="#" class="account-action-item" onclick="handleDeleteAccountClick(event); return false;">
            <div class="account-action-content">
              <div class="account-action-title">Delete your account</div>
              <div class="account-action-description">You will lose access to all history associated with this account.</div>
            </div>
            <div class="account-action-chevron">></div>
          </a>
        </div>
      </div>

    </main>
  </div>

  <!-- Firebase Config -->
  <script type="module" src="firebase-config.js"></script>

  <script>
    // Get time-based greeting
    function getGreeting() {
      const hour = new Date().getHours();
      if (hour < 12) return 'Good morning';
      if (hour < 17) return 'Good afternoon';
      return 'Good evening';
    }

    // Update greeting text
    function updateGreeting(username) {
      const greetingEl = document.getElementById('greetingText');
      if (!greetingEl) {
        console.error('Greeting element not found!');
        return;
      }
      const greeting = getGreeting();
      console.log('Updating greeting with username:', username);
      greetingEl.innerHTML = `${greeting}, <span id="userName">${username}</span>.`;
    }

    async function loadAccountDetails() {
      try {
        // Wait for Firebase to be loaded
        await new Promise((resolve) => {
          if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions) {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
          }
        });

        // Check if user is logged in - wait for auth state to be restored
        let currentUser = window.firebaseAuth.currentUser;
        
        // If currentUser is not immediately available, wait for auth state to be restored
        if (!currentUser) {
          console.log('Waiting for Firebase Auth session to restore...');
          await new Promise((resolve) => {
            let resolved = false;
            const timeout = setTimeout(() => {
              if (!resolved) {
                console.warn('Auth state check timeout after 3s');
                resolved = true;
                resolve();
              }
            }, 3000); // 3 second max wait
            
            // Set up auth state listener
            const unsubscribe = window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, (authUser) => {
              console.log('onAuthStateChanged fired, user:', authUser ? authUser.uid : 'null');
              if (authUser && !resolved) {
                currentUser = authUser;
                resolved = true;
                clearTimeout(timeout);
                unsubscribe();
                resolve();
              } else if (!authUser && !resolved) {
                // Check if we've waited long enough (at least 1 second)
                setTimeout(() => {
                  if (!resolved && !window.firebaseAuth.currentUser) {
                    resolved = true;
                    clearTimeout(timeout);
                    unsubscribe();
                    resolve();
                  }
                }, 1000);
              }
            });
            
            // Also check currentUser immediately in case it's already set
            const immediateUser = window.firebaseAuth.currentUser;
            if (immediateUser && !resolved) {
              currentUser = immediateUser;
              resolved = true;
              clearTimeout(timeout);
              unsubscribe();
              resolve();
            }
          });
        }
        
        // Final check - if still no user, redirect to login
        if (!currentUser) {
          console.log('No user found after waiting, redirecting to login...');
          window.location.href = 'login.html';
          return;
        }

        // Check if email is verified - redirect if not
        await currentUser.reload(); // Refresh user data to get latest verification status
        if (!currentUser.emailVerified) {
          console.log('User email not verified, redirecting to verification page');
          window.location.href = 'verify-email.html';
          return;
        }

        console.log('Current user found:', currentUser.uid, currentUser.email);
        
        // Update greeting immediately with email-based username as fallback
        const fallbackUsername = currentUser.email?.split('@')[0] || 'User';
        updateGreeting(fallbackUsername);

        // Check if Firestore is available
        if (!window.firebaseDb) {
          console.error('Firestore database not initialized');
          throw new Error('Firestore database not available');
        }
        
        // Load user data from Firestore with retry logic
        console.log('Loading user data for UID:', currentUser.uid);
        console.log('Firestore database:', window.firebaseDb);
        let userDoc;
        let retryCount = 0;
        const maxRetries = 3;
        
        while (retryCount < maxRetries) {
          try {
            const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', currentUser.uid);
            console.log(`Attempting to fetch document from Firestore (attempt ${retryCount + 1}/${maxRetries})...`);
            
            // Fetch document - no timeout for now to allow Firestore to initialize
            userDoc = await window.firebaseFirestoreFunctions.getDoc(userDocRef);
            console.log('User document fetched successfully, exists:', userDoc.exists());
            break; // Success, exit retry loop
          } catch (firestoreError) {
            retryCount++;
            console.error(`Firestore error (attempt ${retryCount}/${maxRetries}):`, firestoreError);
            console.error('Error code:', firestoreError.code);
            console.error('Error message:', firestoreError.message);
            
            if (retryCount >= maxRetries) {
              // Final attempt failed, handle error
              console.error('All retry attempts failed. Error details:', firestoreError);
              
              // Check if it's an offline error or network-related
              const isOfflineError = firestoreError.message && (
                firestoreError.message.includes('offline') ||
                firestoreError.message.includes('Failed to get document') ||
                firestoreError.code === 'unavailable' ||
                firestoreError.code === 'deadline-exceeded' ||
                firestoreError.message.includes('timeout')
              );
              
              if (isOfflineError) {
                // Show user-friendly offline message
                const errorMessageEl = document.getElementById('errorMessage');
                if (errorMessageEl) {
                  errorMessageEl.textContent = 'Unable to load account details. Please check your internet connection and try again.';
                  errorMessageEl.style.display = 'block';
                }
                // Still try to show what we can from Firebase Auth
                const username = currentUser.email?.split('@')[0] || 'User';
                updateGreeting(username);
                
                const emailEl = document.getElementById('userEmail');
                if (emailEl) {
                  emailEl.textContent = currentUser.email || 'Not available';
                  emailEl.classList.remove('loading');
                }
                
                // Display email verification status
                const verificationStatusEl = document.getElementById('emailVerificationStatus');
                const verifyEmailLink = document.getElementById('verifyEmailLink');
                if (verificationStatusEl) {
                  await currentUser.reload(); // Get latest verification status
                  if (currentUser.emailVerified) {
                    verificationStatusEl.textContent = '✓ Verified';
                    verificationStatusEl.style.color = '#2e7d32';
                    if (verifyEmailLink) {
                      verifyEmailLink.style.display = 'none';
                    }
                  } else {
                    verificationStatusEl.textContent = '✗ Not verified';
                    verificationStatusEl.style.color = '#d32f2f';
                    if (verifyEmailLink) {
                      verifyEmailLink.style.display = 'inline';
                    }
                  }
                  verificationStatusEl.classList.remove('loading');
                }
                
                // Show basic info from Auth
                const accountNumberEl = document.getElementById('accountNumber');
                if (accountNumberEl) {
                  accountNumberEl.textContent = 'Unable to load';
                  accountNumberEl.classList.remove('loading');
                  accountNumberEl.style.color = '#999';
                }
                
                const usernameDisplayEl = document.getElementById('usernameDisplay');
                if (usernameDisplayEl) {
                  usernameDisplayEl.textContent = username;
                  usernameDisplayEl.classList.remove('loading');
                }
                
                const passwordEl = document.getElementById('passwordStatus');
                if (passwordEl) {
                  if (currentUser.providerData && currentUser.providerData.length > 0) {
                    const hasPasswordProvider = currentUser.providerData.some(provider => provider.providerId === 'password');
                    passwordEl.textContent = hasPasswordProvider ? '••••••••' : 'None';
                    if (!hasPasswordProvider) passwordEl.style.color = '#999';
                  } else {
                    passwordEl.textContent = 'None';
                    passwordEl.style.color = '#999';
                  }
                  passwordEl.classList.remove('loading');
                }
                
                return; // Exit early since we can't load Firestore data
              } else {
                // Re-throw other errors to be handled by outer catch
                throw firestoreError;
              }
            }
            
            // Wait before retrying (exponential backoff)
            const waitTime = Math.min(1000 * Math.pow(2, retryCount - 1), 5000);
            console.log(`Retrying in ${waitTime}ms...`);
            await new Promise(resolve => setTimeout(resolve, waitTime));
          }
        }
        
        // If we get here, we need to check if userDoc was set
        if (!userDoc) {
          throw new Error('Failed to fetch user document after retries');
        }
        
        // Process the document
        if (userDoc.exists()) {
          const userData = userDoc.data();
          console.log('User data loaded:', userData);
          console.log('Account number in userData:', userData.accountNumber);
          console.log('Username in userData:', userData.username);
          console.log('Email prefix (fallback):', currentUser.email?.split('@')[0]);
          
          // Get username for greeting
          const username = userData.username || currentUser.email?.split('@')[0] || 'User';
          console.log('Using username for greeting:', username);
          updateGreeting(username);
          
          // Get member since date from createdAt or Firebase Auth metadata
          let memberSince = null;
          let createdAtDate = null;
          
          console.log('Checking for createdAt in userData:', userData.createdAt);
          console.log('Checking currentUser.metadata:', currentUser.metadata);
          
          // Try to get date from Firestore createdAt field
          if (userData.createdAt) {
            try {
              // Handle Firestore Timestamp
              if (userData.createdAt.toDate) {
                createdAtDate = userData.createdAt.toDate();
                console.log('Found Firestore Timestamp, converted to:', createdAtDate);
              } else if (userData.createdAt.seconds) {
                // Handle timestamp with seconds
                createdAtDate = new Date(userData.createdAt.seconds * 1000);
                console.log('Found timestamp with seconds, converted to:', createdAtDate);
              } else if (userData.createdAt._seconds) {
                // Handle timestamp with _seconds (older format)
                createdAtDate = new Date(userData.createdAt._seconds * 1000);
                console.log('Found timestamp with _seconds, converted to:', createdAtDate);
              } else {
                // Try to parse as regular date
                createdAtDate = new Date(userData.createdAt);
                console.log('Parsed as regular date:', createdAtDate);
              }
            } catch (dateError) {
              console.error('Error parsing Firestore createdAt:', dateError, userData.createdAt);
            }
          } else {
            console.log('No createdAt field in Firestore userData');
          }
          
          // Fallback to Firebase Auth metadata if Firestore date is not available
          if (!createdAtDate && currentUser.metadata && currentUser.metadata.creationTime) {
            try {
              createdAtDate = new Date(currentUser.metadata.creationTime);
              console.log('Using Firebase Auth creationTime:', createdAtDate);
            } catch (dateError) {
              console.error('Error parsing Auth metadata creationTime:', dateError);
            }
          } else if (!createdAtDate) {
            console.log('No creationTime in Firebase Auth metadata');
          }
          
          // Format the date
          if (createdAtDate && !isNaN(createdAtDate.getTime())) {
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            memberSince = createdAtDate.toLocaleDateString('en-US', options);
            console.log('Formatted member since date:', memberSince);
          } else {
            console.warn('Could not determine account creation date - createdAt missing or invalid');
            // Check if createdAt field is missing in Firestore
            if (!userData.createdAt) {
              memberSince = 'createdAt field is missing';
            } else {
              memberSince = 'Unknown';
            }
          }
          
          const memberSinceEl = document.getElementById('memberSince');
          if (memberSinceEl && memberSince) {
            memberSinceEl.textContent = memberSince;
          }
          
          // Display account number - generate one if missing
          const accountNumberEl = document.getElementById('accountNumber');
          if (accountNumberEl) {
            if (userData.accountNumber) {
              accountNumberEl.textContent = userData.accountNumber;
              accountNumberEl.classList.remove('loading');
            } else {
              // Account number is missing - generate one for existing users
              console.log('Account number missing, generating one for existing user...');
              accountNumberEl.textContent = 'Generating...';
              
              // Generate unique account number
              // For simplicity, we'll generate a number without checking uniqueness first
              // Collision probability is extremely low (1 in 900 million)
              // If there's a collision, we can handle it later
              function generateAccountNumber() {
                // Generate a random 9-digit number (100000000 to 999999999)
                const accountNumber = Math.floor(100000000 + Math.random() * 900000000);
                console.log('Generated account number:', accountNumber);
                return accountNumber;
              }
              
              // Generate and save account number
              try {
                console.log('Starting account number generation...');
                const accountNumber = generateAccountNumber();
                console.log('Account number generated:', accountNumber);
                
                const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', currentUser.uid);
                console.log('Updating Firestore document with account number...');
                await window.firebaseFirestoreFunctions.updateDoc(userDocRef, {
                  accountNumber: accountNumber
                });
                console.log('Account number generated and saved successfully:', accountNumber);
                accountNumberEl.textContent = accountNumber;
                accountNumberEl.classList.remove('loading');
              } catch (error) {
                console.error('Error generating account number:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                accountNumberEl.textContent = 'Error: ' + (error.message || 'Failed to generate');
                accountNumberEl.classList.remove('loading');
                accountNumberEl.style.color = '#d32f2f';
              }
            }
          }

          // Display email
          const emailEl = document.getElementById('userEmail');
          if (emailEl) {
            emailEl.textContent = userData.email || currentUser.email || 'Not available';
            emailEl.classList.remove('loading');
          }
          
          // Display email verification status
          const verificationStatusEl = document.getElementById('emailVerificationStatus');
          const verifyEmailLink = document.getElementById('verifyEmailLink');
          if (verificationStatusEl) {
            try {
              await currentUser.reload(); // Get latest verification status
              if (currentUser.emailVerified) {
                verificationStatusEl.textContent = '✓ Verified';
                verificationStatusEl.style.color = '#2e7d32';
                if (verifyEmailLink) {
                  verifyEmailLink.style.display = 'none';
                }
              } else {
                verificationStatusEl.textContent = '✗ Not verified';
                verificationStatusEl.style.color = '#d32f2f';
                if (verifyEmailLink) {
                  verifyEmailLink.style.display = 'inline';
                }
              }
            } catch (reloadError) {
              // If reload fails, check cached status
              if (currentUser.emailVerified) {
                verificationStatusEl.textContent = '✓ Verified';
                verificationStatusEl.style.color = '#2e7d32';
                if (verifyEmailLink) {
                  verifyEmailLink.style.display = 'none';
                }
              } else {
                verificationStatusEl.textContent = '✗ Not verified';
                verificationStatusEl.style.color = '#d32f2f';
                if (verifyEmailLink) {
                  verifyEmailLink.style.display = 'inline';
                }
              }
            }
            verificationStatusEl.classList.remove('loading');
          }

          // Display username
          const usernameDisplayEl = document.getElementById('usernameDisplay');
          if (usernameDisplayEl) {
            // Check if username exists and is not just the email prefix
            const storedUsername = userData.username;
            const emailPrefix = currentUser.email?.split('@')[0];
            
            // Only use email prefix if username is missing or if username equals email prefix (likely a fallback)
            if (storedUsername && storedUsername !== emailPrefix) {
              usernameDisplayEl.textContent = storedUsername;
            } else if (storedUsername) {
              // Username exists but is same as email prefix - might be a fallback, show it anyway
              usernameDisplayEl.textContent = storedUsername;
            } else {
              // No username stored - show email prefix as fallback
              usernameDisplayEl.textContent = emailPrefix || 'Not set';
              console.warn('⚠️ Username not found in userData, using email prefix:', emailPrefix);
            }
            usernameDisplayEl.classList.remove('loading');
          }

          // Display password status - check if user has email/password provider
          const passwordEl = document.getElementById('passwordStatus');
          if (passwordEl) {
            if (currentUser.providerData && currentUser.providerData.length > 0) {
              const hasPasswordProvider = currentUser.providerData.some(provider => provider.providerId === 'password');
              if (hasPasswordProvider) {
                passwordEl.textContent = '••••••••';
              } else {
                passwordEl.textContent = 'None';
                passwordEl.style.color = '#999';
              }
            } else {
              passwordEl.textContent = 'None';
              passwordEl.style.color = '#999';
            }
            passwordEl.classList.remove('loading');
          }

          // Display email reminder subscription status
          const emailReminderStatusEl = document.getElementById('emailReminderStatus');
          const reminderButtonEl = document.getElementById('reminderButton');
          if (emailReminderStatusEl && reminderButtonEl) {
            const isSubscribed = userData.emailSubscribed === true;
            if (isSubscribed) {
              emailReminderStatusEl.textContent = '✓ You are subscribed to daily reminder emails.';
              emailReminderStatusEl.style.color = '#4caf50';
              emailReminderStatusEl.style.display = 'block';
              reminderButtonEl.textContent = 'Manage subscription';
            } else {
              emailReminderStatusEl.style.display = 'none';
              reminderButtonEl.textContent = 'Sign up';
            }
          }

        } else {
          // User document doesn't exist - create it now
          console.log('User document does not exist, creating it now...');
          
          // Try to retrieve username from pendingUsernames or localStorage (same logic as verify-email.html)
          let username = null;
          
          // First, try to get username from Firestore (persists across devices/browsers)
          try {
            const pendingUsernameRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'pendingUsernames', currentUser.uid);
            const pendingUsernameDoc = await window.firebaseFirestoreFunctions.getDoc(pendingUsernameRef);
            if (pendingUsernameDoc.exists()) {
              username = pendingUsernameDoc.data().username;
              console.log('✓ Username retrieved from Firestore pendingUsernames:', username);
              // Delete the pending username document after retrieving it
              await window.firebaseFirestoreFunctions.deleteDoc(pendingUsernameRef);
              console.log('✓ Pending username document deleted');
            }
          } catch (firestoreError) {
            console.error('Error retrieving username from Firestore:', firestoreError);
            // Continue to try localStorage fallback
          }
          
          // If not found in Firestore, try localStorage (fallback)
          if (!username) {
            username = localStorage.getItem('pendingUsername');
            if (username) {
              localStorage.removeItem('pendingUsername'); // Clean up after use
              console.log('✓ Username retrieved from localStorage:', username);
            }
          }
          
          // If still no username found, use email prefix as last resort
          if (!username) {
            username = currentUser.email?.split('@')[0] || 'User';
            console.warn('⚠️ No username found in Firestore or localStorage, using email prefix:', username);
            console.warn('⚠️ This means the username was not properly stored during signup or was cleared');
          }
          
          console.log('✓ Final username to be stored in Firestore:', username);
          updateGreeting(username);
          
          // Show loading state
          const accountNumberEl = document.getElementById('accountNumber');
          if (accountNumberEl) {
            accountNumberEl.textContent = 'Creating account...';
            accountNumberEl.classList.add('loading');
          }
          
          try {
            // Generate account number
            function generateAccountNumber() {
              const accountNumber = Math.floor(100000000 + Math.random() * 900000000);
              console.log('Generated account number:', accountNumber);
              return accountNumber;
            }
            
            const accountNumber = generateAccountNumber();
            
            // Validate username is still available before creating document
            if (username && username !== currentUser.email?.split('@')[0]) {
              const usersRef = window.firebaseFirestoreFunctions.collection(window.firebaseDb, 'users');
              const usernameQuery = window.firebaseFirestoreFunctions.query(
                usersRef,
                window.firebaseFirestoreFunctions.where('username', '==', username)
              );
              const usernameSnapshot = await window.firebaseFirestoreFunctions.getDocs(usernameQuery);
              
              if (!usernameSnapshot.empty) {
                // Username was taken - use email prefix instead
                console.warn('⚠️ Username was taken, using email prefix instead');
                username = currentUser.email?.split('@')[0] || 'User';
              }
            }
            
            // Create user document in Firestore
            const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', currentUser.uid);
            await window.firebaseFirestoreFunctions.setDoc(userDocRef, {
              email: currentUser.email || '',
              username: username,
              accountNumber: accountNumber,
              gamesPlayed: 0,
              gamesWon: 0,
              currentStreak: 0,
              maxStreak: 0,
              emailSubscribed: false,
              createdAt: window.firebaseFirestoreFunctions.serverTimestamp()
            });
            
            console.log('User document created successfully with account number:', accountNumber);
            
            // Now fetch the newly created document to display all data
            const newUserDoc = await window.firebaseFirestoreFunctions.getDoc(userDocRef);
            if (newUserDoc.exists()) {
              const userData = newUserDoc.data();
              console.log('Newly created user data:', userData);
              
              // Display account number
              if (accountNumberEl) {
                accountNumberEl.textContent = accountNumber;
                accountNumberEl.classList.remove('loading');
              }
              
              // Display email
              const emailEl = document.getElementById('userEmail');
              if (emailEl) {
                emailEl.textContent = userData.email || currentUser.email || 'Not available';
                emailEl.classList.remove('loading');
              }
              
              // Display email verification status
              const verificationStatusEl = document.getElementById('emailVerificationStatus');
              const verifyEmailLink = document.getElementById('verifyEmailLink');
              if (verificationStatusEl) {
                try {
                  await currentUser.reload(); // Get latest verification status
                  if (currentUser.emailVerified) {
                    verificationStatusEl.textContent = '✓ Verified';
                    verificationStatusEl.style.color = '#2e7d32';
                    if (verifyEmailLink) {
                      verifyEmailLink.style.display = 'none';
                    }
                  } else {
                    verificationStatusEl.textContent = '✗ Not verified';
                    verificationStatusEl.style.color = '#d32f2f';
                    if (verifyEmailLink) {
                      verifyEmailLink.style.display = 'inline';
                    }
                  }
                } catch (reloadError) {
                  if (currentUser.emailVerified) {
                    verificationStatusEl.textContent = '✓ Verified';
                    verificationStatusEl.style.color = '#2e7d32';
                    if (verifyEmailLink) {
                      verifyEmailLink.style.display = 'none';
                    }
                  } else {
                    verificationStatusEl.textContent = '✗ Not verified';
                    verificationStatusEl.style.color = '#d32f2f';
                    if (verifyEmailLink) {
                      verifyEmailLink.style.display = 'inline';
                    }
                  }
                }
                verificationStatusEl.classList.remove('loading');
              }
              
              // Display username
              const usernameDisplayEl = document.getElementById('usernameDisplay');
              if (usernameDisplayEl) {
                // Prefer userData.username if it exists and is different from email prefix
                const storedUsername = userData.username;
                const emailPrefix = currentUser.email?.split('@')[0];
                
                console.log('Username display - storedUsername:', storedUsername, 'emailPrefix:', emailPrefix);
                
                if (storedUsername && storedUsername !== emailPrefix) {
                  usernameDisplayEl.textContent = storedUsername;
                } else if (storedUsername) {
                  usernameDisplayEl.textContent = storedUsername;
                } else {
                  usernameDisplayEl.textContent = username || emailPrefix || 'Not set';
                  console.warn('⚠️ Username not found in userData, using fallback:', username || emailPrefix);
                }
                usernameDisplayEl.classList.remove('loading');
              }
              
              // Display password status
              const passwordEl = document.getElementById('passwordStatus');
              if (passwordEl) {
                if (currentUser.providerData && currentUser.providerData.length > 0) {
                  const hasPasswordProvider = currentUser.providerData.some(provider => provider.providerId === 'password');
                  passwordEl.textContent = hasPasswordProvider ? '••••••••' : 'None';
                  if (!hasPasswordProvider) passwordEl.style.color = '#999';
                } else {
                  passwordEl.textContent = 'None';
                  passwordEl.style.color = '#999';
                }
                passwordEl.classList.remove('loading');
              }
              
              // Display email reminder subscription status
              const emailReminderStatusEl = document.getElementById('emailReminderStatus');
              const reminderButtonEl = document.getElementById('reminderButton');
              if (emailReminderStatusEl && reminderButtonEl) {
                const isSubscribed = userData.emailSubscribed === true;
                if (isSubscribed) {
                  emailReminderStatusEl.textContent = '✓ You are subscribed to daily reminder emails.';
                  emailReminderStatusEl.style.color = '#4caf50';
                  emailReminderStatusEl.style.display = 'block';
                  reminderButtonEl.textContent = 'Manage subscription';
                } else {
                  emailReminderStatusEl.style.display = 'none';
                  reminderButtonEl.textContent = 'Sign up';
                }
              }
              
              // Display member since date
              let memberSince = null;
              let createdAtDate = null;
              
              if (userData.createdAt) {
                try {
                  if (userData.createdAt.toDate) {
                    createdAtDate = userData.createdAt.toDate();
                  } else if (userData.createdAt.seconds) {
                    createdAtDate = new Date(userData.createdAt.seconds * 1000);
                  } else {
                    createdAtDate = new Date(userData.createdAt);
                  }
                } catch (dateError) {
                  console.error('Error parsing createdAt:', dateError);
                }
              }
              
              if (!createdAtDate && currentUser.metadata && currentUser.metadata.creationTime) {
                createdAtDate = new Date(currentUser.metadata.creationTime);
              }
              
              if (createdAtDate && !isNaN(createdAtDate.getTime())) {
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                memberSince = createdAtDate.toLocaleDateString('en-US', options);
              } else {
                memberSince = 'Unknown';
              }
              
              const memberSinceEl = document.getElementById('memberSince');
              if (memberSinceEl && memberSince) {
                memberSinceEl.textContent = memberSince;
              }
              
              // Clear any error messages
              const errorMessageEl = document.getElementById('errorMessage');
              if (errorMessageEl) {
                errorMessageEl.style.display = 'none';
              }
            }
          } catch (createError) {
            console.error('Error creating user document:', createError);
            console.error('Error code:', createError.code);
            console.error('Error message:', createError.message);
            
            // Show error but still display what we can from auth
            const errorMessageEl = document.getElementById('errorMessage');
            if (errorMessageEl) {
              errorMessageEl.textContent = 'Error creating account. Please try refreshing the page.';
              errorMessageEl.style.display = 'block';
            }
            
            if (accountNumberEl) {
              accountNumberEl.textContent = 'Error creating account';
              accountNumberEl.classList.remove('loading');
              accountNumberEl.style.color = '#d32f2f';
            }
            
            // Still show basic info from auth
            const emailEl = document.getElementById('userEmail');
            if (emailEl) {
              emailEl.textContent = currentUser.email || 'Not available';
              emailEl.classList.remove('loading');
            }
            
            // Display email verification status
            const verificationStatusEl = document.getElementById('emailVerificationStatus');
            const verifyEmailLink = document.getElementById('verifyEmailLink');
            if (verificationStatusEl) {
              try {
                await currentUser.reload();
                if (currentUser.emailVerified) {
                  verificationStatusEl.textContent = '✓ Verified';
                  verificationStatusEl.style.color = '#2e7d32';
                  if (verifyEmailLink) {
                    verifyEmailLink.style.display = 'none';
                  }
                } else {
                  verificationStatusEl.textContent = '✗ Not verified';
                  verificationStatusEl.style.color = '#d32f2f';
                  if (verifyEmailLink) {
                    verifyEmailLink.style.display = 'inline';
                  }
                }
              } catch (reloadError) {
                if (currentUser.emailVerified) {
                  verificationStatusEl.textContent = '✓ Verified';
                  verificationStatusEl.style.color = '#2e7d32';
                  if (verifyEmailLink) {
                    verifyEmailLink.style.display = 'none';
                  }
                } else {
                  verificationStatusEl.textContent = '✗ Not verified';
                  verificationStatusEl.style.color = '#d32f2f';
                  if (verifyEmailLink) {
                    verifyEmailLink.style.display = 'inline';
                  }
                }
              }
              verificationStatusEl.classList.remove('loading');
            }
            
            const usernameDisplayEl = document.getElementById('usernameDisplay');
            if (usernameDisplayEl) {
              usernameDisplayEl.textContent = username;
              usernameDisplayEl.classList.remove('loading');
            }
            
            const passwordEl = document.getElementById('passwordStatus');
            if (passwordEl) {
              if (currentUser.providerData && currentUser.providerData.length > 0) {
                const hasPasswordProvider = currentUser.providerData.some(provider => provider.providerId === 'password');
                passwordEl.textContent = hasPasswordProvider ? '••••••••' : 'None';
                if (!hasPasswordProvider) passwordEl.style.color = '#999';
              } else {
                passwordEl.textContent = 'None';
                passwordEl.style.color = '#999';
              }
              passwordEl.classList.remove('loading');
            }
            
            // Display email reminder subscription status (default to not subscribed if document creation failed)
            const emailReminderStatusEl = document.getElementById('emailReminderStatus');
            const reminderButtonEl = document.getElementById('reminderButton');
            if (emailReminderStatusEl && reminderButtonEl) {
              emailReminderStatusEl.style.display = 'none';
              reminderButtonEl.textContent = 'Sign up';
            }
          }
          
          const nameEl = document.getElementById('displayName');
          if (nameEl) {
            nameEl.textContent = username;
            nameEl.classList.remove('loading');
          } else {
            console.warn('displayName element not found');
          }
        }
      } catch (error) {
        console.error('Error loading account details:', error);
        console.error('Error stack:', error.stack);
        const errorMessageEl = document.getElementById('errorMessage');
        if (errorMessageEl) {
          // Provide more user-friendly error messages
          let errorMsg = 'Error loading account details. Please try again.';
          if (error.message && error.message.includes('offline')) {
            errorMsg = 'Unable to load account details. Please check your internet connection and try again.';
          } else if (error.message) {
            errorMsg = 'Error loading account details: ' + error.message;
          }
          errorMessageEl.textContent = errorMsg;
          errorMessageEl.style.display = 'block';
        }
      }
    }

    // Placeholder handlers for update links
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('updateEmailLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'change-email.html';
      });
      
      document.getElementById('verifyEmailLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'verify-email.html';
      });
      
      
      document.getElementById('updatePasswordLink')?.addEventListener('click', function(e) {
        e.preventDefault();
        window.location.href = 'change-password.html';
      });
      
    });

    // Function to update email verification status (can be called independently)
    async function updateEmailVerificationStatus() {
      console.log('updateEmailVerificationStatus called');
      const currentUser = window.firebaseAuth ? window.firebaseAuth.currentUser : null;
      if (!currentUser) {
        console.log('No current user found');
        return;
      }
      
      const verificationStatusEl = document.getElementById('emailVerificationStatus');
      const verifyEmailLink = document.getElementById('verifyEmailLink');
      
      console.log('Verification status element found:', !!verificationStatusEl);
      
      if (verificationStatusEl) {
        try {
          await currentUser.reload(); // Get latest verification status
          console.log('Email verified status:', currentUser.emailVerified);
          if (currentUser.emailVerified) {
            verificationStatusEl.textContent = '✓ Verified';
            verificationStatusEl.style.color = '#2e7d32';
            verificationStatusEl.style.fontWeight = '500';
            console.log('Set status to Verified');
            if (verifyEmailLink) {
              verifyEmailLink.style.display = 'none';
            }
          } else {
            verificationStatusEl.textContent = '✗ Not verified';
            verificationStatusEl.style.color = '#d32f2f';
            verificationStatusEl.style.fontWeight = '500';
            console.log('Set status to Not verified');
            if (verifyEmailLink) {
              verifyEmailLink.style.display = 'inline';
            }
          }
          verificationStatusEl.classList.remove('loading');
          console.log('Verification status updated successfully');
        } catch (reloadError) {
          console.error('Error reloading user for verification status:', reloadError);
          // Fallback to cached status
          if (currentUser.emailVerified) {
            verificationStatusEl.textContent = '✓ Verified';
            verificationStatusEl.style.color = '#2e7d32';
            verificationStatusEl.style.fontWeight = '500';
            if (verifyEmailLink) {
              verifyEmailLink.style.display = 'none';
            }
          } else {
            verificationStatusEl.textContent = '✗ Not verified';
            verificationStatusEl.style.color = '#d32f2f';
            verificationStatusEl.style.fontWeight = '500';
            if (verifyEmailLink) {
              verifyEmailLink.style.display = 'inline';
            }
          }
          verificationStatusEl.classList.remove('loading');
        }
      }
    }
    
    // Load account details when page loads
    // Use both DOMContentLoaded and window.onload to ensure page is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadAccountDetails);
      document.addEventListener('DOMContentLoaded', function() {
        // Also update verification status after a short delay to ensure Firebase is loaded
        setTimeout(updateEmailVerificationStatus, 1000);
      });
    } else {
      // DOM already loaded, call immediately
      loadAccountDetails();
      setTimeout(updateEmailVerificationStatus, 1000);
    }
    
    // Also update verification status when auth state changes
    if (window.firebaseAuthFunctions && window.firebaseAuth) {
      window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
          setTimeout(updateEmailVerificationStatus, 500);
        }
      });
    }

    // Handle delete account click
    function handleDeleteAccountClick(event) {
      event.preventDefault();
      
      // Wait for Firebase to be available, then check auth state
      const checkAuth = () => {
        if (window.firebaseAuth && window.firebaseAuthFunctions) {
          // Check if user is logged in
          if (window.firebaseAuth.currentUser) {
            // User is logged in - go directly to delete account page
            window.location.href = 'delete-account.html';
          } else {
            // User is not logged in - go to login page with return URL
            window.location.href = 'login.html?return=' + encodeURIComponent('delete-account.html');
          }
        } else {
          // Firebase not loaded yet, wait a bit and try again
          setTimeout(checkAuth, 100);
        }
      };
      
      checkAuth();
    }

  </script>
</body>
</html>
