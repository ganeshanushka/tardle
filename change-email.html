<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Change email</title>
<style>
  body {
    font-family: 'PT Serif', sans-serif;
    background-color: white;
    margin: 0;
    padding: 0;
    color: #1a1a1a;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .container {
    max-width: 600px;
    width: 100%;
    margin: 0 auto;
    padding: 0 20px 60px 20px;
    box-sizing: border-box;
  }

  h1 {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #1a1a1a;
  }

  .intro-text {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 30px;
    color: #1a1a1a;
  }

  .intro-text strong {
    font-weight: bold;
  }

  .form-group {
    margin-bottom: 24px;
  }

  .form-group label {
    display: block;
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #1a1a1a;
  }

  .form-group input {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-family: 'PT Serif', sans-serif;
  }

  .form-group input:focus {
    outline: none;
    border-color: #7BAFD4;
  }

  .password-wrapper {
    position: relative;
    width: 100%;
  }

  .password-wrapper input {
    width: 100%;
    padding-right: 40px;
    box-sizing: border-box;
  }

  .password-toggle {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    margin: 0;
  }

  .password-toggle svg {
    width: 20px;
    height: 20px;
    stroke: #666;
  }

  .password-toggle:hover svg {
    stroke: #333;
  }

  .button-container {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 30px;
  }

  .save-button {
    background-color: #000;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'PT Serif', sans-serif;
    transition: background-color 0.2s ease;
  }

  .save-button:hover {
    background-color: #333;
  }

  .save-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .return-link {
    color: #333;
    text-decoration: underline;
    font-size: 16px;
  }

  .return-link:hover {
    color: #000;
  }

  .forgot-password-link {
    color: #333;
    text-decoration: underline;
    font-size: 16px;
    margin-left: auto;
  }

  .forgot-password-link:hover {
    color: #000;
  }

  .error-message {
    color: #d32f2f;
    font-size: 14px;
    margin-top: 10px;
    display: none;
    align-items: center;
    gap: 8px;
  }

  .error-message.show {
    display: flex;
  }

  .error-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: #d32f2f;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .error-icon::before {
    content: '!';
    color: white;
    font-weight: bold;
    font-size: 12px;
  }

  .form-group .error-message {
    margin-top: 8px;
  }

  .form-group input.error {
    border-color: #d32f2f;
  }

  .password-error {
    margin-top: 8px;
  }

  .success-message {
    color: #2e7d32;
    font-size: 14px;
    margin-top: 10px;
    display: none;
  }

  .success-message.show {
    display: block;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Change email</h1>
  
  <div class="intro-text">
    You're currently logged in with <strong id="currentEmail">Loading...</strong>. By clicking "Save" below, you consent to continue receiving at your new email address any daily reminder emails and game updates we have been sending to your current email address, along with account updates, notifications and all other emails.
  </div>

  <form id="changeEmailForm" novalidate>
    <div class="form-group">
      <label for="newEmail">New email</label>
      <input type="email" id="newEmail" name="newEmail" placeholder="Enter email">
      <div class="error-message" id="emailError">
        <div class="error-icon"></div>
        <span id="emailErrorText"></span>
      </div>
    </div>

    <div class="form-group">
      <label for="password">Your password</label>
      <div class="password-wrapper">
        <input type="password" id="password" name="password" placeholder="Enter password">
        <button type="button" class="password-toggle" id="passwordToggle" aria-label="Toggle password visibility">
          <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>
      <div class="error-message password-error" id="passwordError">
        <div class="error-icon"></div>
        <span id="passwordErrorText">Please enter a password.</span>
      </div>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div class="button-container">
      <button type="submit" class="save-button" id="saveButton">Save</button>
      <a href="account-details.html" class="return-link">Return to account</a>
      <a href="#" class="forgot-password-link" id="forgotPasswordLink">Forgot password</a>
    </div>
  </form>
</div>

<!-- Firebase Config -->
<script type="module" src="firebase-config.js"></script>

<script type="module">
  // Import verifyBeforeUpdateEmail directly as fallback
  import { verifyBeforeUpdateEmail } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
  // Make it available globally for non-module scripts
  window.verifyBeforeUpdateEmailDirect = verifyBeforeUpdateEmail;
  console.log('Direct import of verifyBeforeUpdateEmail:', typeof verifyBeforeUpdateEmail);
</script>

<script>
  // Get current user email and display it
  let currentUser = null;
  let userEmail = '';
  let username = '';
  let isProcessingForm = false; // Flag to prevent redirect during form submission

  // Ensure DOM is ready
  function initEmailPage() {
    // Wait for Firebase to load
    const checkFirebase = setInterval(() => {
    if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions && window.firebaseDb) {
      clearInterval(checkFirebase);
      
      // Update email immediately if user is already logged in
      const updateEmailDisplay = () => {
        const currentEmailEl = document.getElementById('currentEmail');
        if (currentEmailEl && window.firebaseAuth.currentUser) {
          const email = window.firebaseAuth.currentUser.email || '';
          currentEmailEl.textContent = email;
          userEmail = email;
          currentUser = window.firebaseAuth.currentUser;
        }
      };
      
      // Try to update immediately
      updateEmailDisplay();
      
      // Set up listener for auth state changes
      window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
          currentUser = user;
          userEmail = user.email || '';
          const currentEmailEl = document.getElementById('currentEmail');
          if (currentEmailEl) {
            currentEmailEl.textContent = userEmail;
          }
          
        } else {
          // User is not logged in - redirect to login
          // But don't redirect if:
          // 1. We're currently processing the form (might be temporary)
          // 2. User is actively typing in the email or password field (might trigger false logout detection)
          // Note: This protection only prevents redirects - it doesn't affect email validation or error display
          const newEmailInput = document.getElementById('newEmail');
          const passwordInput = document.getElementById('password');
          const isTyping = (newEmailInput && document.activeElement === newEmailInput) ||
                          (passwordInput && document.activeElement === passwordInput);
          
          if (!isProcessingForm && !isTyping) {
            console.log('‚ö†Ô∏è Auth state changed: user logged out, redirecting...');
            window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
          } else {
            if (isTyping) {
              console.log('‚ö†Ô∏è Auth state changed but user is typing - not redirecting (email validation still works)');
            } else {
              console.log('‚ö†Ô∏è User logged out during form processing - will handle in form handler');
            }
          }
        }
      });
      
      // Also try updating after a short delay in case auth state hasn't been restored yet
      setTimeout(updateEmailDisplay, 500);
      
      // Wait for Firebase to restore the session
      // Give it more time and check if user is actively interacting with the form
      setTimeout(() => {
        const newEmailInput = document.getElementById('newEmail');
        const passwordInput = document.getElementById('password');
        const isTyping = (newEmailInput && document.activeElement === newEmailInput) ||
                        (passwordInput && document.activeElement === passwordInput);
        
        if (!window.firebaseAuth.currentUser && !isProcessingForm && !isTyping) {
          console.log('‚ö†Ô∏è No user found after session restore, redirecting...');
          window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
        } else {
          if (window.firebaseAuth.currentUser) {
            // Update email one more time after session is restored
            updateEmailDisplay();
          } else if (isTyping) {
            console.log('‚ö†Ô∏è User is typing - not redirecting even though no user found');
          }
        }
      }, 2000); // Increased timeout to give more time for session restoration
    }
    }, 100);
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initEmailPage);
  } else {
    initEmailPage();
  }

  // Handle form submission
  // Toggle password visibility
  const passwordInput = document.getElementById('password');
  const passwordToggle = document.getElementById('passwordToggle');
  const eyeIcon = document.getElementById('eyeIcon');
  
  if (passwordToggle && eyeIcon) {
    passwordToggle.addEventListener('click', function() {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      
      // Update icon based on visibility
      if (type === 'text') {
        // Show eye with slash (hidden)
        eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
      } else {
        // Show normal eye (visible)
        eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
      }
    });
  }
  
  // Check email availability in real-time when user enters email
  let emailCheckTimeout = null;
  const newEmailInput = document.getElementById('newEmail');
  const emailError = document.getElementById('emailError');
  const emailErrorText = document.getElementById('emailErrorText');
  
  // Function to check if email is already in use
  const checkEmailAvailability = async function(email) {
    // Basic validation first
    if (!email || !email.trim()) {
      emailError.classList.remove('show');
      newEmailInput.classList.remove('error');
      return;
    }
    
    const trimmedEmail = email.trim();
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(trimmedEmail)) {
      // Don't check invalid emails
      return;
    }
    
    // Check if it's the same as current email
    if (currentUser && currentUser.email && trimmedEmail.toLowerCase() === currentUser.email.toLowerCase()) {
      emailErrorText.textContent = 'The email address you entered is already associated with this account. Please enter a different email address.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      return;
    }
    
    // Wait for Firebase to be ready
    if (!window.firebaseAuth || !window.firebaseAuthFunctions) {
      return;
    }
    
    // Check if email is already in use
    // Note: Due to Email Enumeration Protection, we can only reliably detect emails in use
    // if fetchSignInMethodsForEmail returns methods. If it returns empty, we can't tell.
    // For emails that aren't in use, we'll allow the user to proceed and Firebase will
    // catch any issues during the actual email change attempt.
    try {
      console.log('üîç Checking email availability:', trimmedEmail);
      
      // Try fetchSignInMethodsForEmail (works if Email Enumeration Protection is disabled)
      let signInMethods = [];
      let emailInUse = false;
      try {
        console.log('  Calling fetchSignInMethodsForEmail for:', trimmedEmail);
        signInMethods = await window.firebaseAuthFunctions.fetchSignInMethodsForEmail(window.firebaseAuth, trimmedEmail);
        console.log('  Sign-in methods returned:', signInMethods);
        console.log('  Sign-in methods type:', typeof signInMethods);
        console.log('  Sign-in methods is array:', Array.isArray(signInMethods));
        console.log('  Sign-in methods length:', signInMethods ? signInMethods.length : 'null/undefined');
        
        // Only show error if we got actual sign-in methods (not empty array)
        // Empty array means either email doesn't exist OR Email Enumeration Protection is hiding it
        if (signInMethods && Array.isArray(signInMethods) && signInMethods.length > 0) {
          emailInUse = true;
          console.warn('‚ùå Email is already in use (detected via sign-in methods)!');
          console.warn('  Sign-in methods found:', signInMethods);
          console.warn('  üö® Showing error immediately - email is in Firebase');
          
          // Set error message
          if (emailErrorText) {
            emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
          }
          
          // Show error
          if (emailError) {
            emailError.classList.add('show');
          }
          if (newEmailInput) {
            newEmailInput.classList.add('error');
          }
          
          console.log('  ‚úÖ Error displayed - email is already in Firebase');
          return;
        } else {
          console.log('  ‚úì No sign-in methods returned - trying alternative check method...');
          
          // Email Enumeration Protection is likely enabled - try alternative method
          // Attempt to sign in with a dummy password to detect if email exists
          // This won't log the current user out because we're just checking for errors
          try {
            console.log('  üîç Trying signInWithEmailAndPassword with dummy password to detect email existence...');
            const dummyPassword = 'CheckEmailExists123!@#';
            await window.firebaseAuthFunctions.signInWithEmailAndPassword(
              window.firebaseAuth,
              trimmedEmail,
              dummyPassword
            );
            // If we get here, the email doesn't exist (sign in succeeded with wrong password? unlikely)
            console.log('  ‚ö†Ô∏è Unexpected: sign in succeeded - this should not happen');
          } catch (signInError) {
            const errorCode = signInError.code || '';
            console.log('  Sign-in check error code:', errorCode);
            
            // If we get auth/user-not-found, the email doesn't exist
            if (errorCode === 'auth/user-not-found') {
              console.log('  ‚úì Email does NOT exist in Firebase (user-not-found)');
              emailInUse = false;
            } 
            // If we get auth/wrong-password, the email EXISTS but password is wrong
            else if (errorCode === 'auth/wrong-password' || 
                     errorCode === 'auth/invalid-credential' ||
                     errorCode === 'auth/invalid-login-credentials') {
              emailInUse = true;
              console.warn('‚ùå Email IS in use (detected via sign-in attempt - wrong password error)!');
              console.warn('  üö® Showing error immediately - email exists in Firebase');
              
              // Set error message
              if (emailErrorText) {
                emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
              }
              
              // Show error
              if (emailError) {
                emailError.classList.add('show');
              }
              if (newEmailInput) {
                newEmailInput.classList.add('error');
              }
              
              console.log('  ‚úÖ Error displayed - email is already in Firebase');
              return;
            } else {
              console.log('  ‚ö†Ô∏è Could not determine email existence (error:', errorCode + ')');
            }
          }
          
          // Clear error if email appears available
          if (!emailInUse) {
            if (emailError) {
              emailError.classList.remove('show');
            }
            if (newEmailInput) {
              newEmailInput.classList.remove('error');
            }
          }
        }
      } catch (fetchError) {
        console.error('  ‚úó fetchSignInMethodsForEmail failed:', fetchError);
        console.error('  Error code:', fetchError.code);
        console.error('  Error message:', fetchError.message);
        // If fetchSignInMethodsForEmail fails, we can't determine email availability
        // Don't show error - allow user to proceed and Firebase will catch it
      }
      
      // If we still couldn't determine, log it
      if (!emailInUse) {
        console.log('  ‚ö†Ô∏è Could not determine if email is in use - will check during form submission');
        // Clear any previous error since we can't determine
        if (emailError) {
          emailError.classList.remove('show');
        }
        if (newEmailInput) {
          newEmailInput.classList.remove('error');
        }
      }
      
    } catch (checkError) {
      console.error('Error checking email:', checkError);
      // Don't show error if check fails - we'll catch it during form submission
      emailError.classList.remove('show');
      newEmailInput.classList.remove('error');
    }
  };
  
  if (newEmailInput) {
    // Check when user leaves the email field (moves to password field or clicks away)
    newEmailInput.addEventListener('blur', async function(e) {
      // Don't prevent default or stop propagation - let the blur happen naturally
      const email = newEmailInput.value.trim();
      
      // Only check if email is not empty and is valid format
      if (email && email.length > 0) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(email)) {
          console.log('üìß Email field blurred - checking availability for:', email);
          console.log('  User is moving away from email field - checking if email is in Firebase...');
          
          // Small delay to ensure blur completes before checking
          setTimeout(async () => {
            // Check email availability
            await checkEmailAvailability(email);
            console.log('  Email availability check complete after blur');
          }, 100);
        }
      }
    });
    
    // Also check on input with debounce (after user stops typing for 1 second)
    newEmailInput.addEventListener('input', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // Clear previous timeout
      if (emailCheckTimeout) {
        clearTimeout(emailCheckTimeout);
      }
      
      // Clear error when user starts typing
      emailError.classList.remove('show');
      newEmailInput.classList.remove('error');
      
      const email = newEmailInput.value;
      
      // Debounce: wait 1 second after user stops typing
      emailCheckTimeout = setTimeout(() => {
        checkEmailAvailability(email);
      }, 1000);
    });
    
    // Prevent form submission when Enter is pressed in email field
    newEmailInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        e.stopPropagation();
        // Focus on password field instead
        const passwordInput = document.getElementById('password');
        if (passwordInput) {
          passwordInput.focus();
        }
      }
    });
  }
  
  // Also check when password field receives focus (user moved from email to password)
  const passwordInputForFocus = document.getElementById('password');
  if (passwordInputForFocus && newEmailInput) {
    passwordInputForFocus.addEventListener('focus', async function(e) {
      const email = newEmailInput.value.trim();
      
      // Only check if email is not empty and is valid format
      if (email && email.length > 0) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(email)) {
          console.log('üîç Password field focused - checking email availability for:', email);
          console.log('  User moved from email field to password field');
          
          // Check email availability
          await checkEmailAvailability(email);
          
          console.log('  Email availability check complete after password field focus');
        }
      }
    });
  }

  document.getElementById('changeEmailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    // Set flag to prevent auth state change redirect during form processing
    isProcessingForm = true;
    
    // Ensure we don't proceed if form is being submitted without user action
    // Only proceed if Save button was clicked
    const saveButton = document.getElementById('saveButton');
    if (!saveButton || saveButton.disabled) {
      console.warn('‚ö†Ô∏è Form submission blocked - Save button not available or disabled');
      isProcessingForm = false;
      return;
    }
    
    try {
      // Check if user is still logged in before proceeding
      if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
        console.warn('‚ö†Ô∏è User is not logged in, redirecting to login...');
        isProcessingForm = false;
        window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
        return;
      }
      
      // Get form elements
      const errorMessage = document.getElementById('errorMessage');
      const emailError = document.getElementById('emailError');
      const emailErrorText = document.getElementById('emailErrorText');
      const passwordError = document.getElementById('passwordError');
      const passwordErrorText = document.getElementById('passwordErrorText');
      const successMessage = document.getElementById('successMessage');
      const saveButton = document.getElementById('saveButton');
      const newEmailInput = document.getElementById('newEmail');
      const passwordInput = document.getElementById('password');
      
      // Get form values
      const newEmail = newEmailInput ? newEmailInput.value.trim() : '';
      const passwordValue = passwordInput ? passwordInput.value.trim() : '';
      
      // Clear previous messages
      errorMessage.classList.remove('show');
      emailError.classList.remove('show');
      passwordError.classList.remove('show');
      successMessage.classList.remove('show');
      if (newEmailInput) newEmailInput.classList.remove('error');
      if (passwordInput) passwordInput.classList.remove('error');
      emailErrorText.textContent = '';
      passwordErrorText.textContent = '';
      errorMessage.textContent = '';
      successMessage.textContent = '';
      
      // Get current user fresh from Firebase
      const currentUser = window.firebaseAuth.currentUser;
      if (!currentUser) {
        console.warn('‚ö†Ô∏è No current user found, redirecting to login...');
        isProcessingForm = false;
        window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
        return;
      }
      
      const userEmail = currentUser.email || '';
      
      // ========================================================================
      // CRITICAL: PASSWORD VALIDATION MUST HAPPEN FIRST
      // ========================================================================
      // For security, we MUST verify the password BEFORE doing any other checks
      // This ensures users cannot bypass password verification
      // ========================================================================
      
      // Step 1: Check if password is missing
      if (!passwordValue || passwordValue === '') {
        console.log('‚ö†Ô∏è Password is empty, showing error and stopping');
        passwordErrorText.textContent = 'Please enter a password.';
        passwordError.classList.add('show');
        passwordInput.classList.add('error');
        passwordInput.focus();
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        isProcessingForm = false;
        return; // STOP - cannot proceed without password
      }
      
      console.log('üîê PASSWORD VALIDATION - RUNNING FIRST (before any other checks)');
      console.log('  Password length:', passwordValue.length);
      console.log('  Password value (first 2 chars):', passwordValue.substring(0, 2) + '***');
      console.log('  Current user email:', currentUser.email);
      console.log('  This ensures security - password must be verified before any email change');
      
      // Step 2: Verify password matches current account BEFORE any other checks
      saveButton.disabled = true;
      saveButton.textContent = 'Verifying password...';
      
      try {
        console.log('Re-authenticating user with provided password...');
        console.log('  Current account email:', currentUser.email);
        console.log('  Verifying password matches this account...');
        const credential = window.firebaseAuthFunctions.EmailAuthProvider.credential(
          currentUser.email,
          passwordValue
        );
        
        try {
          await window.firebaseAuthFunctions.reauthenticateWithCredential(currentUser, credential);
          console.log('‚úì Password verified successfully - password matches current account stored in Firebase');
          console.log('‚úì User has proven they know the current account password');
          console.log('‚úì NOW proceeding with other validation checks');
        } catch (reauthError) {
          console.error('‚úó Password verification failed:', reauthError);
          console.error('  Error code:', reauthError.code);
          console.error('  Error message:', reauthError.message);
          console.error('  Full error object:', JSON.stringify(reauthError, null, 2));
          console.error('  ‚ùå Password does NOT match the password stored in Firebase for this account');
          
          // Handle password-related errors - STOP HERE, do not proceed
          // Check for all possible password error codes
          const errorCode = reauthError.code || '';
          const errorMessage = (reauthError.message || '').toLowerCase();
          const isPasswordError = 
            errorCode === 'auth/wrong-password' || 
            errorCode === 'auth/invalid-credential' || 
            errorCode === 'auth/invalid-login-credentials' ||
            errorCode === 'auth/user-mismatch' ||
            errorCode === 'auth/user-not-found' ||
            errorMessage.includes('wrong password') ||
            errorMessage.includes('invalid credential') ||
            errorMessage.includes('invalid login') ||
            errorMessage.includes('password is invalid') ||
            errorMessage.includes('incorrect password');
          
          if (isPasswordError) {
            console.error('‚úó INCORRECT PASSWORD DETECTED - stopping email change process');
            console.error('  üõë User cannot proceed - password does not match Firebase account');
            console.error('  Error code matched:', errorCode);
            
            // Show error message
            passwordErrorText.textContent = 'Incorrect password. The password you entered does not match the password stored in Firebase for this account. Please enter the correct password.';
            passwordError.classList.add('show');
            passwordInput.classList.add('error');
            passwordInput.value = '';
            passwordInput.focus();
            saveButton.disabled = false;
            saveButton.textContent = 'Save';
            isProcessingForm = false;
            return; // STOP - cannot proceed with incorrect password
          }
          
          // If it's not a password error, log it and re-throw
          console.warn('‚ö†Ô∏è Unexpected re-authentication error (not password-related):', errorCode);
          throw reauthError;
        }
        
        // Password is verified - NOW we can proceed with other checks
        console.log('‚úÖ Password verified - proceeding with email verification and other checks');
        saveButton.disabled = true;
        saveButton.textContent = 'Checking...';
        
      } catch (passwordVerifyError) {
        console.error('‚úó Unexpected error during password verification:', passwordVerifyError);
        console.error('  üõë Cannot proceed with email change - password verification failed');
        passwordErrorText.textContent = 'Error verifying password. Please try again.';
        passwordError.classList.add('show');
        passwordInput.classList.add('error');
        passwordInput.focus();
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        isProcessingForm = false;
        return; // STOP - cannot proceed
      }
      
      // Password is verified - NOW check email verification status
      // Check if current email is verified (reload first to get latest status)
      try {
        await currentUser.reload(); // Get latest verification status
        console.log('Current email verification status:', currentUser.emailVerified);
      } catch (reloadError) {
        console.warn('Could not reload user, using cached status:', reloadError);
      }
      
      if (!currentUser.emailVerified) {
      console.log('Current email not verified. Attempting to send verification email to:', userEmail);
      try {
        // Build the correct URL for GitHub Pages
        const currentPath = window.location.pathname;
        const pathParts = currentPath.split('/').filter(p => p);
        if (pathParts.length > 0) {
          pathParts[pathParts.length - 1] = 'account-details.html';
        } else {
          pathParts.push('account-details.html');
        }
        const continueUrl = window.location.origin + '/' + pathParts.join('/');
        
        // Send verification email
        await window.firebaseAuthFunctions.sendEmailVerification(currentUser, {
          url: continueUrl,
          handleCodeInApp: false
        });
        console.log('Verification email sent successfully');
        errorMessage.textContent = 'Please verify your current email address (' + userEmail + ') before changing it. A verification email has been sent. Check your inbox (and spam folder) and click the verification link, then refresh this page and try again.';
        errorMessage.style.color = '#2e7d32'; // Green color for success message
      } catch (verifyError) {
        console.error('Error sending verification email:', verifyError);
        console.error('Error code:', verifyError.code);
        console.error('Error message:', verifyError.message);
        
        let errorMsg = 'Please verify your current email address (' + userEmail + ') before changing it. ';
        if (verifyError.code === 'auth/too-many-requests') {
          errorMsg += 'Too many verification emails sent. Please wait a few minutes and try again, or check your inbox for a previous verification email.';
        } else if (verifyError.message) {
          errorMsg += 'Unable to send verification email: ' + verifyError.message + '. Please check your inbox for a previous verification email, or contact support.';
        } else {
          errorMsg += 'We were unable to send a verification email. Please check your inbox for a previous verification email, or contact support.';
        }
        errorMessage.textContent = errorMsg;
        errorMessage.style.color = '#d32f2f'; // Red color for error
      }
      errorMessage.classList.add('show');
      return;
    }
    
    // Double-check user is still logged in before email check
    if (!window.firebaseAuth.currentUser) {
      console.warn('‚ö†Ô∏è User logged out during validation, redirecting...');
      window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
      return;
    }
    
    // Check if email is missing
    if (!newEmail || newEmail.trim() === '') {
      emailErrorText.textContent = 'Please enter a new email address.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      newEmailInput.focus();
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(newEmail)) {
      emailErrorText.textContent = 'Please enter a valid email address.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      newEmailInput.focus();
      return;
    }
    
    // Check email length (NYT standard: 64 characters max)
    if (newEmail.length > 64) {
      emailErrorText.textContent = 'Email address is too long. Please enter an email address that is 64 characters or less.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      newEmailInput.focus();
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      return;
    }
    
    // Check if new email is the same as current email
    if (newEmail.toLowerCase() === userEmail.toLowerCase()) {
      emailErrorText.textContent = 'The email address you entered is already associated with this account. Please enter a different email address.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      newEmailInput.focus();
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      return;
    }
    
    // Password is verified - NOW check email availability
    // ========================================================================
    // EMAIL AVAILABILITY CHECK - ONLY RUNS AFTER PASSWORD IS VERIFIED
    // ========================================================================
    // Note: Email format and "same as current email" validation already done above
    
    try {
      console.log('üîç Checking if email is already in use (AFTER password verification)...');
      console.log('  New email:', newEmail);
      console.log('  Current user email:', userEmail);
      
      let emailInUse = false;
      
      // Try fetchSignInMethodsForEmail
      let signInMethods = [];
      try {
        console.log('  Calling fetchSignInMethodsForEmail for:', newEmail);
        signInMethods = await window.firebaseAuthFunctions.fetchSignInMethodsForEmail(window.firebaseAuth, newEmail);
        console.log('  Sign-in methods returned:', signInMethods);
        
        // Only show error if we got actual sign-in methods (not empty array)
        if (signInMethods && Array.isArray(signInMethods) && signInMethods.length > 0) {
          emailInUse = true;
          console.warn('‚ùå Email is already in use (detected via sign-in methods)!');
          console.warn('  Sign-in methods found:', signInMethods);
        } else {
          console.log('  ‚úì No sign-in methods returned - email may be available (or Email Enumeration Protection is enabled)');
        }
      } catch (fetchError) {
        console.error('  ‚úó fetchSignInMethodsForEmail failed:', fetchError);
        // If fetchSignInMethodsForEmail fails, we can't determine email availability
        // Don't show error - allow user to proceed and Firebase will catch it
      }
      
      // If email is in use, show error and stop
      if (emailInUse) {
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        
        emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
        emailError.classList.add('show');
        newEmailInput.classList.add('error');
        newEmailInput.focus();
        isProcessingForm = false;
        return; // Stop here - password was verified, but email is in use
      }
      
      // If fetchSignInMethodsForEmail returned empty, proceed to email change
      // Password is already verified, so we can safely proceed
      console.log('‚úÖ Email check complete - email appears available');
      console.log('‚úÖ Password already verified - proceeding with email change');
      
    } catch (emailCheckError) {
      // Re-enable button if check fails
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      
      console.error('‚ùå Error during email availability check:', emailCheckError);
      // Continue - password is already verified, Firebase will catch email issues
      console.warn('‚ö†Ô∏è Could not verify email availability, but password is verified - proceeding');
    }
    
    // Password is verified and email check is complete - proceed with email change
    saveButton.disabled = true;
    saveButton.textContent = 'Saving...';
    
    // Password is verified and email check is complete - proceed with email change logic
    try {
      
      // Get the refreshed user object after password verification
      const refreshedUser = window.firebaseAuth.currentUser;
      if (!refreshedUser) {
        throw new Error('User session expired. Please log in again.');
      }
      
      // Double-check email verification status after password verification
      try {
        await refreshedUser.reload();
        console.log('Email verification status before update:', refreshedUser.emailVerified);
        if (!refreshedUser.emailVerified) {
          errorMessage.textContent = 'Your current email address (' + userEmail + ') must be verified before you can change it. Please verify your email first, then try again.';
          errorMessage.style.color = '#d32f2f';
          errorMessage.classList.add('show');
          saveButton.disabled = false;
          saveButton.textContent = 'Save';
          isProcessingForm = false;
          return;
        }
      } catch (reloadErr) {
        console.warn('Could not reload user after password verification:', reloadErr);
        // Continue but log the issue
      }
      
      // Use verifyBeforeUpdateEmail instead of updateEmail
      // This sends a verification email to the new address first
      console.log('Sending verification email to new address:', newEmail);
      
      // Build the correct URL for GitHub Pages - should point to a page that handles the verification
      // For email change verification, we need verify-email.html to handle it
      const currentPath = window.location.pathname;
      const pathParts = currentPath.split('/').filter(p => p);
      if (pathParts.length > 0) {
        pathParts[pathParts.length - 1] = 'verify-email.html';
      } else {
        pathParts.push('verify-email.html');
      }
      const continueUrl = window.location.origin + '/' + pathParts.join('/');
      
      console.log('Continue URL for email verification:', continueUrl);
      console.log('Full window location:', window.location.href);
      console.log('Origin:', window.location.origin);
      
      // Send verification email to new address
      // Check if function is available
      const verifyFunc = window.verifyBeforeUpdateEmailDirect || 
                        (window.firebaseAuthFunctions && window.firebaseAuthFunctions.verifyBeforeUpdateEmail);
      
      console.log('Checking verifyBeforeUpdateEmail availability:');
      console.log('- window.verifyBeforeUpdateEmailDirect:', typeof window.verifyBeforeUpdateEmailDirect);
      console.log('- window.firebaseAuthFunctions:', window.firebaseAuthFunctions);
      console.log('- window.firebaseAuthFunctions.verifyBeforeUpdateEmail:', typeof (window.firebaseAuthFunctions && window.firebaseAuthFunctions.verifyBeforeUpdateEmail));
      
      if (!verifyFunc) {
        const errorMsg = 'verifyBeforeUpdateEmail function is not available. Firebase SDK may not be fully loaded. Please refresh the page and try again.';
        console.error(errorMsg);
        errorMessage.textContent = errorMsg;
        errorMessage.style.color = '#d32f2f';
        errorMessage.classList.add('show');
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      console.log('Calling verifyBeforeUpdateEmail with:');
      console.log('- User:', refreshedUser.email);
      console.log('- New email:', newEmail);
      console.log('- Continue URL:', continueUrl);
      
      try {
        console.log('About to call verifyBeforeUpdateEmail...');
        console.log('Function type:', typeof verifyFunc);
        console.log('User object:', {
          uid: refreshedUser.uid,
          email: refreshedUser.email,
          emailVerified: refreshedUser.emailVerified
        });
        console.log('New email to check:', newEmail);
        
        const actionCodeSettings = {
          url: continueUrl,
          handleCodeInApp: false
        };
        console.log('Action code settings:', actionCodeSettings);
        
        // This is where Firebase will throw auth/email-already-in-use if the email exists
        console.log('‚ö†Ô∏è Calling verifyBeforeUpdateEmail - this will throw auth/email-already-in-use if email is in use');
        const result = await verifyFunc(refreshedUser, newEmail, actionCodeSettings);
        
        console.log('‚úì verifyBeforeUpdateEmail completed successfully - email should have been sent');
        console.log('Function return value:', result);
        console.log('Email sent to:', newEmail);
        console.log('Verification link will redirect to:', continueUrl);
        console.log('From email address: noreply@tardle-c0c26.firebaseapp.com');
        
        // Show success message - "Email has been changed"
        successMessage.textContent = 'Email has been changed';
        successMessage.style.color = '#2e7d32';
        successMessage.style.whiteSpace = 'pre-line';
        successMessage.classList.add('show');
        
        // Clear form
        document.getElementById('newEmail').value = '';
        document.getElementById('password').value = '';
        
        // Additional Gmail-specific troubleshooting (logged to console only)
        if (newEmail.toLowerCase().includes('@gmail.com')) {
          console.warn('‚ö†Ô∏è Gmail-specific troubleshooting:');
          console.warn('1. Search Gmail for: "noreply@tardle-c0c26.firebaseapp.com"');
          console.warn('2. Check: Spam, All Mail, Promotions, Social tabs');
          console.warn('3. Gmail may delay Firebase emails by 5-15 minutes');
          console.warn('4. Check Gmail Settings > Filters and Blocked Addresses');
        }
        
        // Also log warning about email templates
        console.warn('‚ö†Ô∏è IMPORTANT: If email not received, verify in Firebase Console:');
        console.warn('1. Go to Firebase Console > Authentication > Templates');
        console.warn('2. Find "Email address change" template');
        console.warn('3. Ensure it is ENABLED (not disabled)');
        console.warn('4. Also check: Authentication > Settings > Authorized domains includes "ganeshanushka.github.io"');
        console.warn('5. Check: Project Settings > Usage and billing for email quota limits');
      } catch (verifyError) {
        console.error('‚úó Error in verifyBeforeUpdateEmail:', verifyError);
        console.error('  Error code:', verifyError.code);
        console.error('  Error message:', verifyError.message);
        console.error('  Full error object:', verifyError);
        console.error('  Error keys:', Object.keys(verifyError));
        console.error('  Error stringified:', JSON.stringify(verifyError, null, 2));
        
        // Handle email-already-in-use immediately - check multiple possible error codes
        const errorCode = verifyError.code || '';
        const errorMessage = (verifyError.message || '').toLowerCase();
        const errorString = JSON.stringify(verifyError).toLowerCase();
        
        console.log('  Checking for email-already-in-use:');
        console.log('    errorCode:', errorCode);
        console.log('    errorMessage:', errorMessage);
        console.log('    errorString:', errorString);
        
        const isEmailInUse = errorCode === 'auth/email-already-in-use' || 
                            errorCode === 'auth/emailAlreadyInUse' ||
                            errorCode === 'auth/email-already-exists' ||
                            errorMessage.includes('email already in use') ||
                            errorMessage.includes('email already exists') ||
                            errorMessage.includes('already associated') ||
                            errorMessage.includes('email address is already') ||
                            errorString.includes('email already in use') ||
                            errorString.includes('email already exists');
        
        console.log('    isEmailInUse result:', isEmailInUse);
        
        if (isEmailInUse) {
          console.warn('  ‚Üí Email is already in use! Showing error message.');
          console.warn('  ‚Üí Error code:', errorCode);
          console.warn('  ‚Üí Error message:', verifyError.message);
          
          // Clear any password errors
          passwordError.classList.remove('show');
          passwordInput.classList.remove('error');
          passwordErrorText.textContent = '';
          
          // Show email error prominently
          emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
          emailError.classList.add('show');
          newEmailInput.classList.add('error');
          newEmailInput.focus();
          
          // Re-enable button
          saveButton.disabled = false;
          saveButton.textContent = 'Save';
          
          // Reset form processing flag
          isProcessingForm = false;
          
          return; // Don't re-throw, we've handled it
        } else {
          console.warn('  ‚Üí Email-already-in-use NOT detected. Error code:', errorCode);
          console.warn('  ‚Üí This might be a different error. Will re-throw to outer catch block.');
        }
        
        // If it's a specific error about the URL or domain, provide helpful message
        if (verifyError.message && (verifyError.message.includes('domain') || verifyError.message.includes('authorized'))) {
          errorMessage.textContent = 'Email change verification failed. The domain may not be authorized in Firebase Console. Please contact support or try again later. Error: ' + verifyError.message;
          errorMessage.style.color = '#d32f2f';
          errorMessage.classList.add('show');
          saveButton.disabled = false;
          saveButton.textContent = 'Save';
          return;
        }
        
        throw verifyError; // Re-throw other errors to be caught by outer catch block
      }
      
      // Form is already cleared in the success block above
      // Don't redirect immediately - let user read the message
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
    } // Close try block at line 978
    
    } catch (error) {
      console.error('Error changing email:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      
      // Clear previous error messages
      emailError.classList.remove('show');
      passwordError.classList.remove('show');
      errorMessage.classList.remove('show');
      newEmailInput.classList.remove('error');
      passwordInput.classList.remove('error');
      
      // Handle password-related errors
      if (error.code === 'auth/wrong-password' || 
          error.code === 'auth/invalid-credential' || 
          error.code === 'auth/invalid-login-credentials') {
        passwordErrorText.textContent = 'This password doesn\'t match our records.';
        passwordError.classList.add('show');
        passwordInput.classList.add('error');
        passwordInput.value = '';
        passwordInput.focus();
        return;
      }
      
      // Handle email-related errors - check multiple possible error codes
      const errorCode = error.code || '';
      const errorMessage = (error.message || '').toLowerCase();
      const isEmailInUse = errorCode === 'auth/email-already-in-use' || 
                          errorCode === 'auth/emailAlreadyInUse' ||
                          errorMessage.includes('email already in use') ||
                          errorMessage.includes('email already exists') ||
                          errorMessage.includes('already associated');
      
      if (isEmailInUse) {
        console.warn('‚ùå Caught email-already-in-use in outer catch block');
        console.warn('  ‚Üí Error code:', errorCode);
        console.warn('  ‚Üí Error message:', error.message);
        
        // Clear password error if it exists
        passwordError.classList.remove('show');
        passwordInput.classList.remove('error');
        passwordErrorText.textContent = '';
        
        // Show email error prominently
        emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
        emailError.classList.add('show');
        newEmailInput.classList.add('error');
        newEmailInput.focus();
        
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      if (error.code === 'auth/invalid-email') {
        emailErrorText.textContent = 'Please enter a valid email address.';
        emailError.classList.add('show');
        newEmailInput.classList.add('error');
        newEmailInput.focus();
        return;
      }
      
      if (error.code === 'auth/weak-password') {
        passwordErrorText.textContent = 'Password is too weak. Please use a stronger password.';
        passwordError.classList.add('show');
        passwordInput.classList.add('error');
        passwordInput.focus();
        return;
      }
      
      if (error.code === 'auth/requires-recent-login') {
        errorMessage.textContent = 'For security reasons, please log out and log back in, then try again.';
        errorMessage.classList.add('show');
        return;
      }
      
      if (error.code === 'auth/network-request-failed') {
        errorMessage.textContent = 'Network error. Please check your connection and try again.';
        errorMessage.classList.add('show');
        return;
      }
      
      if (error.code === 'auth/too-many-requests') {
        errorMessage.textContent = 'Too many verification email attempts. Please wait a few minutes before requesting another email, or check your spam folder for a previous email.';
        errorMessage.classList.add('show');
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      // Handle rate limiting or email sending errors specifically for verifyBeforeUpdateEmail
      if (error.code === 'auth/invalid-email' || error.code === 'auth/user-not-found') {
        emailErrorText.textContent = 'Invalid email address. Please check the email address and try again.';
        emailError.classList.add('show');
        newEmailInput.classList.add('error');
        newEmailInput.focus();
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      if (error.code === 'auth/user-disabled') {
        errorMessage.textContent = 'This account has been disabled. Please contact support.';
        errorMessage.classList.add('show');
        return;
      }
      
      if (error.code === 'auth/operation-not-allowed') {
        console.error('Operation not allowed - Full error:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        console.error('Full error object:', JSON.stringify(error, null, 2));
        
        // This error shouldn't occur with verifyBeforeUpdateEmail, but handle it just in case
        let errorMsg = 'Email change is not allowed. ';
        if (error.message && (error.message.includes('verify') || error.message.includes('verification'))) {
          // Even if current email is verified, Firebase requires NEW email verification
          errorMsg = 'Firebase security requires verifying the NEW email address before changing, even though your current email is verified. This prevents unauthorized email changes. Please try again - a verification email will be sent to ' + newEmail + '.';
        } else if (error.message) {
          // Use Firebase's error message if it's more specific
          errorMsg = error.message.replace('Firebase: ', '').replace(' (auth/operation-not-allowed)', '');
        } else {
          errorMsg += 'This may be due to account security settings. Please ensure your current email is verified, try logging out and back in, or contact support if the issue persists.';
        }
        
        errorMessage.textContent = errorMsg;
        errorMessage.style.color = '#d32f2f';
        errorMessage.classList.add('show');
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      // Generic error message - show more details for debugging
      let errorMsg = 'An error occurred while changing your email. Please try again.';
      if (error.code) {
        console.error('Unhandled error code:', error.code);
      }
      if (error.message) {
        errorMsg = error.message;
      }
      errorMessage.textContent = errorMsg;
      errorMessage.classList.add('show');
      
      // Clear password field
      passwordInput.value = '';
      passwordInput.focus();
    } finally {
      // Always reset the flag and re-enable button
      isProcessingForm = false;
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
    }
  });

  // Handle forgot password link
  document.getElementById('forgotPasswordLink').addEventListener('click', function(e) {
    e.preventDefault();
    // TODO: Implement forgot password functionality
    alert('Forgot password functionality coming soon!');
  });
</script>

</body>
</html>
