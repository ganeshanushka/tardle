<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Change email</title>
<style>
  body {
    font-family: 'PT Serif', sans-serif;
    background-color: white;
    margin: 0;
    padding: 0;
    color: #1a1a1a;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .container {
    max-width: 600px;
    width: 100%;
    margin: 0 auto;
    padding: 0 20px 60px 20px;
    box-sizing: border-box;
  }

  h1 {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #1a1a1a;
  }

  .intro-text {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 30px;
    color: #1a1a1a;
  }

  .intro-text strong {
    font-weight: bold;
  }

  .form-group {
    margin-bottom: 24px;
  }

  .form-group label {
    display: block;
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 8px;
    color: #1a1a1a;
  }

  .form-group input {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-family: 'PT Serif', sans-serif;
  }

  .form-group input:focus {
    outline: none;
    border-color: #7BAFD4;
  }

  .password-wrapper {
    position: relative;
    width: 100%;
  }

  .password-wrapper input {
    width: 100%;
    padding-right: 40px;
    box-sizing: border-box;
  }

  .password-toggle {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    margin: 0;
  }

  .password-toggle svg {
    width: 20px;
    height: 20px;
    stroke: #666;
  }

  .password-toggle:hover svg {
    stroke: #333;
  }

  .button-container {
    display: flex;
    gap: 15px;
    align-items: center;
    margin-top: 30px;
  }

  .save-button {
    background-color: #000;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'PT Serif', sans-serif;
    transition: background-color 0.2s ease;
  }

  .save-button:hover {
    background-color: #333;
  }

  .save-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .return-link {
    color: #333;
    text-decoration: underline;
    font-size: 16px;
  }

  .return-link:hover {
    color: #000;
  }

  .forgot-password-link {
    color: #333;
    text-decoration: underline;
    font-size: 16px;
    margin-left: auto;
  }

  .forgot-password-link:hover {
    color: #000;
  }

  .error-message {
    color: #d32f2f;
    font-size: 14px;
    margin-top: 10px;
    display: none;
    align-items: center;
    gap: 8px;
  }

  .error-message.show {
    display: flex;
  }

  .error-icon {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: #d32f2f;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .error-icon::before {
    content: '!';
    color: white;
    font-weight: bold;
    font-size: 12px;
  }

  .form-group .error-message {
    margin-top: 8px;
  }

  .form-group input.error {
    border-color: #d32f2f;
  }

  .password-error {
    margin-top: 8px;
  }

  .success-message {
    color: #2e7d32;
    font-size: 14px;
    margin-top: 10px;
    display: none;
  }

  .success-message.show {
    display: block;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Change email</h1>
  
  <div class="intro-text">
    You're currently logged in with <strong id="currentEmail">Loading...</strong>. By clicking "Save" below, you consent to continue receiving at your new email address any daily reminder emails and game updates we have been sending to your current email address, along with account updates, notifications and all other emails.
  </div>

  <form id="changeEmailForm" novalidate>
    <div class="form-group">
      <label for="newEmail">New email</label>
      <input type="email" id="newEmail" name="newEmail" placeholder="Enter email">
      <div class="error-message" id="emailError">
        <div class="error-icon"></div>
        <span id="emailErrorText"></span>
      </div>
    </div>

    <div class="form-group">
      <label for="password">Your password</label>
      <div class="password-wrapper">
        <input type="password" id="password" name="password" placeholder="Enter password">
        <button type="button" class="password-toggle" id="passwordToggle" aria-label="Toggle password visibility">
          <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>
      <div class="error-message password-error" id="passwordError">
        <div class="error-icon"></div>
        <span id="passwordErrorText">Please enter a password.</span>
      </div>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div class="button-container">
      <button type="submit" class="save-button" id="saveButton">Save</button>
      <a href="account-details.html" class="return-link">Return to account</a>
      <a href="#" class="forgot-password-link" id="forgotPasswordLink">Forgot password</a>
    </div>
  </form>
</div>

<!-- Firebase Config -->
<script type="module" src="firebase-config.js"></script>

<script type="module">
  // Import verifyBeforeUpdateEmail directly as fallback
  import { verifyBeforeUpdateEmail } from "https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js";
  // Make it available globally for non-module scripts
  window.verifyBeforeUpdateEmailDirect = verifyBeforeUpdateEmail;
  console.log('Direct import of verifyBeforeUpdateEmail:', typeof verifyBeforeUpdateEmail);
</script>

<script>
  // Get current user email and display it
  let currentUser = null;
  let userEmail = '';
  let username = '';
  let isProcessingForm = false; // Flag to prevent redirect during form submission

  // Wait for Firebase to load
  const checkFirebase = setInterval(() => {
    if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions && window.firebaseDb) {
      clearInterval(checkFirebase);
      
      // Update email immediately if user is already logged in
      const updateEmailDisplay = () => {
        const currentEmailEl = document.getElementById('currentEmail');
        if (currentEmailEl && window.firebaseAuth.currentUser) {
          const email = window.firebaseAuth.currentUser.email || '';
          currentEmailEl.textContent = email;
          userEmail = email;
          currentUser = window.firebaseAuth.currentUser;
        }
      };
      
      // Try to update immediately
      updateEmailDisplay();
      
      // Set up listener for auth state changes
      window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
          currentUser = user;
          userEmail = user.email || '';
          const currentEmailEl = document.getElementById('currentEmail');
          if (currentEmailEl) {
            currentEmailEl.textContent = userEmail;
          }
          
        } else {
          // User is not logged in - redirect to login
          // But don't redirect if we're currently processing the form (might be temporary)
          if (!isProcessingForm) {
            console.log('‚ö†Ô∏è Auth state changed: user logged out, redirecting...');
            window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
          } else {
            console.log('‚ö†Ô∏è User logged out during form processing - will handle in form handler');
          }
        }
      });
      
      // Also try updating after a short delay in case auth state hasn't been restored yet
      setTimeout(updateEmailDisplay, 500);
      
      // Wait for Firebase to restore the session
      setTimeout(() => {
        if (!window.firebaseAuth.currentUser) {
          window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
        } else {
          // Update email one more time after session is restored
          updateEmailDisplay();
        }
      }, 1500);
    }
  }, 100);

  // Handle form submission
  // Toggle password visibility
  const passwordInput = document.getElementById('password');
  const passwordToggle = document.getElementById('passwordToggle');
  const eyeIcon = document.getElementById('eyeIcon');
  
  if (passwordToggle && eyeIcon) {
    passwordToggle.addEventListener('click', function() {
      const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
      passwordInput.setAttribute('type', type);
      
      // Update icon based on visibility
      if (type === 'text') {
        // Show eye with slash (hidden)
        eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
      } else {
        // Show normal eye (visible)
        eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
      }
    });
  }
  
  // Check email availability in real-time when user enters email
  let emailCheckTimeout = null;
  const newEmailInput = document.getElementById('newEmail');
  const emailError = document.getElementById('emailError');
  const emailErrorText = document.getElementById('emailErrorText');
  
  // Function to check if email is already in use
  const checkEmailAvailability = async function(email) {
    // Basic validation first
    if (!email || !email.trim()) {
      emailError.classList.remove('show');
      newEmailInput.classList.remove('error');
      return;
    }
    
    const trimmedEmail = email.trim();
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(trimmedEmail)) {
      // Don't check invalid emails
      return;
    }
    
    // Check if it's the same as current email
    if (currentUser && currentUser.email && trimmedEmail.toLowerCase() === currentUser.email.toLowerCase()) {
      emailErrorText.textContent = 'The email address you entered is already associated with this account. Please enter a different email address.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      return;
    }
    
    // Wait for Firebase to be ready
    if (!window.firebaseAuth || !window.firebaseAuthFunctions) {
      return;
    }
    
    // Check if email is already in use using multiple methods
    try {
      console.log('üîç Checking email availability:', trimmedEmail);
      
      // Method 1: Try fetchSignInMethodsForEmail (works if Email Enumeration Protection is disabled)
      let signInMethods = [];
      try {
        signInMethods = await window.firebaseAuthFunctions.fetchSignInMethodsForEmail(window.firebaseAuth, trimmedEmail);
        console.log('  Sign-in methods returned:', signInMethods);
        
        // If we got sign-in methods, email is definitely in use
        if (signInMethods && Array.isArray(signInMethods) && signInMethods.length > 0) {
          console.warn('‚ùå Email is already in use (detected via sign-in methods)!');
          emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
          emailError.classList.add('show');
          newEmailInput.classList.add('error');
          return;
        }
      } catch (fetchError) {
        console.log('  fetchSignInMethodsForEmail failed:', fetchError);
      }
      
      // Method 2: Try createUserWithEmailAndPassword with dummy password
      // This will throw auth/email-already-in-use if the email exists
      // IMPORTANT: This will log out the current user if email doesn't exist, so we need to restore session
      const originalUser = window.firebaseAuth.currentUser;
      const originalUserEmail = originalUser ? originalUser.email : null;
      
      try {
        const dummyPassword = 'DummyCheck123!@#Temp' + Date.now();
        const createdUser = await window.firebaseAuthFunctions.createUserWithEmailAndPassword(
          window.firebaseAuth, 
          trimmedEmail, 
          dummyPassword
        );
        
        // If we get here, account was created (email didn't exist)
        console.log('  ‚úì Email is available (account created during check - will delete and restore session)');
        
        // Delete the account we just created
        if (createdUser && createdUser.user) {
          try {
            await createdUser.user.delete();
            console.log('  ‚úì Deleted test account');
          } catch (deleteError) {
            console.error('  ‚úó Failed to delete test account:', deleteError);
          }
        }
        
        // Email is available - clear any errors
        emailError.classList.remove('show');
        newEmailInput.classList.remove('error');
        
        // Note: User is now logged out. We can't automatically restore the session
        // without their password, so we'll just note this in console
        console.warn('  ‚ö†Ô∏è User session was logged out during check. User will need to log back in.');
        
      } catch (createError) {
        const errorCode = createError.code || '';
        const errorMessage = (createError.message || '').toLowerCase();
        
        // Check if email is already in use
        if (errorCode === 'auth/email-already-in-use' || 
            errorCode === 'auth/emailAlreadyInUse' ||
            errorMessage.includes('email already in use') ||
            errorMessage.includes('email already exists') ||
            errorMessage.includes('already associated')) {
          // Email is already in use!
          console.warn('‚ùå Email is already in use (detected via createUserWithEmailAndPassword)!');
          emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
          emailError.classList.add('show');
          newEmailInput.classList.add('error');
          
          // User is still logged in (createUserWithEmailAndPassword failed, so didn't log them out)
          return;
        } else {
          // Some other error - email might be available, but we can't be sure
          console.log('  ‚ö†Ô∏è Could not determine email availability (error: ' + errorCode + ')');
          // Clear error - we'll catch it during form submission
          emailError.classList.remove('show');
          newEmailInput.classList.remove('error');
        }
      }
      
    } catch (checkError) {
      console.error('Error checking email:', checkError);
      // Don't show error if check fails - we'll catch it during form submission
      emailError.classList.remove('show');
      newEmailInput.classList.remove('error');
    }
  };
  
  if (newEmailInput) {
    // Check when user leaves the email field
    newEmailInput.addEventListener('blur', async function() {
      const email = newEmailInput.value;
      await checkEmailAvailability(email);
    });
    
    // Also check on input with debounce (after user stops typing for 1 second)
    newEmailInput.addEventListener('input', function() {
      // Clear previous timeout
      if (emailCheckTimeout) {
        clearTimeout(emailCheckTimeout);
      }
      
      // Clear error when user starts typing
      emailError.classList.remove('show');
      newEmailInput.classList.remove('error');
      
      const email = newEmailInput.value;
      
      // Debounce: wait 1 second after user stops typing
      emailCheckTimeout = setTimeout(() => {
        checkEmailAvailability(email);
      }, 1000);
    });
  }

  document.getElementById('changeEmailForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Set flag to prevent auth state change redirect during form processing
    isProcessingForm = true;
    
    try {
      // Check if user is still logged in before proceeding
      if (!window.firebaseAuth || !window.firebaseAuth.currentUser) {
        console.warn('‚ö†Ô∏è User is not logged in, redirecting to login...');
        isProcessingForm = false;
        window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
        return;
      }
      
      const newEmail = document.getElementById('newEmail').value.trim();
      const password = document.getElementById('password').value;
    const errorMessage = document.getElementById('errorMessage');
    const emailError = document.getElementById('emailError');
    const emailErrorText = document.getElementById('emailErrorText');
    const passwordError = document.getElementById('passwordError');
    const passwordErrorText = document.getElementById('passwordErrorText');
    const successMessage = document.getElementById('successMessage');
    const saveButton = document.getElementById('saveButton');
    const newEmailInput = document.getElementById('newEmail');
    const passwordInput = document.getElementById('password');
    
    // Clear previous messages
    errorMessage.classList.remove('show');
    emailError.classList.remove('show');
    passwordError.classList.remove('show');
    successMessage.classList.remove('show');
    newEmailInput.classList.remove('error');
    passwordInput.classList.remove('error');
    // Clear error text content
    emailErrorText.textContent = '';
    passwordErrorText.textContent = '';
    
    // Get current user fresh from Firebase
    const currentUser = window.firebaseAuth.currentUser;
    if (!currentUser) {
      console.warn('‚ö†Ô∏è No current user found, redirecting to login...');
      window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
      return;
    }
    
    const userEmail = currentUser.email || '';
    
    // Check if current email is verified (reload first to get latest status)
    try {
      await currentUser.reload(); // Get latest verification status
      console.log('Current email verification status:', currentUser.emailVerified);
    } catch (reloadError) {
      console.warn('Could not reload user, using cached status:', reloadError);
    }
    
    if (!currentUser.emailVerified) {
      console.log('Current email not verified. Attempting to send verification email to:', userEmail);
      try {
        // Build the correct URL for GitHub Pages
        const currentPath = window.location.pathname;
        const pathParts = currentPath.split('/').filter(p => p);
        if (pathParts.length > 0) {
          pathParts[pathParts.length - 1] = 'account-details.html';
        } else {
          pathParts.push('account-details.html');
        }
        const continueUrl = window.location.origin + '/' + pathParts.join('/');
        
        // Send verification email
        await window.firebaseAuthFunctions.sendEmailVerification(currentUser, {
          url: continueUrl,
          handleCodeInApp: false
        });
        console.log('Verification email sent successfully');
        errorMessage.textContent = 'Please verify your current email address (' + userEmail + ') before changing it. A verification email has been sent. Check your inbox (and spam folder) and click the verification link, then refresh this page and try again.';
        errorMessage.style.color = '#2e7d32'; // Green color for success message
      } catch (verifyError) {
        console.error('Error sending verification email:', verifyError);
        console.error('Error code:', verifyError.code);
        console.error('Error message:', verifyError.message);
        
        let errorMsg = 'Please verify your current email address (' + userEmail + ') before changing it. ';
        if (verifyError.code === 'auth/too-many-requests') {
          errorMsg += 'Too many verification emails sent. Please wait a few minutes and try again, or check your inbox for a previous verification email.';
        } else if (verifyError.message) {
          errorMsg += 'Unable to send verification email: ' + verifyError.message + '. Please check your inbox for a previous verification email, or contact support.';
        } else {
          errorMsg += 'We were unable to send a verification email. Please check your inbox for a previous verification email, or contact support.';
        }
        errorMessage.textContent = errorMsg;
        errorMessage.style.color = '#d32f2f'; // Red color for error
      }
      errorMessage.classList.add('show');
      return;
    }
    
    // Double-check user is still logged in before email check
    if (!window.firebaseAuth.currentUser) {
      console.warn('‚ö†Ô∏è User logged out during validation, redirecting...');
      window.location.href = 'login.html?return=' + encodeURIComponent('change-email.html');
      return;
    }
    
    // Check if email is missing
    if (!newEmail || newEmail.trim() === '') {
      emailErrorText.textContent = 'Please enter a new email address.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      newEmailInput.focus();
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(newEmail)) {
      emailErrorText.textContent = 'Please enter a valid email address.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      newEmailInput.focus();
      return;
    }
    
    // Check email length (NYT standard: 64 characters max)
    if (newEmail.length > 64) {
      emailErrorText.textContent = 'Email address is too long. Please enter an email address that is 64 characters or less.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      newEmailInput.focus();
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      return;
    }
    
    // Check if new email is the same as current email
    if (newEmail.toLowerCase() === userEmail.toLowerCase()) {
      emailErrorText.textContent = 'The email address you entered is already associated with this account. Please enter a different email address.';
      emailError.classList.add('show');
      newEmailInput.classList.add('error');
      newEmailInput.focus();
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      return;
    }
    
    // Check if email is already in use by another account
    // This check happens BEFORE password validation to catch the error immediately
    try {
      console.log('üîç Checking if email is already in use...');
      console.log('  New email:', newEmail);
      console.log('  Current user email:', userEmail);
      
      // Disable button while checking
      saveButton.disabled = true;
      saveButton.textContent = 'Checking email...';
      
      // Clear any previous errors
      emailError.classList.remove('show');
      passwordError.classList.remove('show');
      newEmailInput.classList.remove('error');
      passwordInput.classList.remove('error');
      emailErrorText.textContent = '';
      passwordErrorText.textContent = '';
      
      // Try fetchSignInMethodsForEmail - only reliable if it returns methods
      // (If Email Enumeration Protection is enabled, it may return empty array even if email exists)
      let signInMethods = [];
      try {
        signInMethods = await window.firebaseAuthFunctions.fetchSignInMethodsForEmail(window.firebaseAuth, newEmail);
        console.log('  Sign-in methods returned:', signInMethods);
      } catch (fetchError) {
        console.log('  fetchSignInMethodsForEmail failed:', fetchError);
        // If fetchSignInMethodsForEmail fails, we'll rely on Firebase's error during verifyBeforeUpdateEmail
      }
      
      // If we got sign-in methods, email is definitely in use
      if (signInMethods && Array.isArray(signInMethods) && signInMethods.length > 0) {
        console.warn('‚ùå Email is already in use (detected via sign-in methods)!');
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        
        emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
        emailError.classList.add('show');
        newEmailInput.classList.add('error');
        newEmailInput.focus();
        return; // Stop here - don't proceed with password validation
      }
      
      // If signInMethods is empty, we can't tell if email exists due to Email Enumeration Protection
      // We'll proceed and let Firebase catch it when we try to change the email
      // Firebase's verifyBeforeUpdateEmail will throw auth/email-already-in-use if the email is in use
      console.log('‚ö†Ô∏è Email Enumeration Protection may be enabled - cannot pre-check email availability');
      console.log('  Will rely on Firebase error when attempting email change');
      
      // Re-enable button after check
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      console.log('‚úÖ Email pre-check complete - proceeding to password validation');
      
    } catch (emailCheckError) {
      // Re-enable button if check fails
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      
      console.error('‚ùå Error during email availability check:', emailCheckError);
      console.error('  Error code:', emailCheckError.code);
      console.error('  Error message:', emailCheckError.message);
      // Continue - Firebase will catch it when we try to update
      console.warn('‚ö†Ô∏è Could not verify email availability, will let Firebase handle it');
    }
    
    // Check if password is missing (after email validation to prioritize email errors)
    if (!password || password.trim() === '') {
      console.log('‚ö†Ô∏è Password is empty, showing error and stopping');
      passwordErrorText.textContent = 'Please enter a password.';
      passwordError.classList.add('show');
      passwordInput.classList.add('error');
      passwordInput.focus();
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      isProcessingForm = false; // Reset flag before returning
      return;
    }
    
    // Disable button and show loading state
    saveButton.disabled = true;
    saveButton.textContent = 'Saving...';
    
    try {
      // Re-authenticate user first - this will throw an error if password is wrong
      console.log('Re-authenticating user with provided password...');
      const credential = window.firebaseAuthFunctions.EmailAuthProvider.credential(
        currentUser.email,
        password
      );
      
      try {
        await window.firebaseAuthFunctions.reauthenticateWithCredential(currentUser, credential);
        console.log('‚úì Re-authentication successful');
      } catch (reauthError) {
        console.error('‚úó Re-authentication failed:', reauthError);
        console.error('  Error code:', reauthError.code);
        console.error('  Error message:', reauthError.message);
        
        // Handle password-related errors
        if (reauthError.code === 'auth/wrong-password' || 
            reauthError.code === 'auth/invalid-credential' || 
            reauthError.code === 'auth/invalid-login-credentials') {
          passwordErrorText.textContent = 'Incorrect password. Please enter the correct password for this account.';
          passwordError.classList.add('show');
          passwordInput.classList.add('error');
          passwordInput.value = '';
          passwordInput.focus();
          saveButton.disabled = false;
          saveButton.textContent = 'Save';
          return;
        }
        
        // Re-throw other errors to be handled by outer catch
        throw reauthError;
      }
      
      // Get the refreshed user object after re-authentication
      const refreshedUser = window.firebaseAuth.currentUser;
      if (!refreshedUser) {
        throw new Error('User session expired. Please log in again.');
      }
      
      // Double-check email verification status after re-authentication
      try {
        await refreshedUser.reload();
        console.log('Email verification status before update:', refreshedUser.emailVerified);
        if (!refreshedUser.emailVerified) {
          errorMessage.textContent = 'Your current email address (' + userEmail + ') must be verified before you can change it. Please verify your email first, then try again.';
          errorMessage.style.color = '#d32f2f';
          errorMessage.classList.add('show');
          saveButton.disabled = false;
          saveButton.textContent = 'Save';
          return;
        }
      } catch (reloadErr) {
        console.warn('Could not reload user after re-authentication:', reloadErr);
        // Continue but log the issue
      }
      
      // Use verifyBeforeUpdateEmail instead of updateEmail
      // This sends a verification email to the new address first
      console.log('Sending verification email to new address:', newEmail);
      
      // Build the correct URL for GitHub Pages - should point to a page that handles the verification
      // For email change verification, we need verify-email.html to handle it
      const currentPath = window.location.pathname;
      const pathParts = currentPath.split('/').filter(p => p);
      if (pathParts.length > 0) {
        pathParts[pathParts.length - 1] = 'verify-email.html';
      } else {
        pathParts.push('verify-email.html');
      }
      const continueUrl = window.location.origin + '/' + pathParts.join('/');
      
      console.log('Continue URL for email verification:', continueUrl);
      console.log('Full window location:', window.location.href);
      console.log('Origin:', window.location.origin);
      
      // Send verification email to new address
      // Check if function is available
      const verifyFunc = window.verifyBeforeUpdateEmailDirect || 
                        (window.firebaseAuthFunctions && window.firebaseAuthFunctions.verifyBeforeUpdateEmail);
      
      console.log('Checking verifyBeforeUpdateEmail availability:');
      console.log('- window.verifyBeforeUpdateEmailDirect:', typeof window.verifyBeforeUpdateEmailDirect);
      console.log('- window.firebaseAuthFunctions:', window.firebaseAuthFunctions);
      console.log('- window.firebaseAuthFunctions.verifyBeforeUpdateEmail:', typeof (window.firebaseAuthFunctions && window.firebaseAuthFunctions.verifyBeforeUpdateEmail));
      
      if (!verifyFunc) {
        const errorMsg = 'verifyBeforeUpdateEmail function is not available. Firebase SDK may not be fully loaded. Please refresh the page and try again.';
        console.error(errorMsg);
        errorMessage.textContent = errorMsg;
        errorMessage.style.color = '#d32f2f';
        errorMessage.classList.add('show');
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      console.log('Calling verifyBeforeUpdateEmail with:');
      console.log('- User:', refreshedUser.email);
      console.log('- New email:', newEmail);
      console.log('- Continue URL:', continueUrl);
      
      try {
        console.log('About to call verifyBeforeUpdateEmail...');
        console.log('Function type:', typeof verifyFunc);
        console.log('User object:', {
          uid: refreshedUser.uid,
          email: refreshedUser.email,
          emailVerified: refreshedUser.emailVerified
        });
        console.log('New email to check:', newEmail);
        
        const actionCodeSettings = {
          url: continueUrl,
          handleCodeInApp: false
        };
        console.log('Action code settings:', actionCodeSettings);
        
        // This is where Firebase will throw auth/email-already-in-use if the email exists
        console.log('‚ö†Ô∏è Calling verifyBeforeUpdateEmail - this will throw auth/email-already-in-use if email is in use');
        const result = await verifyFunc(refreshedUser, newEmail, actionCodeSettings);
        
        console.log('‚úì verifyBeforeUpdateEmail completed successfully - email should have been sent');
        console.log('Function return value:', result);
        console.log('Email sent to:', newEmail);
        console.log('Verification link will redirect to:', continueUrl);
        console.log('From email address: noreply@tardle-c0c26.firebaseapp.com');
        
        // Additional Gmail-specific troubleshooting
        if (newEmail.toLowerCase().includes('@gmail.com')) {
          console.warn('‚ö†Ô∏è Gmail-specific troubleshooting:');
          console.warn('1. Search Gmail for: "noreply@tardle-c0c26.firebaseapp.com"');
          console.warn('2. Check: Spam, All Mail, Promotions, Social tabs');
          console.warn('3. Gmail may delay Firebase emails by 5-15 minutes');
          console.warn('4. Check Gmail Settings > Filters and Blocked Addresses');
        }
        
        // Show success message - email will be updated after user verifies
        const isGmail = newEmail.toLowerCase().includes('@gmail.com');
        const successMsg = 'Verification emails have been sent:\n\n' +
          '‚úì Check ' + newEmail + ' for the verification link\n' +
          '  ‚Üí Check SPAM folder thoroughly (Gmail often filters Firebase emails)\n' +
          '  ‚Üí Check "All Mail" and "Promotions" tabs in Gmail\n' +
          '  ‚Üí Search for "noreply@tardle-c0c26.firebaseapp.com" in Gmail\n' +
          '‚úì Check ' + userEmail + ' for a notification about the change\n\n' +
          '‚ö†Ô∏è If you still don\'t see the email in ' + newEmail + ':\n' +
          (isGmail ? '‚Ä¢ Gmail may be blocking Firebase emails - try a different email provider\n' : '') +
          '‚Ä¢ Wait 5-10 minutes (Gmail filtering can delay delivery)\n' +
          '‚Ä¢ Check Gmail\'s "Blocked senders" list\n' +
          '‚Ä¢ Try requesting another email after 10 minutes\n' +
          '‚Ä¢ Contact support if the issue persists';
        
        successMessage.textContent = successMsg;
        successMessage.style.color = '#2e7d32';
        successMessage.style.whiteSpace = 'pre-line'; // Allow line breaks
        successMessage.classList.add('show');
        
        // Also log warning about email templates
        console.warn('‚ö†Ô∏è IMPORTANT: If email not received, verify in Firebase Console:');
        console.warn('1. Go to Firebase Console > Authentication > Templates');
        console.warn('2. Find "Email address change" template');
        console.warn('3. Ensure it is ENABLED (not disabled)');
        console.warn('4. Also check: Authentication > Settings > Authorized domains includes "ganeshanushka.github.io"');
        console.warn('5. Check: Project Settings > Usage and billing for email quota limits');
      } catch (verifyError) {
        console.error('‚úó Error in verifyBeforeUpdateEmail:', verifyError);
        console.error('  Error code:', verifyError.code);
        console.error('  Error message:', verifyError.message);
        console.error('  Full error:', verifyError);
        
        // Handle email-already-in-use immediately - check multiple possible error codes
        const errorCode = verifyError.code || '';
        const errorMessage = (verifyError.message || '').toLowerCase();
        const isEmailInUse = errorCode === 'auth/email-already-in-use' || 
                            errorCode === 'auth/emailAlreadyInUse' ||
                            errorMessage.includes('email already in use') ||
                            errorMessage.includes('email already exists') ||
                            errorMessage.includes('already associated');
        
        if (isEmailInUse) {
          console.warn('  ‚Üí Email is already in use! Showing error message.');
          console.warn('  ‚Üí Error code:', errorCode);
          console.warn('  ‚Üí Error message:', verifyError.message);
          
          // Clear any password errors
          passwordError.classList.remove('show');
          passwordInput.classList.remove('error');
          passwordErrorText.textContent = '';
          
          // Show email error prominently
          emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
          emailError.classList.add('show');
          newEmailInput.classList.add('error');
          newEmailInput.focus();
          
          // Re-enable button
          saveButton.disabled = false;
          saveButton.textContent = 'Save';
          
          // Reset form processing flag
          isProcessingForm = false;
          
          return; // Don't re-throw, we've handled it
        }
        
        // If it's a specific error about the URL or domain, provide helpful message
        if (verifyError.message && (verifyError.message.includes('domain') || verifyError.message.includes('authorized'))) {
          errorMessage.textContent = 'Email change verification failed. The domain may not be authorized in Firebase Console. Please contact support or try again later. Error: ' + verifyError.message;
          errorMessage.style.color = '#d32f2f';
          errorMessage.classList.add('show');
          saveButton.disabled = false;
          saveButton.textContent = 'Save';
          return;
        }
        
        throw verifyError; // Re-throw other errors to be caught by outer catch block
      }
      
      // Clear form
      document.getElementById('newEmail').value = '';
      document.getElementById('password').value = '';
      
      // Don't redirect immediately - let user read the message
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
      
    } catch (error) { // This catch is for the try block starting at line 564
      console.error('Error changing email:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      
      // Clear previous error messages
      emailError.classList.remove('show');
      passwordError.classList.remove('show');
      errorMessage.classList.remove('show');
      newEmailInput.classList.remove('error');
      passwordInput.classList.remove('error');
      
      // Handle password-related errors
      if (error.code === 'auth/wrong-password' || 
          error.code === 'auth/invalid-credential' || 
          error.code === 'auth/invalid-login-credentials') {
        passwordErrorText.textContent = 'This password doesn\'t match our records.';
        passwordError.classList.add('show');
        passwordInput.classList.add('error');
        passwordInput.value = '';
        passwordInput.focus();
        return;
      }
      
      // Handle email-related errors - check multiple possible error codes
      const errorCode = error.code || '';
      const errorMessage = (error.message || '').toLowerCase();
      const isEmailInUse = errorCode === 'auth/email-already-in-use' || 
                          errorCode === 'auth/emailAlreadyInUse' ||
                          errorMessage.includes('email already in use') ||
                          errorMessage.includes('email already exists') ||
                          errorMessage.includes('already associated');
      
      if (isEmailInUse) {
        console.warn('‚ùå Caught email-already-in-use in outer catch block');
        console.warn('  ‚Üí Error code:', errorCode);
        console.warn('  ‚Üí Error message:', error.message);
        
        // Clear password error if it exists
        passwordError.classList.remove('show');
        passwordInput.classList.remove('error');
        passwordErrorText.textContent = '';
        
        // Show email error prominently
        emailErrorText.textContent = 'This email address is already associated with another account. Please use a different email address or sign in with that account instead.';
        emailError.classList.add('show');
        newEmailInput.classList.add('error');
        newEmailInput.focus();
        
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      if (error.code === 'auth/invalid-email') {
        emailErrorText.textContent = 'Please enter a valid email address.';
        emailError.classList.add('show');
        newEmailInput.classList.add('error');
        newEmailInput.focus();
        return;
      }
      
      if (error.code === 'auth/weak-password') {
        passwordErrorText.textContent = 'Password is too weak. Please use a stronger password.';
        passwordError.classList.add('show');
        passwordInput.classList.add('error');
        passwordInput.focus();
        return;
      }
      
      if (error.code === 'auth/requires-recent-login') {
        errorMessage.textContent = 'For security reasons, please log out and log back in, then try again.';
        errorMessage.classList.add('show');
        return;
      }
      
      if (error.code === 'auth/network-request-failed') {
        errorMessage.textContent = 'Network error. Please check your connection and try again.';
        errorMessage.classList.add('show');
        return;
      }
      
      if (error.code === 'auth/too-many-requests') {
        errorMessage.textContent = 'Too many verification email attempts. Please wait a few minutes before requesting another email, or check your spam folder for a previous email.';
        errorMessage.classList.add('show');
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      // Handle rate limiting or email sending errors specifically for verifyBeforeUpdateEmail
      if (error.code === 'auth/invalid-email' || error.code === 'auth/user-not-found') {
        emailErrorText.textContent = 'Invalid email address. Please check the email address and try again.';
        emailError.classList.add('show');
        newEmailInput.classList.add('error');
        newEmailInput.focus();
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      if (error.code === 'auth/user-disabled') {
        errorMessage.textContent = 'This account has been disabled. Please contact support.';
        errorMessage.classList.add('show');
        return;
      }
      
      if (error.code === 'auth/operation-not-allowed') {
        console.error('Operation not allowed - Full error:', error);
        console.error('Error code:', error.code);
        console.error('Error message:', error.message);
        console.error('Full error object:', JSON.stringify(error, null, 2));
        
        // This error shouldn't occur with verifyBeforeUpdateEmail, but handle it just in case
        let errorMsg = 'Email change is not allowed. ';
        if (error.message && (error.message.includes('verify') || error.message.includes('verification'))) {
          // Even if current email is verified, Firebase requires NEW email verification
          errorMsg = 'Firebase security requires verifying the NEW email address before changing, even though your current email is verified. This prevents unauthorized email changes. Please try again - a verification email will be sent to ' + newEmail + '.';
        } else if (error.message) {
          // Use Firebase's error message if it's more specific
          errorMsg = error.message.replace('Firebase: ', '').replace(' (auth/operation-not-allowed)', '');
        } else {
          errorMsg += 'This may be due to account security settings. Please ensure your current email is verified, try logging out and back in, or contact support if the issue persists.';
        }
        
        errorMessage.textContent = errorMsg;
        errorMessage.style.color = '#d32f2f';
        errorMessage.classList.add('show');
        saveButton.disabled = false;
        saveButton.textContent = 'Save';
        return;
      }
      
      // Generic error message - show more details for debugging
      let errorMsg = 'An error occurred while changing your email. Please try again.';
      if (error.code) {
        console.error('Unhandled error code:', error.code);
      }
      if (error.message) {
        errorMsg = error.message;
      }
      errorMessage.textContent = errorMsg;
      errorMessage.classList.add('show');
      
      // Clear password field
      passwordInput.value = '';
      passwordInput.focus();
    } // End of catch block for try at line 564
    } finally {
      // Always reset the flag and re-enable button for outer try at line 343
      isProcessingForm = false;
      saveButton.disabled = false;
      saveButton.textContent = 'Save';
    }
  });

  // Handle forgot password link
  document.getElementById('forgotPasswordLink').addEventListener('click', function(e) {
    e.preventDefault();
    // TODO: Implement forgot password functionality
    alert('Forgot password functionality coming soon!');
  });
</script>

</body>
</html>
