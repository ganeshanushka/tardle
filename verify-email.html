<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verify Email - Tar.dle</title>
<style>
  /* Field Gothic Narrow Font Face */
  @font-face {
    font-family: 'Field Gothic Narrow';
    src: url('fonts/FieldGothicNarrow-Regular.woff2') format('woff2'),
         url('fonts/FieldGothicNarrow-Regular.woff') format('woff');
    font-weight: normal;
    font-style: normal;
    font-display: swap;
  }
  
  @font-face {
    font-family: 'Field Gothic Narrow';
    src: url('fonts/FieldGothicNarrow-Bold.woff2') format('woff2'),
         url('fonts/FieldGothicNarrow-Bold.woff') format('woff');
    font-weight: bold;
    font-style: normal;
    font-display: swap;
  }

  /* Ensure headings use bold */
  h1, h2, h3, h4, h5, h6 {
    font-weight: bold;
  }
  
  /* Ensure body/content uses regular */
  body {
    font-weight: normal;
  }


  body {
    font-family: 'Field Gothic Narrow', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    background-color: #7BAFD4;
  }

  .verify-container {
    background-color: white;
    margin: auto;
    padding: 40px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 500px;
    max-width: 90%;
    text-align: center;
  }

  h1 {
    font-size: 32px;
    margin-bottom: 10px;
    color: #1a1a1a;
  }

  .subtitle {
    font-size: 16px;
    color: #666;
    margin-bottom: 30px;
  }

  .email-display {
    font-weight: bold;
    color: #001A57;
    margin-bottom: 10px;
    font-size: 18px;
  }
  
  .verification-status {
    font-size: 16px;
    margin-bottom: 30px;
    font-weight: 500;
  }
  
  .verification-status.verified {
    color: #2e7d32;
  }
  
  .verification-status.not-verified {
    color: #d32f2f;
  }

  .instructions {
    margin-bottom: 30px;
    color: #666;
    line-height: 1.6;
  }

  .instructions p {
    margin: 10px 0;
  }

  .note {
    font-size: 14px;
    color: #999;
    font-style: italic;
  }

  .error-message {
    color: red;
    font-size: 0.9rem;
    margin-top: 0.25em;
    margin-bottom: 1em;
    display: none;
    font-family: 'Field Gothic Narrow', sans-serif;
  }

  .error-message.show {
    display: block;
  }

  .success-message {
    color: #2e7d32;
    font-size: 16px;
    margin-top: 20px;
    margin-bottom: 20px;
    min-height: 20px;
    display: none;
    font-weight: 500;
    text-align: center;
    padding: 15px;
    background-color: #e8f5e9;
    border-radius: 4px;
    border-left: 4px solid #2e7d32;
  }

  .success-message.show {
    display: block;
  }
  
  .success-message.processing {
    color: #1976d2;
    background-color: #e3f2fd;
    border-left-color: #1976d2;
  }


  .resend-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }

  .resend-button {
    background-color: #7BAFD4;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Field Gothic Narrow', sans-serif;
    width: 100%;
    transition: background-color 0.2s ease;
    -webkit-user-select: none;
    user-select: none;
    pointer-events: auto;
    -webkit-tap-highlight-color: transparent;
    -webkit-appearance: none;
    appearance: none;
  }

  .resend-button:hover {
    background-color: #6a9fc0;
  }

  .resend-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .resend-timer {
    color: #666;
    font-size: 14px;
    margin-top: 10px;
  }

  .back-link-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }

  .back-link {
    color: #7BAFD4;
    text-decoration: none;
    font-size: 14px;
    -webkit-user-select: none;
    user-select: none;
    pointer-events: auto;
    -webkit-tap-highlight-color: transparent;
  }

  .back-link:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<div class="verify-container">
  <h1>Verify your email</h1>
  <p class="subtitle">We've sent a verification email to</p>
  <div class="email-display" id="emailDisplay">Loading...</div>
  <div class="verification-status" id="verificationStatus" style="display: none;"></div>
  
  <div class="instructions">
    <p>Please check your inbox and click the verification link in the email we sent you.</p>
    <p class="note">If you don't see the email, check your spam folder.</p>
  </div>
  
  <div class="error-message" id="errorMessage"></div>
  <div class="success-message" id="successMessage"></div>
  
  <div class="resend-section">
    <button type="button" class="resend-button" id="resendButton">Resend verification email</button>
    <div class="resend-timer" id="resendTimer"></div>
  </div>
  
  <div class="back-link-section">
    <a href="index.html" class="back-link" id="backToHomepageLink">‚Üê Back to homepage</a>
  </div>
</div>

<!-- Firebase Config -->
<script type="module" src="firebase-config.js"></script>

<script>
  // Suppress 404 errors for Firebase hosting files that don't exist on GitHub Pages
  // These errors are harmless and don't affect functionality
  const originalError = console.error;
  console.error = function(...args) {
    const message = args.join(' ');
    if (message.includes('__/firebase/init.json') && message.includes('404')) {
      // Silently ignore this specific error - it's expected on GitHub Pages
      return;
    }
    originalError.apply(console, args);
  };
  
  window.addEventListener('error', (event) => {
    if (event.target && event.target.src && event.target.src.includes('__/firebase/init.json')) {
      event.preventDefault();
      return false;
    }
  }, true);

  let currentUser = null;
  let userEmail = '';
  let resendTimer = 60; // 60 seconds cooldown
  let resendInterval = null;
  
  // Get return URL from URL parameters (defaults to index.html)
  function getReturnUrl() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('return') || 'index.html';
  }
  
  // Function to create Firestore user document after verification
  async function createUserDocument(user) {
    try {
      // CRITICAL: Verify email is actually verified before creating document
      // Reload user to get the absolute latest verification status
      try {
        await user.reload();
        console.log('User reloaded before document creation - emailVerified:', user.emailVerified);
      } catch (reloadError) {
        console.warn('Could not reload user before document creation:', reloadError);
        // Continue but be extra cautious
      }
      
      // Check verification status - must be verified
      if (!user.emailVerified) {
        const errorMsg = 'Cannot create user document: Email is not verified. emailVerified status: ' + user.emailVerified;
        console.error('‚ùå', errorMsg);
        throw new Error(errorMsg);
      }
      
      // Additional safety check: Verify account is not brand new
      // This prevents false positives where Firebase might show verified before email is actually verified
      // For .edu domains, use stricter threshold (15 seconds) due to delayed email delivery
      const isEduDomain = user.email?.toLowerCase().endsWith('.edu');
      const userCreatedTime = user.metadata.creationTime ? new Date(user.metadata.creationTime).getTime() : 0;
      const now = Date.now();
      const timeSinceCreation = now - userCreatedTime;
      const threshold = isEduDomain ? 15000 : 10000; // 15 seconds for .edu, 10 seconds for others
      const isRecentlyCreated = timeSinceCreation < threshold;
      
      if (isRecentlyCreated) {
        const errorMsg = `Cannot create user document: Account is too new (${Math.round(timeSinceCreation / 1000)}s old, required: ${threshold / 1000}s). Email verification may be a false positive.${isEduDomain ? ' Using stricter threshold for .edu domain.' : ''}`;
        console.error('‚ùå', errorMsg);
        throw new Error(errorMsg);
      }
      
      console.log(`‚úì Account age check passed: ${Math.round(timeSinceCreation / 1000)}s old (threshold: ${threshold / 1000}s)${isEduDomain ? ' [.edu domain - stricter check]' : ''}`);
      
      console.log('‚úì Verification checks passed:', {
        emailVerified: user.emailVerified,
        accountAgeSeconds: Math.round(timeSinceCreation / 1000),
        email: user.email
      });
      
      // Check if document already exists
      const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', user.uid);
      const userDoc = await window.firebaseFirestoreFunctions.getDoc(userDocRef);
      
      if (userDoc.exists()) {
        console.log('User document already exists, skipping creation');
        // Verify the existing document was created after verification
        const existingData = userDoc.data();
        if (!existingData.verifiedAt) {
          console.warn('‚ö†Ô∏è Existing document missing verifiedAt timestamp - this should not happen');
        }
        return;
      }
      
      // Generate unique account number
      async function generateUniqueAccountNumber() {
        const maxRetries = 10;
        let attempts = 0;
        
        while (attempts < maxRetries) {
          const accountNumber = Math.floor(100000000 + Math.random() * 900000000);
          
          try {
            const usersRef = window.firebaseFirestoreFunctions.collection(window.firebaseDb, 'users');
            const q = window.firebaseFirestoreFunctions.query(
              usersRef,
              window.firebaseFirestoreFunctions.where('accountNumber', '==', accountNumber)
            );
            const querySnapshot = await window.firebaseFirestoreFunctions.getDocs(q);
            
            if (querySnapshot.empty) {
              console.log('Generated unique account number:', accountNumber);
              return accountNumber;
            } else {
              attempts++;
            }
          } catch (error) {
            console.error('Error checking account number uniqueness:', error);
            return accountNumber;
          }
        }
        
        const fallbackNumber = Math.floor(Date.now() % 900000000) + 100000000;
        console.warn('Could not generate unique account number after', maxRetries, 'attempts. Using fallback:', fallbackNumber);
        return fallbackNumber;
      }
      
      const accountNumber = await generateUniqueAccountNumber();
      
      // Get username from Firestore (most reliable) or localStorage (fallback) or email prefix (last resort)
      let username = null;
      
      console.log('üîç Starting username retrieval for user:', user.uid);
      console.log('üîç Checking localStorage for pendingUsername:', localStorage.getItem('pendingUsername'));
      
      // First, try to get username from Firestore (persists across devices/browsers)
      try {
        const pendingUsernameRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'pendingUsernames', user.uid);
        console.log('üîç Checking Firestore pendingUsernames collection for UID:', user.uid);
        const pendingUsernameDoc = await window.firebaseFirestoreFunctions.getDoc(pendingUsernameRef);
        console.log('üîç Pending username document exists:', pendingUsernameDoc.exists());
        if (pendingUsernameDoc.exists()) {
          const pendingData = pendingUsernameDoc.data();
          console.log('üîç Pending username document data:', pendingData);
          username = pendingData.username;
          console.log('‚úì Username retrieved from Firestore:', username);
          // Delete the pending username document after retrieving it
          await window.firebaseFirestoreFunctions.deleteDoc(pendingUsernameRef);
          console.log('‚úì Pending username document deleted');
        } else {
          console.warn('‚ö†Ô∏è Pending username document does not exist in Firestore');
        }
      } catch (firestoreError) {
        console.error('‚ùå Error retrieving username from Firestore:', firestoreError);
        console.error('‚ùå Error details:', firestoreError.message, firestoreError.code);
        // Continue to try localStorage fallback
      }
      
      // If not found in Firestore, try localStorage (fallback)
      if (!username) {
        const storedUsername = localStorage.getItem('pendingUsername');
        console.log('üîç Checking localStorage for pendingUsername:', storedUsername);
        if (storedUsername) {
          username = storedUsername;
          localStorage.removeItem('pendingUsername'); // Clean up after use
          console.log('‚úì Username retrieved from localStorage:', username);
        } else {
          console.warn('‚ö†Ô∏è No username found in localStorage either');
        }
      }
      
      // If we found a username, validate it's still available
      if (username) {
        // Double-check username is still available (race condition protection)
        const usersRef = window.firebaseFirestoreFunctions.collection(window.firebaseDb, 'users');
        const usernameQuery = window.firebaseFirestoreFunctions.query(
          usersRef,
          window.firebaseFirestoreFunctions.where('username', '==', username)
        );
        const usernameSnapshot = await window.firebaseFirestoreFunctions.getDocs(usernameQuery);
        
        if (!usernameSnapshot.empty) {
          // Username was taken between signup and verification
          // Throw error to prevent document creation and force user to pick new username
          throw new Error('This username is already taken. Please contact support or sign up again with a different username.');
        }
      } else {
        // Fallback to email prefix if no username was stored anywhere
        username = user.email?.split('@')[0] || 'User';
        console.warn('‚ö†Ô∏è No username found in Firestore or localStorage, using email prefix:', username);
        console.warn('‚ö†Ô∏è This means the username was not properly stored during signup or was cleared');
        console.warn('‚ö†Ô∏è User will need to update their username manually on the account details page');
      }
      
      console.log('‚úì Final username to be stored in Firestore:', username);
      
      // Create user document in Firestore
      await window.firebaseFirestoreFunctions.setDoc(userDocRef, {
        email: user.email || '',
        username: username,
        accountNumber: accountNumber,
        gamesPlayed: 0,
        gamesWon: 0,
        currentStreak: 0,
        maxStreak: 0,
        points: 0,
        emailSubscribed: true, // Auto-subscribe new users to reminder emails (can opt out in settings)
        createdAt: window.firebaseFirestoreFunctions.serverTimestamp(),
        verifiedAt: window.firebaseFirestoreFunctions.serverTimestamp()
      });
      
      console.log('‚úì User Firestore document created successfully with account number:', accountNumber);
    } catch (error) {
      console.error('Error creating Firestore document:', error);
      // If it's a username error, re-throw it so it can be handled by the caller
      if (error.message && error.message.includes('username')) {
        throw error;
      }
      // For other errors, don't throw - verification is still successful even if Firestore creation fails
    }
  }

  // Immediately try to set email display from localStorage or URL params (before Firebase loads)
  function setEmailDisplayImmediately() {
    const emailDisplayEl = document.getElementById('emailDisplay');
    if (!emailDisplayEl) {
      console.warn('emailDisplay element not found yet, will retry');
      return false;
    }
    
    if (emailDisplayEl.textContent === 'Loading...') {
      const urlParams = new URLSearchParams(window.location.search);
      const emailParam = urlParams.get('email');
      const returnUrl = urlParams.get('return') || 'index.html'; // Get return URL or default to index.html
      const storedEmail = localStorage.getItem('pendingVerificationEmail');
      const hashParams = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : null;
      const hashEmail = hashParams ? hashParams.get('email') : null;
      const emailToShow = emailParam || storedEmail || hashEmail;
      
      console.log('üîç Checking email sources - URL param:', emailParam, 'localStorage:', storedEmail, 'hash:', hashEmail);
      
      if (emailToShow) {
        emailDisplayEl.textContent = emailToShow;
        console.log('‚úì Email display set immediately from localStorage/URL:', emailToShow);
        return true;
      } else {
        console.warn('‚ö†Ô∏è No email found in URL params, localStorage, or hash');
      }
    } else {
      console.log('Email already set to:', emailDisplayEl.textContent);
    }
    return false;
  }
  
  // Try immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setEmailDisplayImmediately);
  } else {
    setEmailDisplayImmediately();
  }
  
  // Also try after a short delay to catch any timing issues
  setTimeout(setEmailDisplayImmediately, 100);
  setTimeout(setEmailDisplayImmediately, 300);

  // Wait for Firebase to load
  const checkFirebase = setInterval(() => {
    if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions && window.firebaseDb) {
      clearInterval(checkFirebase);
      
      // Immediately check for current user and set email display
      const immediateUser = window.firebaseAuth.currentUser;
      if (immediateUser && immediateUser.email) {
        currentUser = immediateUser;
        userEmail = immediateUser.email;
        document.getElementById('emailDisplay').textContent = userEmail;
        // Show verification status immediately
        updateVerificationStatusDisplay(immediateUser);
        console.log('Immediate email display set:', userEmail);
      } else {
        // Check for email in localStorage or URL params as fallback
        const urlParams = new URLSearchParams(window.location.search);
        const emailParam = urlParams.get('email');
        const storedEmail = localStorage.getItem('pendingVerificationEmail');
        const emailToShow = emailParam || storedEmail;
        if (emailToShow) {
          document.getElementById('emailDisplay').textContent = emailToShow;
          console.log('Using email from URL or localStorage:', emailToShow);
        } else {
          // If no email found, try to get it from any available source
          // Check if there's an email in the URL hash (Firebase sometimes puts it there)
          const hashParams = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : null;
          const hashEmail = hashParams ? hashParams.get('email') : null;
          if (hashEmail) {
            document.getElementById('emailDisplay').textContent = hashEmail;
            console.log('Using email from URL hash:', hashEmail);
          }
        }
      }
      
      // Also set up a timeout to check again if email is still "Loading..."
      setTimeout(() => {
        const emailDisplayEl = document.getElementById('emailDisplay');
        if (emailDisplayEl && emailDisplayEl.textContent === 'Loading...') {
          // Try all sources again
          const urlParams = new URLSearchParams(window.location.search);
          const emailParam = urlParams.get('email');
          const storedEmail = localStorage.getItem('pendingVerificationEmail');
          const hashParams = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : null;
          const hashEmail = hashParams ? hashParams.get('email') : null;
          const currentUserEmail = window.firebaseAuth.currentUser?.email;
          
          const emailToShow = currentUserEmail || emailParam || storedEmail || hashEmail;
          if (emailToShow) {
            emailDisplayEl.textContent = emailToShow;
            console.log('Email display updated after timeout:', emailToShow);
          }
        }
      }, 500);
      
      // Function to update verification status display (only show when verified)
      function updateVerificationStatusDisplay(user) {
        const statusEl = document.getElementById('verificationStatus');
        if (!statusEl || !user) return;
        
        if (user.emailVerified) {
          statusEl.textContent = '‚úì Email verified';
          statusEl.className = 'verification-status verified';
          statusEl.style.display = 'block';
        } else {
          // Don't show "not verified" status - keep it hidden
          statusEl.style.display = 'none';
        }
      }
      
      // Set up listener for auth state changes
      window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
          currentUser = user;
          userEmail = user.email || '';
          
          // Set email display immediately
          if (userEmail) {
            document.getElementById('emailDisplay').textContent = userEmail;
            console.log('Email display set to:', userEmail);
            // Store in localStorage as backup
            localStorage.setItem('pendingVerificationEmail', userEmail);
          } else {
            // If user email is empty, try to get from other sources
            const urlParams = new URLSearchParams(window.location.search);
            const emailParam = urlParams.get('email');
            const storedEmail = localStorage.getItem('pendingVerificationEmail');
            const hashParams = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : null;
            const hashEmail = hashParams ? hashParams.get('email') : null;
            const emailToShow = emailParam || storedEmail || hashEmail;
            
            if (emailToShow) {
              document.getElementById('emailDisplay').textContent = emailToShow;
              console.log('Using fallback email source:', emailToShow);
            } else {
              console.warn('User email is empty and no fallback found, showing Loading...');
              document.getElementById('emailDisplay').textContent = 'Loading...';
            }
          }
          
          // Update verification status display
          updateVerificationStatusDisplay(user);
          
          console.log('Verification page loaded for user:', userEmail);
          console.log('Email verified status (initial):', user.emailVerified);
          console.log('User creation time:', user.metadata.creationTime);
          console.log('Last sign-in time:', user.metadata.lastSignInTime);
          
          // Always reload user data to get the latest verification status (don't trust cached value)
          try {
            await user.reload();
            // Update email after reload in case it changed
            if (user.email) {
              userEmail = user.email;
              document.getElementById('emailDisplay').textContent = userEmail;
              console.log('Email display updated after reload to:', userEmail);
            }
            // Update verification status after reload
            updateVerificationStatusDisplay(user);
            console.log('Email verified status (after reload):', user.emailVerified);
            console.log('User metadata:', {
              creationTime: user.metadata.creationTime,
              lastSignInTime: user.metadata.lastSignInTime,
              lastRefreshTime: user.metadata.lastRefreshTime,
              email: user.email,
              isEduDomain: user.email?.toLowerCase().endsWith('.edu')
            });
          } catch (reloadError) {
            console.warn('Could not reload user data:', reloadError);
            // Continue with cached value if reload fails
          }
          
          // Check if already verified (this happens when Firebase redirects after verification)
          // IMPORTANT: Only trust emailVerified if user was created more than 10 seconds ago
          // This prevents false positives from cached/incorrect verification status
          // ESPECIALLY important for .edu emails which may have delayed verification
          const userCreatedTime = user.metadata.creationTime ? new Date(user.metadata.creationTime).getTime() : 0;
          const now = Date.now();
          const timeSinceCreation = now - userCreatedTime;
          const isRecentlyCreated = timeSinceCreation < 10000; // Less than 10 seconds old
          const isEduDomain = user.email?.toLowerCase().endsWith('.edu');
          
          console.log('User account age check:', {
            created: new Date(userCreatedTime).toISOString(),
            now: new Date(now).toISOString(),
            ageSeconds: Math.round(timeSinceCreation / 1000),
            isRecentlyCreated: isRecentlyCreated,
            isEduDomain: isEduDomain,
            emailVerified: user.emailVerified
          });
          
          // For .edu domains, be extra strict - require at least 15 seconds
          const eduStrictThreshold = isEduDomain ? 15000 : 10000;
          const isTooNew = timeSinceCreation < eduStrictThreshold;
          
          if (isEduDomain && isTooNew) {
            console.warn('‚ö†Ô∏è .edu email account is too new - requiring verification regardless of status');
            console.warn(`   Account age: ${Math.round(timeSinceCreation / 1000)}s, required: ${eduStrictThreshold / 1000}s`);
          }
          
          // CRITICAL: Also check if verification link was actually clicked
          // This prevents auto-verification for .edu emails
          const verificationClickedKey = `verificationLinkClicked_${user.uid}`;
          const verificationClickedTimestamp = localStorage.getItem(verificationClickedKey);
          const emailSentKey = `verificationEmailSent_${user.uid}`;
          const emailSentTimestamp = localStorage.getItem(emailSentKey);
          
          // For .edu domains, require that verification email was sent AND link was clicked
          let canTrustVerification = true;
          if (isEduDomain) {
            if (!emailSentTimestamp) {
              console.warn('‚ö†Ô∏è .edu email: No verification email sent timestamp found - treating as unverified');
              canTrustVerification = false;
            } else if (!verificationClickedTimestamp) {
              console.warn('‚ö†Ô∏è .edu email: Verification email was sent but link was not clicked - treating as unverified');
              canTrustVerification = false;
            } else {
              const emailSentTime = parseInt(emailSentTimestamp);
              const clickedTime = parseInt(verificationClickedTimestamp);
              if (clickedTime < emailSentTime) {
                console.warn('‚ö†Ô∏è .edu email: Verification clicked before email was sent - this is suspicious');
                canTrustVerification = false;
              } else {
                console.log(`‚úì .edu email: Verification link was clicked ${Math.round((clickedTime - emailSentTime) / 1000)}s after email was sent`);
              }
            }
          }
          
          if (user.emailVerified && !isTooNew && canTrustVerification) {
            // Additional check for .edu: require that verification link was clicked
            if (isEduDomain && (!verificationClickedTimestamp || !emailSentTimestamp)) {
              console.warn('‚ö†Ô∏è .edu email: Email shows as verified but verification link was not clicked - blocking access');
              // Don't allow access - treat as unverified
            } else {
              // Only trust verification if account is not brand new (more than 10 seconds old)
              // This prevents false positives where Firebase might show verified before email is actually verified
              console.log('‚úì User email is already verified (account is not brand new)');
              // Create Firestore document if it doesn't exist
              try {
                await createUserDocument(user);
                document.getElementById('successMessage').textContent = 'Your email has been verified! Redirecting...';
                document.getElementById('successMessage').classList.add('show');
                setTimeout(() => {
                  window.location.href = getReturnUrl();
                }, 2000);
                return;
              } catch (docError) {
                // If username error, show it to user
                if (docError.message && docError.message.includes('username')) {
                  document.getElementById('errorMessage').textContent = docError.message;
                  document.getElementById('errorMessage').classList.add('show');
                  return;
                }
                // For other errors, continue (don't block verification)
                console.error('Error creating user document:', docError);
                // Still show success and redirect even if document creation failed (for non-username errors)
                document.getElementById('successMessage').textContent = 'Your email has been verified! Redirecting...';
                document.getElementById('successMessage').classList.add('show');
                setTimeout(() => {
                  window.location.href = getReturnUrl();
                }, 2000);
                return;
              }
            }
          } else if (user.emailVerified && isTooNew) {
            // Account is brand new but shows as verified - this is suspicious
            // Force a fresh reload and don't trust the verification status
            console.warn('‚ö†Ô∏è Account is brand new but shows as verified - this may be a false positive');
            console.warn(`   Account age: ${Math.round(timeSinceCreation / 1000)}s, required: ${eduStrictThreshold / 1000}s`);
            console.warn('   Forcing verification check - user must verify email');
            // Don't create document or redirect - treat as unverified
          }
          
          // If not verified, check if we should auto-send verification email
          // Only send if:
          // 1. User is not verified
          // 2. We haven't sent an email recently (within last 5 minutes)
          // 3. User didn't just arrive from clicking a verification link (check URL params)
          const urlParams = new URLSearchParams(window.location.search);
          const urlHash = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : null;
          const hasActionCode = urlParams.get('oobCode') || (urlHash ? urlHash.get('oobCode') : null);
          const hasMode = urlParams.get('mode') || (urlHash ? urlHash.get('mode') : null);
          
          // Check localStorage for last email send time
          const lastEmailSendKey = `lastVerificationEmail_${user.uid}`;
          const lastEmailSendTime = localStorage.getItem(lastEmailSendKey);
          const currentTime = Date.now();
          const fiveMinutesAgo = currentTime - (5 * 60 * 1000); // 5 minutes in milliseconds
          const shouldAutoSend = !hasActionCode && !hasMode && (!lastEmailSendTime || parseInt(lastEmailSendTime) < fiveMinutesAgo);
          
          if (shouldAutoSend) {
            console.log('Email not verified. Attempting to send verification email...');
            try {
              // Build the correct URL for GitHub Pages (same logic as signup.html)
              const currentPath = window.location.pathname;
              const pathParts = currentPath.split('/').filter(p => p);
              
              // Remove the current filename (e.g., verify-email.html)
              if (pathParts.length > 0) {
                pathParts[pathParts.length - 1] = 'verify-email.html';
              } else {
                pathParts.push('verify-email.html');
              }
              
              const continueUrl = window.location.origin + '/' + pathParts.join('/');
              console.log('Auto-sending verification email with continueUrl:', continueUrl);
              
              await window.firebaseAuthFunctions.sendEmailVerification(user, {
                url: continueUrl,
                handleCodeInApp: false
              });
              console.log('‚úì Verification email sent from verification page');
              
              // Store the time we sent the email
              localStorage.setItem(lastEmailSendKey, now.toString());
              
              // Clear any previous messages first
              document.getElementById('errorMessage').classList.remove('show');
              document.getElementById('successMessage').textContent = 'Verification email sent! Please check your inbox.';
              document.getElementById('successMessage').classList.add('show');
            } catch (autoSendError) {
              console.error('‚úó Could not auto-send verification email:', autoSendError);
              console.error('Error code:', autoSendError.code);
              console.error('Error message:', autoSendError.message);
              
              // Don't show error during auto-send - silently handle rate limiting
              if (autoSendError.code === 'auth/too-many-requests') {
                // Store a longer cooldown time (10 minutes) when rate limited
                localStorage.setItem(lastEmailSendKey, (now + (10 * 60 * 1000)).toString());
                // Don't display error - user can manually resend if needed
              }
              // Don't show error for other cases on auto-send - user can manually resend if needed
            }
          } else {
            if (hasActionCode || hasMode) {
              console.log('Skipping auto-send: User arrived from verification link');
            } else if (lastEmailSendTime) {
              const timeSinceLastSend = now - parseInt(lastEmailSendTime);
              const minutesSinceLastSend = Math.round(timeSinceLastSend / 60000);
              console.log(`Skipping auto-send: Email sent ${minutesSinceLastSend} minute(s) ago (cooldown: 5 minutes)`);
              // Show a helpful message if email was recently sent
              if (timeSinceLastSend < (5 * 60 * 1000)) {
                document.getElementById('successMessage').textContent = `Verification email was sent ${minutesSinceLastSend} minute(s) ago. Please check your inbox (including spam folder).`;
                document.getElementById('successMessage').classList.add('show');
              }
            }
          }
          
          // Check for email verification link in URL (Firebase adds actionCode and oobCode)
          // Reuse urlParams from earlier in the function scope, or create new if needed
          const verificationUrlParams = new URLSearchParams(window.location.search);
          const verificationUrlHash = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : null;
          
          // Check both URL search params and hash for Firebase action codes
          const actionCode = verificationUrlParams.get('oobCode') || (verificationUrlHash ? verificationUrlHash.get('oobCode') : null);
          const mode = verificationUrlParams.get('mode') || (verificationUrlHash ? verificationUrlHash.get('mode') : null);
          const apiKey = verificationUrlParams.get('apiKey') || (verificationUrlHash ? verificationUrlHash.get('apiKey') : null);
          
          console.log('URL params:', { actionCode, mode, apiKey, fullUrl: window.location.href });
          
          if (actionCode && (mode === 'verifyEmail' || mode === 'verifyAndChangeEmail')) {
            // User clicked the verification link - apply the action code
            const isEmailChange = mode === 'verifyAndChangeEmail';
            console.log('Processing email verification link...', isEmailChange ? '(email change)' : '(initial verification)');
            
            // Show processing message immediately
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            if (successMessage) {
              successMessage.textContent = '‚úì Verifying your email... Please wait while we process your verification.';
              successMessage.classList.add('show', 'processing');
            }
            if (errorMessage) {
              errorMessage.classList.remove('show');
            }
            
            // Update verification status to show processing
            const statusEl = document.getElementById('verificationStatus');
            if (statusEl) {
              statusEl.textContent = '‚è≥ Verifying...';
              statusEl.className = 'verification-status';
              statusEl.style.color = '#1976d2';
              statusEl.style.display = 'block';
            }
            
            try {
              // Store old email before applying action code
              const oldEmail = user.email;
              console.log('  Old email before verification:', oldEmail);
              console.log('  Action code:', actionCode);
              console.log('  Mode:', mode);
              console.log('  isEmailChange:', isEmailChange);
              
              // For .edu emails only: Verify that verification email was actually sent before allowing verification
              // This prevents auto-verification for .edu emails
              const isEduDomain = user.email?.toLowerCase().endsWith('.edu');
              if (isEduDomain) {
                const emailSentKey = `verificationEmailSent_${user.uid}`;
                const emailSentTimestamp = localStorage.getItem(emailSentKey);
                
                if (!emailSentTimestamp) {
                  console.warn('‚ö†Ô∏è .edu email: Verification email sent timestamp not found - allowing verification but logging warning');
                  // Allow verification but log warning for .edu
                } else {
                  const emailSentTime = parseInt(emailSentTimestamp);
                  const now = Date.now();
                  const timeSinceEmailSent = now - emailSentTime;
                  const minTimeSinceEmailSent = 3000; // 3 seconds for .edu
                  
                  if (timeSinceEmailSent < minTimeSinceEmailSent) {
                    const errorMsg = `Verification attempted too quickly after email was sent (${Math.round(timeSinceEmailSent / 1000)}s, required: ${minTimeSinceEmailSent / 1000}s). This might be auto-verification.`;
                    console.warn('‚ö†Ô∏è', errorMsg);
                    // For .edu, show warning but still allow if it's been at least 1 second
                    if (timeSinceEmailSent < 1000) {
                      document.getElementById('errorMessage').textContent = 'Verification link clicked too quickly. Please wait a moment and try again.';
                      document.getElementById('errorMessage').classList.add('show');
                      return; // Don't apply action code if less than 1 second
                    }
                  }
                  
                  console.log(`‚úì .edu verification email was sent ${Math.round(timeSinceEmailSent / 1000)}s ago - allowing verification`);
                }
              } else {
                // For non-.edu emails, allow verification without time check
                console.log('‚úì Non-.edu email - allowing verification without time check');
              }
              
              // Apply the action code - this will update the email if mode is verifyAndChangeEmail
              console.log('  Applying action code...');
              await window.firebaseAuthFunctions.applyActionCode(window.firebaseAuth, actionCode);
              console.log('  ‚úì Action code applied successfully');
              
              // Mark that verification link was actually clicked
              const verificationClickedKey = `verificationLinkClicked_${user.uid}`;
              localStorage.setItem(verificationClickedKey, Date.now().toString());
              console.log('‚úì Marked verification link as clicked');
              
              // Reload user to get updated verification status and email
              console.log('  Reloading user to get updated email...');
              await user.reload();
              console.log('  ‚úì User reloaded');
              console.log('  Email after reload:', user.email);
              
              // Check if email actually changed (compare with what we had before)
              const emailChanged = user.email && oldEmail && user.email !== oldEmail;
              console.log('  Email changed?', emailChanged);
              console.log('  Old email:', oldEmail);
              console.log('  New email:', user.email);
              
              if (isEmailChange || emailChanged) {
                console.log('‚úì Email changed and verified successfully!');
                console.log('  Old email:', currentUser.email);
                console.log('  New email:', user.email);
                console.log('  Mode was:', mode);
                console.log('  isEmailChange flag:', isEmailChange);
                console.log('  emailChanged detected:', emailChanged);
                
                document.getElementById('successMessage').textContent = 'Your email has been changed and verified successfully! Redirecting...';
                document.getElementById('successMessage').classList.add('show');
                
                // Update Firestore if document exists
                if (window.firebaseDb && window.firebaseFirestoreFunctions) {
                  try {
                    const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', user.uid);
                    console.log('  Updating Firestore document with new email:', user.email);
                    await window.firebaseFirestoreFunctions.updateDoc(userDocRef, {
                      email: user.email
                    });
                    console.log('‚úì Firestore email updated successfully');
                    
                    // Verify the update worked
                    const updatedDoc = await window.firebaseFirestoreFunctions.getDoc(userDocRef);
                    if (updatedDoc.exists()) {
                      const data = updatedDoc.data();
                      console.log('  Verified Firestore update - email in document:', data.email);
                    }
                  } catch (firestoreError) {
                    console.error('‚úó Could not update email in Firestore:', firestoreError);
                    console.error('  Error code:', firestoreError.code);
                    console.error('  Error message:', firestoreError.message);
                    // Show error to user
                    document.getElementById('errorMessage').textContent = 'Email was changed in Firebase Authentication, but there was an error updating it in the database. Your email change is still valid.';
                    document.getElementById('errorMessage').classList.add('show');
                  }
                } else {
                  console.warn('‚ö†Ô∏è Firestore functions not available - cannot update email in database');
                }
              } else if (user.emailVerified) {
                console.log('‚úì Email verified successfully!');
                updateVerificationStatusDisplay(user);
                
                // Create Firestore document if it doesn't exist
                try {
                  await createUserDocument(user);
                  console.log('‚úì User document created after verification');
                } catch (docError) {
                  console.error('Error creating user document after verification:', docError);
                  // Continue even if document creation fails (for non-username errors)
                  if (docError.message && docError.message.includes('username')) {
                    document.getElementById('errorMessage').textContent = docError.message;
                    document.getElementById('errorMessage').classList.add('show');
                    return;
                  }
                }
                
                // Update success message to show completion
                const successMessage = document.getElementById('successMessage');
                if (successMessage) {
                  successMessage.textContent = '‚úì Email verified successfully! Redirecting you to the home page...';
                  successMessage.classList.remove('processing');
                }
                
                // Redirect immediately after successful verification
                setTimeout(() => {
                  window.location.href = isEmailChange ? 'account-details.html' : getReturnUrl();
                }, 1500);
                return; // Exit early since verification is complete
              } else {
                // If email didn't change and not verified, something went wrong
                if (isEmailChange && !emailChanged) {
                  console.error('‚úó Email change verification failed - email did not change');
                  console.error('  Expected email to change but it did not');
                  console.error('  Old email:', oldEmail);
                  console.error('  Current email:', user.email);
                  document.getElementById('errorMessage').textContent = 'Email change verification failed. The email did not change. Please try changing your email again from the account settings page.';
                  document.getElementById('errorMessage').classList.add('show');
                  return; // Don't redirect
                }
                console.warn('Email verification applied but user.emailVerified is still false');
                // Still redirect even if status shows false (might be a timing issue)
                setTimeout(() => {
                  window.location.href = isEmailChange ? 'account-details.html' : getReturnUrl();
                }, 2000);
              }
            } catch (linkError) {
              console.error('Error verifying email link:', linkError);
              console.error('Error code:', linkError.code);
              console.error('Error message:', linkError.message);
              
              // Check if user is already verified (link was already used or expired, but email is verified)
              try {
                await user.reload();
                if (user.emailVerified) {
                  console.log('‚úì Link error occurred, but user is already verified - showing success');
                  // User is already verified, so show success message instead of error
                  document.getElementById('errorMessage').classList.remove('show');
                  document.getElementById('successMessage').textContent = 'Your email is already verified! Redirecting...';
                  document.getElementById('successMessage').classList.add('show');
                  
                  // Create Firestore document if it doesn't exist
                  try {
                    await createUserDocument(user);
                  } catch (docError) {
                    console.error('Error creating user document after verification:', docError);
                    // Continue even if document creation fails
                  }
                  
                  setTimeout(() => {
                    window.location.href = getReturnUrl();
                  }, 2000);
                  return; // Exit early since user is verified
                }
              } catch (reloadError) {
                console.error('Error reloading user after link error:', reloadError);
                // Continue to show error message
              }
              
              // If user is not verified, show error message
              document.getElementById('errorMessage').textContent = 'Invalid or expired verification link. Please request a new verification email.';
              document.getElementById('errorMessage').classList.add('show');
            }
          } else {
            // Check if we arrived from Firebase redirect (even without explicit params)
            // Firebase might have already processed the verification
            const referrer = document.referrer;
            if (referrer && referrer.includes('firebaseapp.com/__/auth/action')) {
              console.log('Arrived from Firebase auth handler, checking verification status...');
              await user.reload();
              
              // Additional safety check: Verify account is not brand new
              const userCreatedTime = user.metadata.creationTime ? new Date(user.metadata.creationTime).getTime() : 0;
              const now = Date.now();
              const timeSinceCreation = now - userCreatedTime;
              const isRecentlyCreated = timeSinceCreation < 5000;
              
              if (user.emailVerified && !isRecentlyCreated) {
                // Create Firestore document now that email is verified
                try {
                  await createUserDocument(user);
                  document.getElementById('successMessage').textContent = 'Email verified successfully! Redirecting...';
                  document.getElementById('successMessage').classList.add('show');
                  setTimeout(() => {
                    window.location.href = getReturnUrl();
                  }, 2000);
                  return;
                } catch (docError) {
                  // If username error, show it to user
                  if (docError.message && docError.message.includes('username')) {
                    document.getElementById('errorMessage').textContent = docError.message;
                    document.getElementById('errorMessage').classList.add('show');
                    return;
                  }
                  // If verification error, show it to user
                  if (docError.message && (docError.message.includes('not verified') || docError.message.includes('too new'))) {
                    console.error('‚ùå Document creation blocked:', docError.message);
                    document.getElementById('errorMessage').textContent = 'Email verification is required before creating your account. Please verify your email first.';
                    document.getElementById('errorMessage').classList.add('show');
                    return;
                  }
                  // For other errors, continue (don't block verification)
                  console.error('Error creating user document:', docError);
                }
              } else if (user.emailVerified && isTooNew) {
                console.warn(`‚ö†Ô∏è Account is brand new but shows as verified - treating as unverified`);
                console.warn(`   Account age: ${Math.round(timeSinceCreation / 1000)}s, required: ${eduStrictThreshold / 1000}s${isEduDomain ? ' [.edu domain - stricter check]' : ''}`);
                // Don't create document - user must wait for actual verification
              }
            }
          }
          
          // Periodically check if email is verified (in case user verifies in another tab)
          // Only start this check if email is NOT verified
          if (!user.emailVerified) {
            const checkInterval = setInterval(async () => {
              if (currentUser) {
                try {
                  await currentUser.reload();
                  console.log('Periodic check - emailVerified:', currentUser.emailVerified);
                  
                  // Additional safety check: Verify account is not brand new
                  // For .edu domains, use stricter threshold (15 seconds) due to delayed email delivery
                  const isEduDomain = currentUser.email?.toLowerCase().endsWith('.edu');
                  const userCreatedTime = currentUser.metadata.creationTime ? new Date(currentUser.metadata.creationTime).getTime() : 0;
                  const now = Date.now();
                  const timeSinceCreation = now - userCreatedTime;
                  const eduStrictThreshold = isEduDomain ? 15000 : 10000;
                  const isTooNew = timeSinceCreation < eduStrictThreshold;
                  
                  if (currentUser.emailVerified && !isTooNew) {
                    clearInterval(checkInterval);
                    console.log('‚úì Email verified detected in periodic check (account is not brand new)');
                    updateVerificationStatusDisplay(currentUser);
                    document.getElementById('errorMessage').classList.remove('show');
                    
                    // Create Firestore document now that email is verified
                    try {
                      await createUserDocument(currentUser);
                      document.getElementById('successMessage').textContent = 'Email verified successfully! Redirecting...';
                      document.getElementById('successMessage').classList.add('show');
                      setTimeout(() => {
                        window.location.href = 'index.html';
                      }, 2000);
                    } catch (docError) {
                      // If username error, show it to user
                      if (docError.message && docError.message.includes('username')) {
                        document.getElementById('errorMessage').textContent = docError.message;
                        document.getElementById('errorMessage').classList.add('show');
                        return;
                      }
                      // If verification error, show it to user
                      if (docError.message && (docError.message.includes('not verified') || docError.message.includes('too new'))) {
                        console.error('‚ùå Document creation blocked in periodic check:', docError.message);
                        document.getElementById('errorMessage').textContent = 'Email verification is required before creating your account. Please verify your email first.';
                        document.getElementById('errorMessage').classList.add('show');
                        return;
                      }
                      // For other errors, still show success but log error
                      console.error('Error creating user document in periodic check:', docError);
                      document.getElementById('successMessage').textContent = 'Email verified successfully! Redirecting...';
                      document.getElementById('successMessage').classList.add('show');
                      setTimeout(() => {
                        window.location.href = 'index.html';
                      }, 2000);
                    }
                  } else if (currentUser.emailVerified && isTooNew) {
                    console.warn(`‚ö†Ô∏è Periodic check: Account is brand new but shows as verified - waiting for actual verification`);
                    console.warn(`   Account age: ${Math.round(timeSinceCreation / 1000)}s, required: ${eduStrictThreshold / 1000}s${isEduDomain ? ' [.edu domain - stricter check]' : ''}`);
                    // Don't create document yet - keep checking
                  }
                } catch (reloadError) {
                  console.error('Error in periodic verification check:', reloadError);
                  // Don't clear interval on error, keep checking
                }
              } else {
                // User logged out, stop checking
                clearInterval(checkInterval);
              }
            }, 3000); // Check every 3 seconds
            
            // Store interval to clear it later
            window.verificationCheckInterval = checkInterval;
            
            // Clean up interval when page unloads
            window.addEventListener('beforeunload', () => {
              if (window.verificationCheckInterval) {
                clearInterval(window.verificationCheckInterval);
              }
            });
          }
          
          // Store interval to clear it later
          window.verificationCheckInterval = checkInterval;
          
          // Clean up interval when page unloads
          window.addEventListener('beforeunload', () => {
            if (window.verificationCheckInterval) {
              clearInterval(window.verificationCheckInterval);
            }
          });
        } else {
          // User is not logged in - check for stored email before redirecting
          const storedEmail = localStorage.getItem('pendingVerificationEmail');
          if (storedEmail) {
            document.getElementById('emailDisplay').textContent = storedEmail;
            console.log('User not logged in, using stored email from localStorage:', storedEmail);
          } else {
            document.getElementById('emailDisplay').textContent = 'Email address not available';
          }
          // Redirect to login after a brief delay to show email if available
          setTimeout(() => {
            window.location.href = 'login.html?return=' + encodeURIComponent('verify-email.html');
          }, 1000);
        }
      });
      
      // Wait for Firebase to restore the session
      setTimeout(() => {
        if (!window.firebaseAuth.currentUser) {
          window.location.href = 'login.html?return=' + encodeURIComponent('verify-email.html');
        }
      }, 1500);
    }
  }, 100);

  // Wait for DOM to be ready before attaching event listeners
  function setupButtonHandlers() {
    // Handle "Back to homepage" link - log out first
    const backLink = document.getElementById('backToHomepageLink');
    if (backLink) {
      backLink.addEventListener('click', async function(e) {
        e.preventDefault(); // Prevent default navigation
        
        // Log out the user first
        if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseAuthFunctions.signOut) {
          try {
            await window.firebaseAuthFunctions.signOut(window.firebaseAuth);
            console.log('Logged out, redirecting to homepage');
          } catch (error) {
            console.error('Error logging out:', error);
            // Continue with redirect even if logout fails
          }
        }
        
        // Redirect to homepage (user will appear as not logged in)
        window.location.href = getReturnUrl();
      });
    }
    
    // Handle resend verification email
    const resendButton = document.getElementById('resendButton');
    if (resendButton) {
      resendButton.addEventListener('click', async function() {
    if (!currentUser) {
      document.getElementById('errorMessage').textContent = 'You must be logged in to resend verification email.';
      document.getElementById('errorMessage').classList.add('show');
      return;
    }
    
    // Check if user is already verified
    try {
      await currentUser.reload();
      if (currentUser.emailVerified) {
        document.getElementById('successMessage').textContent = 'Your email is already verified! Redirecting...';
        document.getElementById('successMessage').classList.add('show');
        setTimeout(() => {
          window.location.href = getReturnUrl();
        }, 2000);
        return;
      }
    } catch (reloadError) {
      console.error('Error checking verification status:', reloadError);
    }
    
    // Check cooldown period (5 minutes)
    const lastEmailSendKey = `lastVerificationEmail_${currentUser.uid}`;
    const lastEmailSendTime = localStorage.getItem(lastEmailSendKey);
    const now = Date.now();
    const fiveMinutesAgo = now - (5 * 60 * 1000);
    
    if (lastEmailSendTime && parseInt(lastEmailSendTime) > fiveMinutesAgo) {
      const timeSinceLastSend = now - parseInt(lastEmailSendTime);
      const minutesSinceLastSend = Math.round(timeSinceLastSend / 60000);
      const minutesRemaining = 5 - minutesSinceLastSend;
      
      const errorMessage = document.getElementById('errorMessage');
      errorMessage.textContent = `Please wait ${minutesRemaining} more minute(s) before requesting another verification email. Check your inbox (including spam folder) for the previous email.`;
      errorMessage.classList.add('show');
      return;
    }
    
    const resendButton = this;
    const resendTimerEl = document.getElementById('resendTimer');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    // Clear previous messages
    errorMessage.classList.remove('show');
    successMessage.classList.remove('show');
    
    // Disable button
    resendButton.disabled = true;
    resendButton.textContent = 'Sending...';
    
    try {
      // Build the correct URL for GitHub Pages (same logic as signup.html)
      const currentPath = window.location.pathname;
      const pathParts = currentPath.split('/').filter(p => p);
      
      // Set continueUrl to verify-email.html so it can process the verification code
      // After processing, it will redirect to index.html
      if (pathParts.length > 0) {
        pathParts[pathParts.length - 1] = 'verify-email.html';
      } else {
        pathParts.push('verify-email.html');
      }
      
      const continueUrl = window.location.origin + '/' + pathParts.join('/');
      console.log('Resending verification email with continueUrl:', continueUrl);
      
      // Send verification email using Firebase Auth
      await window.firebaseAuthFunctions.sendEmailVerification(currentUser, {
        url: continueUrl,
        handleCodeInApp: false
      });
      
      // Store the time we sent the email
      const emailSendTime = Date.now();
      localStorage.setItem(lastEmailSendKey, emailSendTime.toString());
      
      // CRITICAL: Also store verification email sent timestamp (for .edu domain checks)
      const emailSentKey = `verificationEmailSent_${currentUser.uid}`;
      localStorage.setItem(emailSentKey, now.toString());
      console.log('‚úì Stored verification email sent timestamp:', now);
      
      successMessage.textContent = 'Verification email sent! Please check your inbox.';
      successMessage.classList.add('show');
      
      // Start cooldown timer (60 seconds)
      resendTimer = 60;
      resendTimerEl.textContent = `Resend email in ${resendTimer} seconds`;
      
      if (resendInterval) {
        clearInterval(resendInterval);
      }
      
      resendInterval = setInterval(() => {
        resendTimer--;
        resendTimerEl.textContent = `Resend email in ${resendTimer} seconds`;
        
        if (resendTimer <= 0) {
          clearInterval(resendInterval);
          resendTimerEl.textContent = '';
          resendButton.disabled = false;
          resendButton.textContent = 'Resend verification email';
        }
      }, 1000);
      
    } catch (error) {
      console.error('Resend error:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      
      const now = Date.now();
      
      // Show specific error messages
      let errorMsg = 'Failed to send verification email. ';
      if (error.code === 'auth/too-many-requests') {
        // Store a longer cooldown time (10 minutes) when rate limited
        localStorage.setItem(lastEmailSendKey, (now + (10 * 60 * 1000)).toString());
        errorMsg = 'Too many verification emails sent recently. Firebase has temporarily blocked sending more emails to prevent abuse. Please wait 5-10 minutes before trying again. You can also check your inbox (including spam folder) for previous verification emails.';
      } else if (error.code === 'auth/user-not-found') {
        errorMsg = 'User account not found. Please try logging in again.';
      } else if (error.code === 'auth/requires-recent-login') {
        errorMsg = 'For security, please log out and log back in, then try again.';
      } else if (error.message) {
        errorMsg = 'Failed to send verification email: ' + error.message;
      } else {
        errorMsg += 'Please try again.';
      }
      
      errorMessage.textContent = errorMsg;
      errorMessage.classList.add('show');
      resendButton.disabled = false;
      resendButton.textContent = 'Resend verification email';
    }
      });
    }
  }
  
  // Set up button handlers when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', setupButtonHandlers);
  } else {
    setupButtonHandlers();
  }
</script>

</body>
</html>
