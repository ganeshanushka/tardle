<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verify Email - Tardle</title>
<style>
  body {
    font-family: 'PT Serif', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    background-color: #7BAFD4;
  }

  .verify-container {
    background-color: white;
    margin: auto;
    padding: 40px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 500px;
    max-width: 90%;
    text-align: center;
  }

  h1 {
    font-size: 32px;
    margin-bottom: 10px;
    color: #1a1a1a;
  }

  .subtitle {
    font-size: 16px;
    color: #666;
    margin-bottom: 30px;
  }

  .email-display {
    font-weight: bold;
    color: #001A57;
    margin-bottom: 30px;
  }

  .instructions {
    margin-bottom: 30px;
    color: #666;
    line-height: 1.6;
  }

  .instructions p {
    margin: 10px 0;
  }

  .note {
    font-size: 14px;
    color: #999;
    font-style: italic;
  }

  .error-message {
    color: #d32f2f;
    font-size: 14px;
    margin-top: 10px;
    min-height: 20px;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .success-message {
    color: #2e7d32;
    font-size: 14px;
    margin-top: 10px;
    min-height: 20px;
    display: none;
  }

  .success-message.show {
    display: block;
  }


  .resend-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }

  .resend-button {
    background-color: #7BAFD4;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'PT Serif', sans-serif;
    width: 100%;
    transition: background-color 0.2s ease;
  }

  .resend-button:hover {
    background-color: #6a9fc0;
  }

  .resend-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .resend-timer {
    color: #666;
    font-size: 14px;
    margin-top: 10px;
  }

  .back-link-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }

  .back-link {
    color: #7BAFD4;
    text-decoration: none;
    font-size: 14px;
  }

  .back-link:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<div class="verify-container">
  <h1>Verify your email</h1>
  <p class="subtitle">We've sent a verification email to</p>
  <div class="email-display" id="emailDisplay">Loading...</div>
  
  <div class="instructions">
    <p>Please check your inbox and click the verification link in the email we sent you.</p>
    <p class="note">If you don't see the email, check your spam folder.</p>
  </div>
  
  <div class="error-message" id="errorMessage"></div>
  <div class="success-message" id="successMessage"></div>
  
  <div class="resend-section">
    <button type="button" class="resend-button" id="resendButton">Resend verification email</button>
    <div class="resend-timer" id="resendTimer"></div>
  </div>
  
  <div class="back-link-section">
    <a href="index.html" class="back-link" id="backToHomepageLink">← Back to homepage</a>
  </div>
</div>

<!-- Firebase Config -->
<script type="module" src="firebase-config.js"></script>

<script>
  // Suppress 404 errors for Firebase hosting files that don't exist on GitHub Pages
  // These errors are harmless and don't affect functionality
  const originalError = console.error;
  console.error = function(...args) {
    const message = args.join(' ');
    if (message.includes('__/firebase/init.json') && message.includes('404')) {
      // Silently ignore this specific error - it's expected on GitHub Pages
      return;
    }
    originalError.apply(console, args);
  };
  
  window.addEventListener('error', (event) => {
    if (event.target && event.target.src && event.target.src.includes('__/firebase/init.json')) {
      event.preventDefault();
      return false;
    }
  }, true);

  let currentUser = null;
  let userEmail = '';
  let resendTimer = 60; // 60 seconds cooldown
  let resendInterval = null;
  
  // Function to create Firestore user document after verification
  async function createUserDocument(user) {
    try {
      // Check if document already exists
      const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', user.uid);
      const userDoc = await window.firebaseFirestoreFunctions.getDoc(userDocRef);
      
      if (userDoc.exists()) {
        console.log('User document already exists, skipping creation');
        return;
      }
      
      // Generate unique account number
      async function generateUniqueAccountNumber() {
        const maxRetries = 10;
        let attempts = 0;
        
        while (attempts < maxRetries) {
          const accountNumber = Math.floor(100000000 + Math.random() * 900000000);
          
          try {
            const usersRef = window.firebaseFirestoreFunctions.collection(window.firebaseDb, 'users');
            const q = window.firebaseFirestoreFunctions.query(
              usersRef,
              window.firebaseFirestoreFunctions.where('accountNumber', '==', accountNumber)
            );
            const querySnapshot = await window.firebaseFirestoreFunctions.getDocs(q);
            
            if (querySnapshot.empty) {
              console.log('Generated unique account number:', accountNumber);
              return accountNumber;
            } else {
              attempts++;
            }
          } catch (error) {
            console.error('Error checking account number uniqueness:', error);
            return accountNumber;
          }
        }
        
        const fallbackNumber = Math.floor(Date.now() % 900000000) + 100000000;
        console.warn('Could not generate unique account number after', maxRetries, 'attempts. Using fallback:', fallbackNumber);
        return fallbackNumber;
      }
      
      const accountNumber = await generateUniqueAccountNumber();
      const username = user.email?.split('@')[0] || 'User';
      
      // Create user document in Firestore
      await window.firebaseFirestoreFunctions.setDoc(userDocRef, {
        email: user.email || '',
        username: username,
        accountNumber: accountNumber,
        gamesPlayed: 0,
        currentStreak: 0,
        maxStreak: 0,
        emailSubscribed: false,
        createdAt: window.firebaseFirestoreFunctions.serverTimestamp(),
        verifiedAt: window.firebaseFirestoreFunctions.serverTimestamp()
      });
      
      console.log('✓ User Firestore document created successfully with account number:', accountNumber);
    } catch (error) {
      console.error('Error creating Firestore document:', error);
      // Don't throw - verification is still successful even if Firestore creation fails
    }
  }

  // Wait for Firebase to load
  const checkFirebase = setInterval(() => {
    if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions && window.firebaseDb) {
      clearInterval(checkFirebase);
      
      // Set up listener for auth state changes
      window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
          currentUser = user;
          userEmail = user.email || '';
          document.getElementById('emailDisplay').textContent = userEmail;
          
          console.log('Verification page loaded for user:', userEmail);
          console.log('Email verified status (initial):', user.emailVerified);
          console.log('User creation time:', user.metadata.creationTime);
          console.log('Last sign-in time:', user.metadata.lastSignInTime);
          
          // Always reload user data to get the latest verification status (don't trust cached value)
          try {
            await user.reload();
            console.log('Email verified status (after reload):', user.emailVerified);
          } catch (reloadError) {
            console.warn('Could not reload user data:', reloadError);
            // Continue with cached value if reload fails
          }
          
          // Check if already verified (this happens when Firebase redirects after verification)
          if (user.emailVerified) {
            console.log('✓ User email is already verified');
            // Create Firestore document if it doesn't exist
            await createUserDocument(user);
            document.getElementById('successMessage').textContent = 'Your email has been verified! Redirecting...';
            document.getElementById('successMessage').classList.add('show');
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
            return;
          }
          
          // If not verified, try sending verification email automatically
          console.log('Email not verified. Attempting to send verification email...');
          try {
            // Build the correct URL for GitHub Pages (same logic as signup.html)
            const currentPath = window.location.pathname;
            const pathParts = currentPath.split('/').filter(p => p);
            
            // Remove the current filename (e.g., verify-email.html)
            if (pathParts.length > 0) {
              pathParts[pathParts.length - 1] = 'verify-email.html';
            } else {
              pathParts.push('verify-email.html');
            }
            
            const continueUrl = window.location.origin + '/' + pathParts.join('/');
            console.log('Auto-sending verification email with continueUrl:', continueUrl);
            
            await window.firebaseAuthFunctions.sendEmailVerification(user, {
              url: continueUrl,
              handleCodeInApp: false
            });
            console.log('✓ Verification email sent from verification page');
            // Clear any previous messages first
            document.getElementById('errorMessage').classList.remove('show');
            document.getElementById('successMessage').textContent = 'Verification email sent! Please check your inbox.';
            document.getElementById('successMessage').classList.add('show');
          } catch (autoSendError) {
            console.error('✗ Could not auto-send verification email:', autoSendError);
            console.error('Error code:', autoSendError.code);
            console.error('Error message:', autoSendError.message);
            
            // Show helpful message for rate limiting
            if (autoSendError.code === 'auth/too-many-requests') {
              document.getElementById('errorMessage').textContent = 'Too many verification emails sent recently. Please wait 5-10 minutes before trying again, or check your inbox (including spam folder) for previous verification emails.';
              document.getElementById('errorMessage').classList.add('show');
            }
            // Don't show error for other cases on auto-send - user can manually resend if needed
          }
          
          // Check for email verification link in URL (Firebase adds actionCode and oobCode)
          const urlParams = new URLSearchParams(window.location.search);
          const urlHash = window.location.hash ? new URLSearchParams(window.location.hash.substring(1)) : null;
          
          // Check both URL search params and hash for Firebase action codes
          const actionCode = urlParams.get('oobCode') || (urlHash ? urlHash.get('oobCode') : null);
          const mode = urlParams.get('mode') || (urlHash ? urlHash.get('mode') : null);
          const apiKey = urlParams.get('apiKey') || (urlHash ? urlHash.get('apiKey') : null);
          
          console.log('URL params:', { actionCode, mode, apiKey, fullUrl: window.location.href });
          
          if (actionCode && (mode === 'verifyEmail' || mode === 'verifyAndChangeEmail')) {
            // User clicked the verification link - apply the action code
            const isEmailChange = mode === 'verifyAndChangeEmail';
            console.log('Processing email verification link...', isEmailChange ? '(email change)' : '(initial verification)');
            try {
              // Store old email before applying action code
              const oldEmail = user.email;
              console.log('  Old email before verification:', oldEmail);
              
              await window.firebaseAuthFunctions.applyActionCode(window.firebaseAuth, actionCode);
              // Reload user to get updated verification status and email
              await user.reload();
              
              // Check if email actually changed (compare with what we had before)
              const emailChanged = user.email && oldEmail && user.email !== oldEmail;
              
              if (isEmailChange || emailChanged) {
                console.log('✓ Email changed and verified successfully!');
                console.log('  Old email:', currentUser.email);
                console.log('  New email:', user.email);
                console.log('  Mode was:', mode);
                console.log('  isEmailChange flag:', isEmailChange);
                console.log('  emailChanged detected:', emailChanged);
                
                document.getElementById('successMessage').textContent = 'Your email has been changed and verified successfully! Redirecting...';
                document.getElementById('successMessage').classList.add('show');
                
                // Update Firestore if document exists
                if (window.firebaseDb && window.firebaseFirestoreFunctions) {
                  try {
                    const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', user.uid);
                    console.log('  Updating Firestore document with new email:', user.email);
                    await window.firebaseFirestoreFunctions.updateDoc(userDocRef, {
                      email: user.email
                    });
                    console.log('✓ Firestore email updated successfully');
                    
                    // Verify the update worked
                    const updatedDoc = await window.firebaseFirestoreFunctions.getDoc(userDocRef);
                    if (updatedDoc.exists()) {
                      const data = updatedDoc.data();
                      console.log('  Verified Firestore update - email in document:', data.email);
                    }
                  } catch (firestoreError) {
                    console.error('✗ Could not update email in Firestore:', firestoreError);
                    console.error('  Error code:', firestoreError.code);
                    console.error('  Error message:', firestoreError.message);
                    // Show error to user
                    document.getElementById('errorMessage').textContent = 'Email was changed in Firebase Authentication, but there was an error updating it in the database. Your email change is still valid.';
                    document.getElementById('errorMessage').classList.add('show');
                  }
                } else {
                  console.warn('⚠️ Firestore functions not available - cannot update email in database');
                }
              } else if (user.emailVerified) {
                console.log('✓ Email verified successfully!');
                document.getElementById('successMessage').textContent = 'Email verified successfully! Redirecting...';
                document.getElementById('successMessage').classList.add('show');
              } else {
                console.warn('Email verification applied but user.emailVerified is still false');
              }
              
              setTimeout(() => {
                window.location.href = isEmailChange ? 'account-details.html' : 'index.html';
              }, 2000);
            } catch (linkError) {
              console.error('Error verifying email link:', linkError);
              console.error('Error code:', linkError.code);
              console.error('Error message:', linkError.message);
              document.getElementById('errorMessage').textContent = 'Invalid or expired verification link. Please request a new verification email.';
              document.getElementById('errorMessage').classList.add('show');
            }
          } else {
            // Check if we arrived from Firebase redirect (even without explicit params)
            // Firebase might have already processed the verification
            const referrer = document.referrer;
            if (referrer && referrer.includes('firebaseapp.com/__/auth/action')) {
              console.log('Arrived from Firebase auth handler, checking verification status...');
              await user.reload();
              if (user.emailVerified) {
                // Create Firestore document now that email is verified
                await createUserDocument(user);
                document.getElementById('successMessage').textContent = 'Email verified successfully! Redirecting...';
                document.getElementById('successMessage').classList.add('show');
                setTimeout(() => {
                  window.location.href = 'index.html';
                }, 2000);
                return;
              }
            }
          }
          
          // Periodically check if email is verified (in case user verifies in another tab)
          // Only start this check if email is NOT verified
          if (!user.emailVerified) {
            const checkInterval = setInterval(async () => {
              if (currentUser) {
                try {
                  await currentUser.reload();
                  console.log('Periodic check - emailVerified:', currentUser.emailVerified);
                  if (currentUser.emailVerified) {
                    clearInterval(checkInterval);
                    console.log('✓ Email verified detected in periodic check');
                    document.getElementById('errorMessage').classList.remove('show');
                    document.getElementById('successMessage').textContent = 'Email verified successfully! Redirecting...';
                    document.getElementById('successMessage').classList.add('show');
                    setTimeout(() => {
                      window.location.href = 'index.html';
                    }, 2000);
                  }
                } catch (reloadError) {
                  console.error('Error in periodic verification check:', reloadError);
                  // Don't clear interval on error, keep checking
                }
              } else {
                // User logged out, stop checking
                clearInterval(checkInterval);
              }
            }, 3000); // Check every 3 seconds
            
            // Store interval to clear it later
            window.verificationCheckInterval = checkInterval;
            
            // Clean up interval when page unloads
            window.addEventListener('beforeunload', () => {
              if (window.verificationCheckInterval) {
                clearInterval(window.verificationCheckInterval);
              }
            });
          }
          
          // Store interval to clear it later
          window.verificationCheckInterval = checkInterval;
          
          // Clean up interval when page unloads
          window.addEventListener('beforeunload', () => {
            if (window.verificationCheckInterval) {
              clearInterval(window.verificationCheckInterval);
            }
          });
        } else {
          // User is not logged in - redirect to login
          window.location.href = 'login.html?return=' + encodeURIComponent('verify-email.html');
        }
      });
      
      // Wait for Firebase to restore the session
      setTimeout(() => {
        if (!window.firebaseAuth.currentUser) {
          window.location.href = 'login.html?return=' + encodeURIComponent('verify-email.html');
        }
      }, 1500);
    }
  }, 100);

  // Handle "Back to homepage" link - log out first
  document.getElementById('backToHomepageLink').addEventListener('click', async function(e) {
    e.preventDefault(); // Prevent default navigation
    
    // Log out the user first
    if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseAuthFunctions.signOut) {
      try {
        await window.firebaseAuthFunctions.signOut(window.firebaseAuth);
        console.log('Logged out, redirecting to homepage');
      } catch (error) {
        console.error('Error logging out:', error);
        // Continue with redirect even if logout fails
      }
    }
    
    // Redirect to homepage (user will appear as not logged in)
    window.location.href = 'index.html';
  });
  
  // Handle resend verification email
  document.getElementById('resendButton').addEventListener('click', async function() {
    if (!currentUser) {
      document.getElementById('errorMessage').textContent = 'You must be logged in to resend verification email.';
      document.getElementById('errorMessage').classList.add('show');
      return;
    }
    
    const resendButton = this;
    const resendTimerEl = document.getElementById('resendTimer');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    // Clear previous messages
    errorMessage.classList.remove('show');
    successMessage.classList.remove('show');
    
    // Disable button
    resendButton.disabled = true;
    resendButton.textContent = 'Sending...';
    
    try {
      // Build the correct URL for GitHub Pages (same logic as signup.html)
      const currentPath = window.location.pathname;
      const pathParts = currentPath.split('/').filter(p => p);
      
      // Remove the current filename (e.g., verify-email.html)
      if (pathParts.length > 0) {
        pathParts[pathParts.length - 1] = 'verify-email.html';
      } else {
        pathParts.push('verify-email.html');
      }
      
      const continueUrl = window.location.origin + '/' + pathParts.join('/');
      console.log('Resending verification email with continueUrl:', continueUrl);
      
      // Send verification email using Firebase Auth
      await window.firebaseAuthFunctions.sendEmailVerification(currentUser, {
        url: continueUrl,
        handleCodeInApp: false
      });
      
      successMessage.textContent = 'Verification email sent! Please check your inbox.';
      successMessage.classList.add('show');
      
      // Start cooldown timer (60 seconds)
      resendTimer = 60;
      resendTimerEl.textContent = `Resend email in ${resendTimer} seconds`;
      
      if (resendInterval) {
        clearInterval(resendInterval);
      }
      
      resendInterval = setInterval(() => {
        resendTimer--;
        resendTimerEl.textContent = `Resend email in ${resendTimer} seconds`;
        
        if (resendTimer <= 0) {
          clearInterval(resendInterval);
          resendTimerEl.textContent = '';
          resendButton.disabled = false;
          resendButton.textContent = 'Resend verification email';
        }
      }, 1000);
      
    } catch (error) {
      console.error('Resend error:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      
      // Show specific error messages
      let errorMsg = 'Failed to send verification email. ';
      if (error.code === 'auth/too-many-requests') {
        errorMsg = 'Too many verification emails sent recently. Firebase has temporarily blocked sending more emails to prevent abuse. Please wait 5-10 minutes before trying again. You can also check your inbox (including spam folder) for previous verification emails.';
      } else if (error.code === 'auth/user-not-found') {
        errorMsg = 'User account not found. Please try logging in again.';
      } else if (error.code === 'auth/requires-recent-login') {
        errorMsg = 'For security, please log out and log back in, then try again.';
      } else if (error.message) {
        errorMsg = 'Failed to send verification email: ' + error.message;
      } else {
        errorMsg += 'Please try again.';
      }
      
      errorMessage.textContent = errorMsg;
      errorMessage.classList.add('show');
      resendButton.disabled = false;
      resendButton.textContent = 'Resend verification email';
    }
  });
</script>

</body>
</html>
