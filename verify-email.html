<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Verify Email - Tardle</title>
<style>
  body {
    font-family: 'PT Serif', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    background-color: #7BAFD4;
  }

  .verify-container {
    background-color: white;
    margin: auto;
    padding: 40px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    width: 500px;
    max-width: 90%;
    text-align: center;
  }

  h1 {
    font-size: 32px;
    margin-bottom: 10px;
    color: #1a1a1a;
  }

  .subtitle {
    font-size: 16px;
    color: #666;
    margin-bottom: 30px;
  }

  .email-display {
    font-weight: bold;
    color: #001A57;
    margin-bottom: 30px;
  }

  .instructions {
    margin-bottom: 30px;
    color: #666;
    line-height: 1.6;
  }

  .instructions p {
    margin: 10px 0;
  }

  .note {
    font-size: 14px;
    color: #999;
    font-style: italic;
  }

  .error-message {
    color: #d32f2f;
    font-size: 14px;
    margin-top: 10px;
    min-height: 20px;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .success-message {
    color: #2e7d32;
    font-size: 14px;
    margin-top: 10px;
    min-height: 20px;
    display: none;
  }

  .success-message.show {
    display: block;
  }


  .resend-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }

  .resend-button {
    background-color: #7BAFD4;
    color: white;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'PT Serif', sans-serif;
    width: 100%;
    transition: background-color 0.2s ease;
  }

  .resend-button:hover {
    background-color: #6a9fc0;
  }

  .resend-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }

  .resend-timer {
    color: #666;
    font-size: 14px;
    margin-top: 10px;
  }

  .back-link-section {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 1px solid #eee;
  }

  .back-link {
    color: #7BAFD4;
    text-decoration: none;
    font-size: 14px;
  }

  .back-link:hover {
    text-decoration: underline;
  }
</style>
</head>
<body>

<div class="verify-container">
  <h1>Verify your email</h1>
  <p class="subtitle">We've sent a verification email to</p>
  <div class="email-display" id="emailDisplay">Loading...</div>
  
  <div class="instructions">
    <p>Please check your inbox and click the verification link in the email we sent you.</p>
    <p class="note">If you don't see the email, check your spam folder.</p>
  </div>
  
  <div class="error-message" id="errorMessage"></div>
  <div class="success-message" id="successMessage"></div>
  
  <div class="resend-section">
    <button type="button" class="resend-button" id="resendButton">Resend verification email</button>
    <div class="resend-timer" id="resendTimer"></div>
  </div>
  
  <div class="back-link-section">
    <a href="index.html" class="back-link">‚Üê Back to homepage</a>
  </div>
</div>

<!-- Firebase Config -->
<script type="module" src="firebase-config.js"></script>

<script>
  let currentUser = null;
  let userEmail = '';
  let resendTimer = 60; // 60 seconds cooldown
  let resendInterval = null;

  // Wait for Firebase to load
  const checkFirebase = setInterval(() => {
    if (window.firebaseAuth && window.firebaseAuthFunctions && window.firebaseFirestoreFunctions && window.firebaseDb) {
      clearInterval(checkFirebase);
      
      // Set up listener for auth state changes
      window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, async (user) => {
        if (user) {
          currentUser = user;
          userEmail = user.email || '';
          document.getElementById('emailDisplay').textContent = userEmail;
          
          console.log('Verification page loaded for user:', userEmail);
          
          // Check if already verified
          if (user.emailVerified) {
            document.getElementById('successMessage').textContent = 'Your email is already verified! Redirecting...';
            document.getElementById('successMessage').classList.add('show');
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 2000);
            return;
          }
          
          // Check for email verification link in URL (Firebase adds actionCode and oobCode)
          const urlParams = new URLSearchParams(window.location.search);
          const actionCode = urlParams.get('oobCode');
          const mode = urlParams.get('mode');
          
          if (actionCode && mode === 'verifyEmail') {
            // User clicked the verification link - apply the action code
            try {
              await window.firebaseAuthFunctions.applyActionCode(window.firebaseAuth, actionCode);
              // Reload user to get updated verification status
              await user.reload();
              if (user.emailVerified) {
                document.getElementById('successMessage').textContent = 'Email verified successfully! Redirecting...';
                document.getElementById('successMessage').classList.add('show');
                setTimeout(() => {
                  window.location.href = 'index.html';
                }, 2000);
              }
            } catch (linkError) {
              console.error('Error verifying email link:', linkError);
              document.getElementById('errorMessage').textContent = 'Invalid or expired verification link. Please request a new verification email.';
              document.getElementById('errorMessage').classList.add('show');
            }
          }
          
          // Periodically check if email is verified (in case user verifies in another tab)
          const checkInterval = setInterval(async () => {
            if (currentUser) {
              await currentUser.reload();
              if (currentUser.emailVerified) {
                clearInterval(checkInterval);
                document.getElementById('successMessage').textContent = 'Email verified successfully! Redirecting...';
                document.getElementById('successMessage').classList.add('show');
                setTimeout(() => {
                  window.location.href = 'index.html';
                }, 2000);
              }
            }
          }, 3000); // Check every 3 seconds
          
          // Store interval to clear it later
          window.verificationCheckInterval = checkInterval;
          
          // Clean up interval when page unloads
          window.addEventListener('beforeunload', () => {
            if (window.verificationCheckInterval) {
              clearInterval(window.verificationCheckInterval);
            }
          });
        } else {
          // User is not logged in - redirect to login
          window.location.href = 'login.html?return=' + encodeURIComponent('verify-email.html');
        }
      });
      
      // Wait for Firebase to restore the session
      setTimeout(() => {
        if (!window.firebaseAuth.currentUser) {
          window.location.href = 'login.html?return=' + encodeURIComponent('verify-email.html');
        }
      }, 1500);
    }
  }, 100);

  // Handle resend verification email
  document.getElementById('resendButton').addEventListener('click', async function() {
    if (!currentUser) {
      document.getElementById('errorMessage').textContent = 'You must be logged in to resend verification email.';
      document.getElementById('errorMessage').classList.add('show');
      return;
    }
    
    const resendButton = this;
    const resendTimerEl = document.getElementById('resendTimer');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    // Clear previous messages
    errorMessage.classList.remove('show');
    successMessage.classList.remove('show');
    
    // Disable button
    resendButton.disabled = true;
    resendButton.textContent = 'Sending...';
    
    try {
      // Send verification email using Firebase Auth
      await window.firebaseAuthFunctions.sendEmailVerification(currentUser, {
        url: window.location.origin + '/verify-email.html',
        handleCodeInApp: false
      });
      
      successMessage.textContent = 'Verification email sent! Please check your inbox.';
      successMessage.classList.add('show');
      
      // Start cooldown timer (60 seconds)
      resendTimer = 60;
      resendTimerEl.textContent = `Resend email in ${resendTimer} seconds`;
      
      if (resendInterval) {
        clearInterval(resendInterval);
      }
      
      resendInterval = setInterval(() => {
        resendTimer--;
        resendTimerEl.textContent = `Resend email in ${resendTimer} seconds`;
        
        if (resendTimer <= 0) {
          clearInterval(resendInterval);
          resendTimerEl.textContent = '';
          resendButton.disabled = false;
          resendButton.textContent = 'Resend verification email';
        }
      }, 1000);
      
    } catch (error) {
      console.error('Resend error:', error);
      errorMessage.textContent = 'Failed to send verification email. Please try again.';
      errorMessage.classList.add('show');
      resendButton.disabled = false;
      resendButton.textContent = 'Resend verification email';
    }
  });
</script>

</body>
</html>
