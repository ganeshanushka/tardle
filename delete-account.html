<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delete your account</title>
<!-- Firebase Config -->
<script type="module" src="firebase-config.js"></script>
<style>
  body {
    font-family: 'PT Serif', sans-serif;
    background-color: white;
    margin: 0;
    padding: 0;
    color: #1a1a1a;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .container {
    max-width: 600px;
    width: 100%;
    margin: 60px auto;
    padding: 0 20px;
    box-sizing: border-box;
  }

  h1 {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #1a1a1a;
  }

  .header-tile-grid {
    display: flex;
    gap: 3px;
    margin-bottom: 20px;
    perspective: 1000px;
  }

  .header-tile {
    width: 36px;
    height: 36px;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #333333;
    border-radius: 4px;
    font-weight: bold;
    font-size: 1.3em;
    color: #000000;
    font-family: Arial, sans-serif;
    background-color: #ffffff;
    transition: background-color 0s, color 0s, border-color 0s;
  }

  /* Flip animation for header tiles */
  .header-tile.flip {
    animation: headerTileFlip 0.8s ease-in-out;
  }

  @keyframes headerTileFlip {
    0% { transform: rotateX(0); }
    50% { transform: rotateX(-90deg); }
    100% { transform: rotateX(0); }
  }

  /* Initial state: tiles start as white */
  .header-tile.correct,
  .header-tile.present,
  .header-tile.absent {
    background-color: #ffffff;
    color: #000000;
    border-color: #d3d6da;
  }

  /* Revealed state: tiles show their colors */
  .header-tile.correct.revealed {
    background-color: #7BAFD4;
    color: white;
    border-color: transparent;
  }

  .header-tile.present.revealed {
    background-color: #c9b458;
    color: white;
    border-color: transparent;
  }

  .header-tile.absent.revealed {
    background-color: #001A57;
    color: white;
    border-color: transparent;
  }

  .account-info {
    margin-bottom: 30px;
    font-size: 16px;
    line-height: 1.5;
  }

  .account-info strong {
    font-weight: bold;
  }

  .consequences {
    margin-bottom: 30px;
    font-size: 16px;
    line-height: 1.6;
  }

  .consequences p {
    margin-bottom: 15px;
  }

  .warning {
    font-weight: bold;
    color: #1a1a1a;
    margin-top: 20px;
  }

  .section-title {
    font-size: 18px;
    font-weight: bold;
    margin-top: 30px;
    margin-bottom: 15px;
    color: #1a1a1a;
  }

  .section-content {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 30px;
  }

  .checkbox-container {
    margin-bottom: 30px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .checkbox-container input[type="checkbox"] {
    margin-top: 3px;
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .checkbox-container label {
    font-size: 16px;
    line-height: 1.5;
    cursor: pointer;
    color: #1a1a1a;
  }

  .button-container {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }

  .delete-button {
    background-color: #e0e0e0;
    color: #333;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'PT Serif', sans-serif;
    transition: background-color 0.2s ease, color 0.2s ease;
  }

  .delete-button:hover:not(:disabled) {
    background-color: #6a9fc0;
  }

  .delete-button:disabled {
    background-color: #f0f0f0;
    color: #999;
    cursor: not-allowed;
  }

  .delete-button.loading {
    position: relative;
    color: transparent;
  }

  .delete-button.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .delete-button.enabled.loading::after {
    border-color: #ffffff;
    border-top-color: transparent;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .success-screen {
    display: none;
    text-align: left;
    max-width: 600px;
    margin: 0 auto;
  }

  .success-screen.show {
    display: block;
  }

  .success-screen h1 {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
    margin-top: 0;
    color: #1a1a1a;
    font-family: 'PT Serif', sans-serif;
  }

  .success-screen p {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 20px;
    color: #1a1a1a;
    font-family: 'PT Serif', sans-serif;
  }

  .success-screen .email-bold {
    font-weight: bold;
  }

  .delete-form {
    display: block;
  }

  .delete-form.hidden {
    display: none;
  }

  .delete-button.enabled {
    background-color: #7BAFD4;
    color: white;
  }

  .return-link {
    color: #333;
    text-decoration: none;
    font-size: 16px;
    padding: 12px 0;
    display: inline-block;
  }

  .return-link:hover {
    text-decoration: underline;
  }

  .error-message {
    color: #d32f2f;
    font-size: 14px;
    margin-top: 10px;
    display: none;
  }

  .error-message.show {
    display: block;
  }

  .password-prompt {
    margin-top: 20px;
    padding: 15px;
    background-color: #f5f5f5;
    border-left: 4px solid #7BAFD4;
    border-radius: 4px;
  }

  .password-prompt label {
    display: block;
    font-weight: bold;
    margin-bottom: 8px;
    font-size: 16px;
  }

  .password-prompt input {
    width: 100%;
    padding: 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-family: 'PT Serif', sans-serif;
  }

  .password-prompt button {
    margin-top: 10px;
    padding: 10px 20px;
    background-color: #7BAFD4;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    font-family: 'PT Serif', sans-serif;
  }

  .password-prompt button:hover {
    background-color: #6a9fc0;
  }

  .success-message {
    color: #2e7d32;
    font-size: 14px;
    margin-top: 10px;
    display: none;
  }

  .success-message.show {
    display: block;
  }
</style>
</head>
<body>
<div class="container">
  <div class="delete-form" id="deleteForm">
    <div class="header-tile-grid" id="headerTiles"></div>
    
    <div class="account-info">
      Delete the Tardle account for:<br>
      <strong id="userEmail"></strong>
    </div>

    <div class="consequences">
      <p>Are you sure? This is like skipping that 8 am you signed up for—you can, but do you really want to?</p>
    </div>

    <div class="section-title">What to expect</div>
    <div class="section-content">
      <p>After your account has been deleted, you will no longer be able to log in to Tardle using this account. You will also stop receiving any emails to the email address associated with this account.</p>
      <p class="warning">This action is permanent—like that "C" on your transcript you swore wouldn't happen.</p>
    </div>

    <div class="checkbox-container">
      <input type="checkbox" id="confirmCheckbox">
      <label for="confirmCheckbox">I confirm I want to delete my Tardle account.</label>
    </div>

    <div class="error-message" id="errorMessage"></div>
    <div class="success-message" id="successMessage"></div>

    <div class="password-prompt" id="passwordPrompt" style="display: none;">
      <label for="passwordInput">For security, please enter your password to confirm account deletion:</label>
      <input type="password" id="passwordInput" placeholder="Enter your password">
      <button id="confirmPasswordBtn">Confirm and Delete</button>
    </div>

    <div class="button-container">
      <button class="delete-button" id="deleteButton" disabled>Delete account</button>
      <a href="account-details.html" class="return-link">Return to account</a>
    </div>
  </div>

  <div class="success-screen" id="successScreen">
    <h1>Your Tardle account is being deleted.</h1>
    <p>We are deleting the Tardle account for <span class="email-bold" id="successEmail"></span>.</p>
    <p>This action may take a few minutes. You will be logged out immediately and on all other devices.</p>
    <p>No further action is needed. You may close this window.</p>
  </div>
</div>

<script>
  // Create header tiles and animate them
  function initHeaderTiles() {
    const headerTilesContainer = document.getElementById('headerTiles');
    if (!headerTilesContainer) return;

    // Create tiles spelling "DELETE YOUR ACCOUNT"
    const text = "DELETE YOUR ACCOUNT";
    const letters = text.split('');
    const colorClasses = ['correct', 'present', 'absent'];
    
    letters.forEach((letter) => {
      if (letter === ' ') {
        // Add a spacer for spaces
        const spacer = document.createElement('div');
        spacer.style.width = '8px';
        headerTilesContainer.appendChild(spacer);
      } else {
        const tile = document.createElement('div');
        // Randomly assign a color class
        const randomColor = colorClasses[Math.floor(Math.random() * colorClasses.length)];
        tile.className = `header-tile ${randomColor}`;
        tile.textContent = letter; // Show letter from start
        headerTilesContainer.appendChild(tile);
      }
    });

    // Trigger flip animation after a short delay
    setTimeout(() => {
      const tiles = headerTilesContainer.querySelectorAll('.header-tile');
      const flipDelay = 100; // Delay between each flip
      const flipDuration = 800; // Duration of flip animation

      tiles.forEach((tile, index) => {
        setTimeout(() => {
          // Add flip animation
          tile.classList.add('flip');
          
          // Reveal the color at the midpoint of the flip
          setTimeout(() => {
            tile.classList.add('revealed');
          }, flipDuration / 2); // Half of the flip duration (400ms)
          
          // Remove flip class after animation completes
          setTimeout(() => {
            tile.classList.remove('flip');
          }, flipDuration);
        }, index * flipDelay);
      });
    }, 150); // Wait 0.15 seconds after page loads
  }

  // Initialize header tiles when page loads
  document.addEventListener('DOMContentLoaded', initHeaderTiles);

  // Get user email
  let currentUser = null;
  let userEmail = '';

  // Wait for Firebase to load and restore auth state
  let userFound = false;
  let redirectScheduled = false;
  
  const checkFirebase = setInterval(() => {
    if (window.firebaseAuthFunctions && window.firebaseAuth) {
      clearInterval(checkFirebase);
      
      // Set up listener for auth state changes
      window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, (user) => {
        if (user) {
          // User is logged in
          userFound = true;
          currentUser = user;
          userEmail = user.email || '';
          document.getElementById('userEmail').textContent = userEmail;
          
          // Cancel any pending redirect
          if (redirectScheduled) {
            redirectScheduled = false;
          }
        }
      });
      
      // Wait for Firebase to restore the session before checking
      // Give it time to call onAuthStateChanged
      setTimeout(() => {
        // Check one more time if user was found
        if (!userFound && !window.firebaseAuth.currentUser && !redirectScheduled) {
          // No user found after waiting - redirect to login
          redirectScheduled = true;
          window.location.href = 'login.html?return=' + encodeURIComponent('delete-account.html');
        }
      }, 1500); // Wait 1.5 seconds for Firebase to restore session
    }
  }, 100);

  // Enable/disable delete button based on checkbox
  const confirmCheckbox = document.getElementById('confirmCheckbox');
  const deleteButton = document.getElementById('deleteButton');
  
  confirmCheckbox.addEventListener('change', function() {
    if (this.checked) {
      deleteButton.disabled = false;
      deleteButton.classList.add('enabled');
    } else {
      deleteButton.disabled = true;
      deleteButton.classList.remove('enabled');
    }
  });

  // Handle delete account
  deleteButton.addEventListener('click', async function() {
    if (!confirmCheckbox.checked || !currentUser) {
      return;
    }

    // Disable button and show loading state
    deleteButton.disabled = true;
    deleteButton.classList.add('loading');
    deleteButton.textContent = 'Deleting...';
    
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const deleteForm = document.getElementById('deleteForm');
    const successScreen = document.getElementById('successScreen');
    errorMessage.classList.remove('show');
    successMessage.classList.remove('show');

    try {
      console.log('Starting account deletion process...');
      
      // Wait for Firebase functions to be available (with timeout)
      await Promise.race([
        new Promise((resolve) => {
          if (window.firebaseAuthFunctions && window.firebaseFirestoreFunctions && window.firebaseAuth) {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (window.firebaseAuthFunctions && window.firebaseFirestoreFunctions && window.firebaseAuth) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
          }
        }),
        new Promise((_, reject) => setTimeout(() => reject(new Error('Firebase functions timeout')), 10000))
      ]);

      console.log('Firebase functions available, proceeding with deletion...');

      // Refresh currentUser to ensure we have the latest auth state
      currentUser = window.firebaseAuth.currentUser;
      if (!currentUser) {
        throw new Error('User session expired. Please log in again and try again.');
      }

      // Delete user document from Firestore first
      if (currentUser && window.firebaseFirestoreFunctions && window.firebaseDb) {
        try {
          console.log('Deleting user document from Firestore...');
          const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', currentUser.uid);
          await window.firebaseFirestoreFunctions.deleteDoc(userDocRef);
          console.log('User document deleted from Firestore');
        } catch (firestoreError) {
          console.error('Error deleting Firestore document:', firestoreError);
          // Continue with auth deletion even if Firestore deletion fails
        }
      }

      // Delete user from Firebase Auth
      // deleteUser is a method on the User object, not a standalone function
      if (currentUser && currentUser.delete) {
        console.log('Deleting user from Firebase Auth...');
        
        try {
          // Try to delete directly first
          const deletePromise = currentUser.delete();
          const timeoutPromise = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Account deletion timed out.')), 30000)
          );
          
          await Promise.race([deletePromise, timeoutPromise]);
          console.log('User account deleted from Firebase Auth');
          
          // Hide the form and show success screen
          deleteForm.classList.add('hidden');
          successScreen.classList.add('show');
          
          // Set the email in the success screen
          const successEmailEl = document.getElementById('successEmail');
          if (successEmailEl) {
            successEmailEl.textContent = userEmail;
          }
        } catch (deleteError) {
          // If deletion fails due to requires-recent-login, prompt for password
          if (deleteError.code === 'auth/requires-recent-login') {
            console.log('Re-authentication required, prompting for password...');
            // Show password prompt
            const passwordPrompt = document.getElementById('passwordPrompt');
            const passwordInput = document.getElementById('passwordInput');
            const confirmPasswordBtn = document.getElementById('confirmPasswordBtn');
            
            passwordPrompt.style.display = 'block';
            passwordInput.focus();
            
            // Handle password confirmation
            const handlePasswordConfirm = async () => {
              const password = passwordInput.value;
              if (!password) {
                errorMessage.textContent = 'Please enter your password.';
                errorMessage.classList.add('show');
                return;
              }

              try {
                // Re-authenticate user
                const credential = window.firebaseAuthFunctions.EmailAuthProvider.credential(
                  currentUser.email,
                  password
                );
                await window.firebaseAuthFunctions.reauthenticateWithCredential(currentUser, credential);
                console.log('User re-authenticated successfully');

                // Now try to delete again
                await currentUser.delete();
                console.log('User account deleted from Firebase Auth after re-authentication');
                
                // Hide the form and show success screen
                deleteForm.classList.add('hidden');
                passwordPrompt.style.display = 'none';
                successScreen.classList.add('show');
                
                // Set the email in the success screen
                const successEmailEl = document.getElementById('successEmail');
                if (successEmailEl) {
                  successEmailEl.textContent = userEmail;
                }
              } catch (reauthError) {
                console.error('Re-authentication error:', reauthError);
                if (reauthError.code === 'auth/wrong-password') {
                  errorMessage.textContent = 'Incorrect password. Please try again.';
                } else {
                  errorMessage.textContent = reauthError.message || 'Re-authentication failed. Please try again.';
                }
                errorMessage.classList.add('show');
                passwordInput.value = '';
              }
            };

            confirmPasswordBtn.onclick = handlePasswordConfirm;
            passwordInput.onkeypress = (e) => {
              if (e.key === 'Enter') {
                handlePasswordConfirm();
              }
            };

            // Remove loading state but keep button disabled
            deleteButton.classList.remove('loading');
            deleteButton.textContent = 'Delete account';
            return; // Exit early, wait for password confirmation
          } else {
            // Re-throw other errors
            throw deleteError;
          }
        }
      } else {
        throw new Error('Unable to delete account. Please try logging out and logging back in, then try again.');
      }
    } catch (error) {
      console.error('Error deleting account:', error);
      console.error('Error code:', error.code);
      console.error('Error message:', error.message);
      
      let errorMsg = error.message || 'An error occurred while deleting your account. Please try again.';
      
      // Handle specific Firebase errors
      if (error.code === 'auth/requires-recent-login') {
        errorMsg = 'For security reasons, you need to log in again before deleting your account. Please log out and log back in, then try again.';
      } else if (error.message && error.message.includes('timeout')) {
        errorMsg = error.message;
      }
      
      errorMessage.textContent = errorMsg;
      errorMessage.classList.add('show');
      deleteButton.disabled = false;
      deleteButton.classList.remove('loading');
      deleteButton.textContent = 'Delete account';
      deleteButton.classList.remove('enabled');
    }
  });
</script>

</body>
</html>
