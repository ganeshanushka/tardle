<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delete your account</title>
<style>
  body {
    font-family: 'PT Serif', sans-serif;
    background-color: white;
    margin: 0;
    padding: 0;
    color: #1a1a1a;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .container {
    max-width: 600px;
    width: 100%;
    margin: 60px auto;
    padding: 0 20px;
    box-sizing: border-box;
  }

  h1 {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #1a1a1a;
  }

  .header-tile-grid {
    display: flex;
    gap: 3px;
    margin-bottom: 20px;
    perspective: 1000px;
  }

  .header-tile {
    width: 36px;
    height: 36px;
    display: flex;
    justify-content: center;
    align-items: center;
    border: 2px solid #333333;
    border-radius: 4px;
    font-weight: bold;
    font-size: 1.3em;
    color: #000000;
    font-family: Arial, sans-serif;
    background-color: #ffffff;
    transition: background-color 0s, color 0s, border-color 0s;
  }

  /* Flip animation for header tiles */
  .header-tile.flip {
    animation: headerTileFlip 0.8s ease-in-out;
  }

  @keyframes headerTileFlip {
    0% { transform: rotateX(0); }
    50% { transform: rotateX(-90deg); }
    100% { transform: rotateX(0); }
  }

  /* Initial state: tiles start as white */
  .header-tile.correct,
  .header-tile.present,
  .header-tile.absent {
    background-color: #ffffff;
    color: #000000;
    border-color: #d3d6da;
  }

  /* Revealed state: tiles show their colors */
  .header-tile.correct.revealed {
    background-color: #7BAFD4;
    color: white;
    border-color: transparent;
  }

  .header-tile.present.revealed {
    background-color: #c9b458;
    color: white;
    border-color: transparent;
  }

  .header-tile.absent.revealed {
    background-color: #001A57;
    color: white;
    border-color: transparent;
  }

  .account-info {
    margin-bottom: 30px;
    font-size: 16px;
    line-height: 1.5;
  }

  .account-info strong {
    font-weight: bold;
  }

  .consequences {
    margin-bottom: 30px;
    font-size: 16px;
    line-height: 1.6;
  }

  .consequences p {
    margin-bottom: 15px;
  }

  .warning {
    font-weight: bold;
    color: #1a1a1a;
    margin-top: 20px;
  }

  .section-title {
    font-size: 18px;
    font-weight: bold;
    margin-top: 30px;
    margin-bottom: 15px;
    color: #1a1a1a;
  }

  .section-content {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 30px;
  }

  .checkbox-container {
    margin-bottom: 30px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }

  .checkbox-container input[type="checkbox"] {
    margin-top: 3px;
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .checkbox-container label {
    font-size: 16px;
    line-height: 1.5;
    cursor: pointer;
    color: #1a1a1a;
  }

  .button-container {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }

  .delete-button {
    background-color: #e0e0e0;
    color: #333;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'PT Serif', sans-serif;
    transition: background-color 0.2s ease, color 0.2s ease;
    min-width: 150px; /* Maintain button size when loading */
    box-sizing: border-box;
  }

  .delete-button:hover:not(:disabled) {
    background-color: #6a9fc0;
  }

  .delete-button:disabled {
    background-color: #f0f0f0;
    color: #999;
    cursor: not-allowed;
  }

  .delete-button.loading {
    position: relative;
    color: transparent;
    min-width: 150px; /* Maintain button size when loading */
  }

  .delete-button.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  .delete-button.enabled.loading::after {
    border-color: #ffffff;
    border-top-color: transparent;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .success-screen {
    display: none;
    text-align: left;
    max-width: 600px;
    margin: 0 auto;
  }

  .success-screen.show {
    display: block;
  }

  .success-screen h1 {
    font-size: 32px;
    font-weight: bold;
    margin-bottom: 20px;
    margin-top: 0;
    color: #1a1a1a;
    font-family: 'PT Serif', sans-serif;
  }

  .success-screen p {
    font-size: 16px;
    line-height: 1.6;
    margin-bottom: 20px;
    color: #1a1a1a;
    font-family: 'PT Serif', sans-serif;
  }

  .success-screen .email-bold {
    font-weight: bold;
  }

  .delete-form {
    display: block;
  }

  .delete-form.hidden {
    display: none;
  }

  .delete-button.enabled {
    background-color: #7BAFD4;
    color: white;
  }

  .return-link {
    color: #333;
    text-decoration: none;
    font-size: 16px;
    padding: 12px 0;
    display: inline-block;
  }

  .return-link:hover {
    text-decoration: underline;
  }

  .error-message {
    color: red;
    font-size: 0.9rem;
    margin-top: 0.25em;
    margin-bottom: 1em;
    display: none;
    font-family: 'PT Serif', serif;
    font-weight: bold;
  }

  .error-message.show {
    display: block;
  }

  .password-prompt {
    margin-top: 20px;
    padding: 15px;
    background-color: #f5f5f5;
    border-left: 4px solid #7BAFD4;
    border-radius: 4px;
  }

  .password-prompt .error-message {
    margin-top: 0.25em;
    margin-bottom: 1em;
  }

  .password-prompt label {
    display: block;
    font-weight: bold;
    margin-bottom: 8px;
    font-size: 16px;
  }

  .password-prompt .password-wrapper {
    position: relative;
    width: 100%;
  }

  .password-prompt input {
    width: 100%;
    padding: 10px 40px 10px 10px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
    font-family: 'PT Serif', sans-serif;
  }

  .password-prompt .password-toggle {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
  }

  .password-prompt .password-toggle svg {
    width: 20px;
    height: 20px;
    stroke: #666;
  }

  .password-prompt .password-toggle:hover svg {
    stroke: #333;
  }


  .success-message {
    color: #2e7d32;
    font-size: 14px;
    margin-top: 10px;
    display: none;
  }

  .success-message.show {
    display: block;
  }
</style>
</head>
<body>
<div class="container">
  <div class="delete-form" id="deleteForm">
    <div class="header-tile-grid" id="headerTiles"></div>
  
  <div class="account-info">
    Delete the Tardle account for:<br>
    <strong id="userEmail"></strong>
  </div>

  <div class="consequences">
      <p>Are you sure? This is like skipping that 8 am you signed up for—you can, but do you really want to?</p>
  </div>

  <div class="section-title">What to expect</div>
  <div class="section-content">
      <p>After your account has been deleted, you will no longer be able to log in to Tardle using this account. You will also stop receiving any emails to the email address associated with this account.</p>
      <p class="warning">This action is permanent—like that "C" on your transcript you swore wouldn't happen.</p>
  </div>

  <div class="checkbox-container">
    <input type="checkbox" id="confirmCheckbox">
    <label for="confirmCheckbox">I confirm I want to delete my Tardle account.</label>
  </div>

  <div class="success-message" id="successMessage"></div>

    <div class="password-prompt" id="passwordPrompt" style="display: none;">
      <label for="passwordInput">For security reasons, please enter your password to confirm account deletion:</label>
      <div class="password-wrapper">
        <input type="password" id="passwordInput" placeholder="Enter your password">
        <button type="button" class="password-toggle" id="passwordToggle" aria-label="Toggle password visibility">
          <svg id="eyeIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        </button>
      </div>
      <div class="error-message" id="errorMessage"></div>
    </div>

  <div class="button-container">
      <button type="button" class="delete-button" id="deleteButton" disabled>Delete account</button>
      <a href="account-details.html" class="return-link">Return to account</a>
    </div>
  </div>

  <div class="success-screen" id="successScreen">
    <h1>Your Tardle account has been deleted.</h1>
    <p>We have deleted the Tardle account for <span class="email-bold" id="successEmail"></span>.</p>
    <p>You have been logged out immediately and on all other devices.</p>
    <p>No further action is needed. You may close this window and start your transfer to Duke immediately.</p>
  </div>
</div>

<script>
  // Create header tiles and animate them
  function initHeaderTiles() {
    const headerTilesContainer = document.getElementById('headerTiles');
    if (!headerTilesContainer) return;

    // Create tiles spelling "DELETE YOUR ACCOUNT"
    const text = "DELETE YOUR ACCOUNT";
    const letters = text.split('');
    const colorClasses = ['correct', 'present', 'absent'];
    
    letters.forEach((letter) => {
      if (letter === ' ') {
        // Add a spacer for spaces
        const spacer = document.createElement('div');
        spacer.style.width = '8px';
        headerTilesContainer.appendChild(spacer);
      } else {
        const tile = document.createElement('div');
        // Randomly assign a color class
        const randomColor = colorClasses[Math.floor(Math.random() * colorClasses.length)];
        tile.className = `header-tile ${randomColor}`;
        tile.textContent = letter; // Show letter from start
        headerTilesContainer.appendChild(tile);
      }
    });

    // Trigger flip animation after a short delay
    setTimeout(() => {
      const tiles = headerTilesContainer.querySelectorAll('.header-tile');
      const flipDelay = 100; // Delay between each flip
      const flipDuration = 800; // Duration of flip animation

      tiles.forEach((tile, index) => {
        setTimeout(() => {
          // Add flip animation
          tile.classList.add('flip');
          
          // Reveal the color at the midpoint of the flip
          setTimeout(() => {
            tile.classList.add('revealed');
          }, flipDuration / 2); // Half of the flip duration (400ms)
          
          // Remove flip class after animation completes
          setTimeout(() => {
            tile.classList.remove('flip');
          }, flipDuration);
        }, index * flipDelay);
      });
    }, 150); // Wait 0.15 seconds after page loads
  }

  // Initialize header tiles when page loads
  document.addEventListener('DOMContentLoaded', initHeaderTiles);

  // Get user email
  let currentUser = null;
  let userEmail = '';

  // Wait for Firebase to load and restore auth state
  let userFound = false;
  let redirectScheduled = false;
  
  const checkFirebase = setInterval(() => {
    if (window.firebaseAuthFunctions && window.firebaseAuth) {
      clearInterval(checkFirebase);
      
      // Set up listener for auth state changes
      window.firebaseAuthFunctions.onAuthStateChanged(window.firebaseAuth, (user) => {
        if (user) {
          // User is logged in
          userFound = true;
          currentUser = user;
          userEmail = user.email || '';
          const userEmailEl = document.getElementById('userEmail');
          if (userEmailEl) {
            userEmailEl.textContent = userEmail;
          }
          
          // Cancel any pending redirect
          if (redirectScheduled) {
            redirectScheduled = false;
          }
        }
      });
      
      // Wait for Firebase to restore the session before checking
      // Give it time to call onAuthStateChanged
      setTimeout(() => {
        // Check one more time if user was found
        if (!userFound && !window.firebaseAuth.currentUser && !redirectScheduled) {
          // No user found after waiting - redirect to login
          redirectScheduled = true;
          window.location.href = 'login.html?return=' + encodeURIComponent('delete-account.html');
        }
      }, 1500); // Wait 1.5 seconds for Firebase to restore session
    }
  }, 100);

  // Check if Firebase is loaded
  function checkFirebaseLoaded() {
    const hasAuth = !!window.firebaseAuth;
    const hasAuthFunctions = !!window.firebaseAuthFunctions;
    const hasFirestoreFunctions = !!window.firebaseFirestoreFunctions;
    console.log('Firebase check:', {
      firebaseAuth: hasAuth,
      firebaseAuthFunctions: hasAuthFunctions,
      firebaseFirestoreFunctions: hasFirestoreFunctions
    });
    return hasAuth && hasAuthFunctions && hasFirestoreFunctions;
  }

  // Setup delete button and checkbox when DOM is ready
  function setupDeleteButton() {
  const confirmCheckbox = document.getElementById('confirmCheckbox');
  const deleteButton = document.getElementById('deleteButton');
  
    if (!confirmCheckbox || !deleteButton) {
      console.error('Delete button or checkbox not found');
      console.error('Checkbox element:', confirmCheckbox);
      console.error('Delete button element:', deleteButton);
      return;
    }

    console.log('Delete button and checkbox found, setting up event listeners');
    console.log('Firebase loaded:', checkFirebaseLoaded());
    
    // Test if button is clickable
    deleteButton.style.pointerEvents = 'auto';
    deleteButton.style.cursor = 'pointer';
    
    // Enable/disable delete button based on checkbox
    confirmCheckbox.addEventListener('change', function() {
      console.log('Checkbox changed:', this.checked);
      if (this.checked) {
        // Check Firebase before enabling
        if (!checkFirebaseLoaded()) {
          console.warn('Firebase not loaded yet, waiting...');
          const errorMessage = document.getElementById('errorMessage');
          if (errorMessage) {
            errorMessage.textContent = 'Firebase is still loading. Please wait a moment and try again.';
            errorMessage.classList.add('show');
          }
          this.checked = false; // Uncheck the checkbox
          return;
        }
        deleteButton.disabled = false;
        deleteButton.classList.add('enabled');
        console.log('Delete button enabled');
      } else {
    deleteButton.disabled = true;
        deleteButton.classList.remove('enabled');
        console.log('Delete button disabled');
      }
    });
    
    // Also add a test click handler to verify the button works
    deleteButton.addEventListener('click', function(e) {
      console.log('TEST: Button click detected!', e);
    }, { once: true });

    // Setup password visibility toggle
    const passwordInput = document.getElementById('passwordInput');
    const passwordToggle = document.getElementById('passwordToggle');
    const eyeIcon = document.getElementById('eyeIcon');
    
    if (passwordToggle && passwordInput && eyeIcon) {
      passwordToggle.addEventListener('click', function() {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        
        // Update icon based on visibility
        if (type === 'text') {
          // Show eye with slash (hidden)
          eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
        } else {
          // Show normal eye (visible)
          eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
        }
      });
    }

    // Handle password confirmation
    const handlePasswordConfirm = async () => {
      const passwordInput = document.getElementById('passwordInput');
      const passwordPrompt = document.getElementById('passwordPrompt');
      const password = passwordInput.value;
      const errorMessage = document.getElementById('errorMessage');
      const deleteForm = document.getElementById('deleteForm');
      const successScreen = document.getElementById('successScreen');
      
      if (!password) {
        errorMessage.textContent = 'Please enter your password.';
        errorMessage.classList.add('show');
        return;
      }

      // Disable button and show loading state
      deleteButton.disabled = true;
      deleteButton.textContent = ''; // Clear text so only loading spinner shows
      deleteButton.classList.add('loading');
      passwordInput.disabled = true;

      try {
        console.log('Starting account deletion process...');
        console.log('Checking Firebase availability...');
        console.log('window.firebaseAuth:', window.firebaseAuth);
        console.log('window.firebaseAuthFunctions:', window.firebaseAuthFunctions);
        console.log('window.firebaseFirestoreFunctions:', window.firebaseFirestoreFunctions);
        
        // Wait for Firebase functions to be available (with timeout)
        let firebaseReady = false;
        const maxWaitTime = 15000; // Increased to 15 seconds
        const checkInterval = 100;
        const startTime = Date.now();
        
        while (!firebaseReady && (Date.now() - startTime) < maxWaitTime) {
            if (window.firebaseAuthFunctions && window.firebaseFirestoreFunctions && window.firebaseAuth) {
            firebaseReady = true;
            console.log('Firebase functions are available!');
            break;
          }
          await new Promise(resolve => setTimeout(resolve, checkInterval));
        }
        
        if (!firebaseReady) {
          console.error('Firebase functions timeout after', maxWaitTime, 'ms');
          console.error('window.firebaseAuth:', window.firebaseAuth);
          console.error('window.firebaseAuthFunctions:', window.firebaseAuthFunctions);
          console.error('window.firebaseFirestoreFunctions:', window.firebaseFirestoreFunctions);
          throw new Error('Firebase functions failed to load. Please refresh the page and try again.');
        }

        console.log('Firebase functions available, proceeding with deletion...');

        // Re-authenticate user first with password - this MUST succeed before deletion
        // This is a security requirement - we MUST verify the password before allowing deletion
        let reauthSuccessful = false;
        try {
          console.log('Attempting to re-authenticate with password...');
          const credential = window.firebaseAuthFunctions.EmailAuthProvider.credential(
            currentUser.email,
            password
          );
          
          // Re-authenticate - this will throw an error if password is wrong
          await window.firebaseAuthFunctions.reauthenticateWithCredential(currentUser, credential);
          reauthSuccessful = true;
          console.log('User re-authenticated successfully - password verified');
        } catch (reauthError) {
          console.error('Re-authentication FAILED:', reauthError);
          console.error('Re-auth error code:', reauthError.code);
          console.error('Re-auth error message:', reauthError.message);
          
          // ANY re-authentication error means password is wrong or invalid
          // Stop deletion immediately - do NOT proceed
          errorMessage.textContent = 'Wrong password. Try again.';
          errorMessage.classList.add('show');
          deleteButton.disabled = false;
          deleteButton.classList.remove('loading');
          deleteButton.textContent = 'Confirm and delete';
          passwordInput.disabled = false;
          passwordInput.value = ''; // Clear password field
          passwordInput.focus();
          
          // CRITICAL: Return early to prevent any deletion
          return;
        }
        
        // Double-check that re-authentication actually succeeded
        if (!reauthSuccessful) {
          console.error('Re-authentication did not succeed - stopping deletion');
          errorMessage.textContent = 'Password verification failed. Please try again.';
          errorMessage.classList.add('show');
          deleteButton.disabled = false;
          deleteButton.classList.remove('loading');
          deleteButton.textContent = 'Confirm and delete';
          passwordInput.disabled = false;
          passwordInput.value = '';
          passwordInput.focus();
          return;
        }

        // Refresh currentUser after re-authentication
        currentUser = window.firebaseAuth.currentUser;
        if (!currentUser) {
          throw new Error('User session expired. Please log in again and try again.');
        }

        // Delete user document from Firestore first (with timeout)
        // Note: We continue with Auth deletion even if Firestore deletion fails or is cancelled
      if (currentUser && window.firebaseFirestoreFunctions && window.firebaseDb) {
        try {
            console.log('Deleting user document from Firestore...');
          const userDocRef = window.firebaseFirestoreFunctions.doc(window.firebaseDb, 'users', currentUser.uid);
            
            // Add timeout to Firestore deletion (5 seconds)
            // Use Promise.race but catch all errors including cancellations
            const firestoreDeletePromise = window.firebaseFirestoreFunctions.deleteDoc(userDocRef).catch(err => {
              // Suppress cancellation errors - they're expected when timing out
              const errorCode = err?.code || '';
              const errorMessage = err?.message || '';
              if (errorCode === 'cancelled' || errorMessage.includes('cancelled') || errorMessage.includes('Operation cancelled')) {
                console.warn('Firestore deletion cancelled (expected with timeout, continuing):', err);
                throw new Error('FIRESTORE_CANCELLED'); // Re-throw as a simple error we can identify
              }
              throw err; // Re-throw other errors
            });
            
            const firestoreTimeoutPromise = new Promise((_, reject) => 
              setTimeout(() => reject(new Error('FIRESTORE_TIMEOUT')), 5000)
            );
            
            try {
              await Promise.race([firestoreDeletePromise, firestoreTimeoutPromise]);
          console.log('User document deleted from Firestore');
        } catch (firestoreError) {
              // Handle all Firestore errors - we continue regardless
              const errorMessage = firestoreError?.message || '';
              
              if (errorMessage === 'FIRESTORE_CANCELLED' || errorMessage === 'FIRESTORE_TIMEOUT') {
                console.warn('Firestore deletion timed out or was cancelled (this is OK, continuing with Auth deletion)');
              } else {
                console.warn('Firestore deletion encountered an error (this is OK, continuing with Auth deletion):', firestoreError);
              }
              // Continue with auth deletion even if Firestore deletion fails
            }
          } catch (firestoreError) {
            // Catch any outer errors - we continue regardless
            console.warn('Firestore deletion encountered an error (this is OK, continuing with Auth deletion):', firestoreError);
          // Continue with auth deletion even if Firestore deletion fails
        }
        } else {
          console.log('Skipping Firestore deletion (not available or user not found)');
      }

      // Delete user from Firebase Auth
      // deleteUser is a method on the User object, not a standalone function
      if (currentUser && currentUser.delete) {
          console.log('Deleting user from Firebase Auth...');
          
          try {
            // Try to delete directly first
            const deletePromise = currentUser.delete();
            const timeoutPromise = new Promise((_, reject) => 
              setTimeout(() => reject(new Error('Account deletion timed out.')), 30000)
            );
            
            await Promise.race([deletePromise, timeoutPromise]);
        console.log('User account deleted from Firebase Auth');
        
            // Hide the form and show success screen
            deleteForm.classList.add('hidden');
            passwordPrompt.style.display = 'none';
            successScreen.classList.add('show');
            
            // Set the email in the success screen
            const successEmailEl = document.getElementById('successEmail');
            if (successEmailEl) {
              successEmailEl.textContent = userEmail;
            }
          } catch (deleteError) {
            // Re-throw the error to be handled in outer catch
            throw deleteError;
          }
      } else {
        throw new Error('Unable to delete account. Please try logging out and logging back in, then try again.');
      }
    } catch (error) {
      console.error('Error deleting account:', error);
          console.error('Error code:', error.code);
          console.error('Error message:', error.message);
          console.error('Error name:', error.name);
          
          let errorMsg = error.message || 'An error occurred while deleting your account. Please try again.';
          
          // Handle specific Firebase errors
          if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
            errorMsg = 'Wrong password. Try again.';
            // Clear password field on wrong password
            passwordInput.value = '';
            passwordInput.focus();
          } else if (error.code === 'cancelled' || error.message?.includes('cancelled') || error.message?.includes('FIRESTORE') || error.name === 'FirebaseError') {
            // If it's a cancellation error from Firestore, we should have already continued with Auth deletion
            // But if we're here, it means something went wrong - try Auth deletion as fallback
            console.log('Detected cancellation/Firestore error in outer catch, attempting Auth deletion as fallback...');
            if (currentUser && currentUser.delete) {
              try {
                await currentUser.delete();
                console.log('User account deleted from Firebase Auth (fallback after Firestore cancellation)');
                deleteForm.classList.add('hidden');
                passwordPrompt.style.display = 'none';
                successScreen.classList.add('show');
                const successEmailEl = document.getElementById('successEmail');
                if (successEmailEl) {
                  successEmailEl.textContent = userEmail;
                }
                return; // Success, exit early
              } catch (authError) {
                console.error('Auth deletion also failed:', authError);
                errorMsg = 'Account deletion encountered an error. The Firestore data may not have been deleted, but we attempted to delete your authentication account. Please contact support if you need assistance.';
              }
            } else {
              errorMsg = 'The deletion operation encountered an error. Please try again or contact support.';
            }
          } else if (error.message && error.message.includes('timeout')) {
            errorMsg = error.message;
          }
          
          errorMessage.textContent = errorMsg;
      errorMessage.classList.add('show');
      deleteButton.disabled = false;
          deleteButton.classList.remove('loading');
          deleteButton.textContent = 'Confirm and delete'; // Restore text since password prompt is still visible
          passwordInput.disabled = false;
          passwordInput.value = ''; // Clear password field
          deleteButton.classList.remove('enabled');
          // Don't reset checkbox - keep it checked
        }
      };

    // Handle delete account button click
    deleteButton.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('Delete button clicked');
      console.log('Checkbox checked:', confirmCheckbox.checked);
      console.log('Current user:', currentUser);
      
      if (!confirmCheckbox.checked) {
        console.log('Checkbox not checked, returning');
        return;
    }
      
      if (!currentUser) {
        console.log('No current user, refreshing...');
        // Try to refresh currentUser
        currentUser = window.firebaseAuth ? window.firebaseAuth.currentUser : null;
        if (!currentUser) {
          console.error('No user found. Please log in again.');
          const errorMessage = document.getElementById('errorMessage');
          if (errorMessage) {
            errorMessage.textContent = 'You must be logged in to delete your account. Please log in and try again.';
            errorMessage.classList.add('show');
          }
          return;
        }
      }

      const passwordPrompt = document.getElementById('passwordPrompt');
      const passwordInput = document.getElementById('passwordInput');
      const errorMessage = document.getElementById('errorMessage');
      const successMessage = document.getElementById('successMessage');
      
      // Check if password prompt is already visible (check both inline style and computed style)
      const isPromptVisible = passwordPrompt.style.display === 'block' || 
                              window.getComputedStyle(passwordPrompt).display === 'block';
      
      if (isPromptVisible && passwordInput.value) {
        // Password prompt is visible and password is entered, handle password confirmation
        handlePasswordConfirm();
        return;
      }

      // Show password prompt and update button text
      errorMessage.classList.remove('show');
      successMessage.classList.remove('show');
      passwordPrompt.style.display = 'block';
      // Change button text immediately
      deleteButton.textContent = 'Confirm and delete';
      deleteButton.disabled = false; // Enable button so user can click it
      passwordInput.value = ''; // Clear any previous password
      passwordInput.focus();
      
      // Set up Enter key handler for password input
      passwordInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          handlePasswordConfirm();
        }
      };
    });
  }

  // Initialize delete button setup when DOM is ready
  function initDeleteButton() {
    console.log('Initializing delete button setup, DOM ready state:', document.readyState);
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded fired, setting up delete button');
        setupDeleteButton();
      });
    } else {
      // DOM is already ready
      console.log('DOM already ready, setting up delete button immediately');
      setupDeleteButton();
    }
  }
  
  initDeleteButton();
</script>

<!-- Firebase Config - Load at end of body to ensure DOM is ready -->
<script type="module" src="firebase-config.js"></script>

</body>
</html>
